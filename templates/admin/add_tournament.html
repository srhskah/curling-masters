{% extends 'layout.html' %}

{% block content %}
<div class="form-container">
  <h2>ğŸ† æ·»åŠ å•å±Šæ¯”èµ›ï¼ˆå±Šæ¬¡ï¼‰</h2>
  
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="flash-messages">
        {% for message in messages %}
          <div class="flash-message flash-success">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
  
  <form method="post" novalidate>
    <div class="form-group">
      <label for="season_id">ğŸ“… èµ›å­£</label>
      <select id="season_id" name="season_id" required>
        {% for s in seasons %}
          <option value="{{ s.season_id }}" {% if pre_season_id and s.season_id == pre_season_id %}selected{% endif %}>{{ s.year }}</option>
        {% endfor %}
      </select>
    </div>
    
    <div class="form-group">
      <label for="t_type">ğŸ… æ¯”èµ›ç±»å‹</label>
      <select id="t_type" name="t_type" required>
        <option value="1">ğŸ¥‡ æ­£èµ›</option>
        <option value="2">ğŸ¥ˆ å°èµ› (CM250)</option>
        <option value="3">ğŸ† æ€»å†³èµ›</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="t_format">âš™ï¸ èµ›åˆ¶</label>
      <select id="t_format" name="t_format" required>
        {% for k,v in t_format_labels.items() %}
          <option value="{{ k }}">{{ v }}</option>
        {% endfor %}
      </select>
    </div>
    
    <div class="form-group">
      <label for="player_count">ğŸ‘¥ å‚èµ›äººæ•°</label>
      <input type="number" id="player_count" name="player_count" min="2" max="32" value="2" required placeholder="è¯·è¾“å…¥å‚èµ›äººæ•°">
      <small id="player_count_help" class="form-text text-muted">åŒè´¥æ·˜æ±°èµ›éœ€è¦2çš„å¹‚æ¬¡æ–¹äººæ•°ï¼ˆ4, 8, 16, 32ï¼‰</small>
    </div>
    
    <div class="form-group">
      <label for="signup_deadline">â° æŠ¥åæˆªæ­¢æ—¶é—´ï¼ˆå¯é€‰ï¼‰</label>
      <input type="datetime-local" id="signup_deadline" name="signup_deadline" placeholder="ç•™ç©ºè¡¨ç¤ºä¸é™åˆ¶æŠ¥åæ—¶é—´">
      <small class="form-text text-muted">ä»2025å¹´ä¸‹åŠå¹´å¼€å§‹ï¼Œè®¾ç½®æŠ¥åæˆªæ­¢æ—¶é—´åï¼Œå‚èµ›é€‰æ‰‹åªèƒ½ä»å·²æŠ¥åç”¨æˆ·ä¸­é€‰æ‹©</small>
    </div>
    
    <button type="submit" class="form-button">æ·»åŠ å±Šæ¬¡</button>
  </form>
  
  <div class="form-links">
    <p><a href="{{ url_for('admin_index') }}">â† è¿”å›ç®¡ç†é¢æ¿</a></p>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const tFormatSelect = document.getElementById('t_format');
  const playerCountInput = document.getElementById('player_count');
  const playerCountHelp = document.getElementById('player_count_help');
  
  function updatePlayerCountValidation() {
    const selectedFormat = parseInt(tFormatSelect.value);
    
    if (selectedFormat === 7) { // åŒè´¥æ·˜æ±°èµ›
      playerCountInput.min = 4;
      playerCountInput.max = 32;
      playerCountHelp.textContent = 'åŒè´¥æ·˜æ±°èµ›éœ€è¦2çš„å¹‚æ¬¡æ–¹äººæ•°ï¼ˆ4, 8, 16, 32ï¼‰';
      playerCountHelp.style.color = '#dc3545';
      
      // éªŒè¯æ˜¯å¦ä¸º2çš„å¹‚æ¬¡æ–¹
      playerCountInput.addEventListener('input', function() {
        const count = parseInt(this.value);
        if (count && !isPowerOfTwo(count)) {
          this.setCustomValidity('åŒè´¥æ·˜æ±°èµ›éœ€è¦2çš„å¹‚æ¬¡æ–¹äººæ•°ï¼ˆ4, 8, 16, 32ï¼‰');
        } else {
          this.setCustomValidity('');
        }
      });
    } else {
      playerCountInput.min = 2;
      playerCountInput.max = 32;
      playerCountHelp.textContent = 'è¯·è¾“å…¥å‚èµ›äººæ•°';
      playerCountHelp.style.color = '#6c757d';
      playerCountInput.setCustomValidity('');
    }
  }
  
  function isPowerOfTwo(n) {
    return n > 0 && (n & (n - 1)) === 0 && n >= 4;
  }
  
  tFormatSelect.addEventListener('change', updatePlayerCountValidation);
  updatePlayerCountValidation();
});
</script>
{% endblock %}