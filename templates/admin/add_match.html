{% extends 'layout.html' %}
{% block content %}
<div class="form-container">
  <h2>
    {% if pre_t_id %}
      {% set sel = tournaments|selectattr('t_id','equalto',pre_t_id)|first %}
      ⚔️ 添加单场比赛
      <p class="match-info">📍 {{ sel.season.year if sel and sel.season else '' }} - 第{{ sel.type_session_number if sel and sel.type_session_number is defined else pre_t_id }}届</p>
    {% else %}
      ⚔️ 添加单场比赛
    {% endif %}
  </h2>
  
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="flash-messages">
        {% for message in messages %}
          <div class="flash-message flash-success">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
  
  <form method="post">
    <input type="hidden" name="season_id" value="{{ pre_season_id or '' }}">
    
    <div class="form-group">
      <label for="t_id">🏆 比赛届次</label>
      <select id="t_id" name="t_id" required>
        {% for t in tournaments %}
          <option value="{{ t.t_id }}" data-tformat="{{ t.t_format or 0 }}" {% if pre_t_id and t.t_id == pre_t_id %}selected{% endif %}>{{ t.season.year }} / 第{{ t.type_session_number }}届</option>
        {% endfor %}
      </select>
    </div>
    
    <div class="form-group">
      <label for="m_type_select">📋 比赛类型</label>
      <select id="m_type_select" name="m_type" required>
        {% for k,v in m_type_labels.items() %}
          <option value="{{ k }}">{{ v }}</option>
        {% endfor %}
      </select>
    </div>
    
    <div class="match-players">
      <div class="player-group">
        <label for="player_1_id">👤 选手1</label>
        <select id="player_1_id" name="player_1_id" required>
          {% for p in players %}
            <option value="{{ p.player_id }}">{{ p.name }}</option>
          {% endfor %}
        </select>
        <label for="player_1_score">📊 分数</label>
        <input type="number" id="player_1_score" name="player_1_score" value="0" min="0" max="20" required>
      </div>
      
      <div class="vs-divider">VS</div>
      
      <div class="player-group">
        <label for="player_2_id">👤 选手2</label>
        <select id="player_2_id" name="player_2_id" required>
          {% for p in players %}
            <option value="{{ p.player_id }}">{{ p.name }}</option>
          {% endfor %}
        </select>
        <label for="player_2_score">📊 分数</label>
        <input type="number" id="player_2_score" name="player_2_score" value="0" min="0" max="20" required>
      </div>
    </div>
    
    <button type="submit" class="form-button">添加比赛</button>
  </form>
  
  <div class="form-links">
    <p><a href="{{ url_for('admin_index') }}">← 返回管理面板</a></p>
  </div>
</div>

<style>
.match-info {
  text-align: center;
  color: #666;
  font-size: 1em;
  margin: 10px 0 20px 0;
  padding: 8px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 6px;
  border: 1px solid #dee2e6;
}

.match-players {
  display: flex;
  align-items: center;
  gap: 20px;
  margin: 20px 0;
  padding: 20px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 10px;
  border: 1px solid #dee2e6;
}

.player-group {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.player-group label {
  font-weight: 500;
  color: #555;
  font-size: 0.9em;
}

.player-group select,
.player-group input {
  padding: 8px 12px;
  border: 2px solid #e1e5e9;
  border-radius: 6px;
  font-size: 0.9em;
  transition: all 0.3s ease;
}

.player-group select:focus,
.player-group input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}

.vs-divider {
  font-size: 1.5em;
  font-weight: bold;
  color: #667eea;
  text-align: center;
  padding: 10px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

@media (max-width: 768px) {
  .match-players {
    flex-direction: column;
    gap: 15px;
  }
  
  .vs-divider {
    transform: rotate(90deg);
  }
}
</style>

<script>
// filter m_type options based on selected tournament's t_format
(function(){
  const allowed = {{ format_allowed | tojson }};
  const tSel = document.querySelector('select[name=t_id]');
  const mSel = document.getElementById('m_type_select');
  function update(){
    const opt = tSel.selectedOptions[0];
    const tf = parseInt(opt.dataset.tformat || '0');
    const allowedList = allowed[tf] || Object.keys(allowed).flatMap(k=>allowed[k]);
    for(const o of mSel.options){
      o.disabled = !allowedList.includes(parseInt(o.value));
    }
  }
  tSel.addEventListener('change', update);
  update();
})();
</script>
{% endblock %}
