{% extends 'layout.html' %}
{% block content %}
  <div class="tournament-info" style="text-align: center;">
    <h2>{{ tournament.season.year if tournament.season else tournament.season_id }} - ç¬¬{{ tournament.type_session_number }}å±Š</h2>
    
    {% if session.get('admin_logged_in') %}
      <p><a href="/admin-secret">è¿”å›åå°ç®¡ç†é¦–é¡µ</a></p>
    {% endif %}

    <p>
      ç±»å‹
      &NonBreakingSpace;
      <b>{% if tournament.type == 1 %}æ­£èµ›{% elif tournament.type == 2 %}å°èµ› (CM250){% elif tournament.type == 3 %}æ€»å†³èµ›{% else %}æœªçŸ¥ç±»å‹{% endif %}</b>
    </p>
    <p>
      å‚èµ›äººæ•°
      &NonBreakingSpace;
      <b>{{ tournament.player_count or 'æœªè®¾ç½®' }}</b>
    </p>
    <p>
      èµ›åˆ¶
      &NonBreakingSpace;
      <b>{{ t_format_labels.get(tournament.t_format) if tournament.t_format is not none else 'æœªè®¾ç½®' }}</b>
    </p>
    <p>
      èµ›å­£
      &NonBreakingSpace;
      <b><a href="/season/{{ tournament.season_id }}">{{ tournament.season.year if tournament.season else tournament.season_id }}</a></b>
    </p>
  </div>
  
  {% if pagination %}
    <div class="pagination-container">
      <!-- åŒç±»å‹èµ›äº‹ç¿»ï¿½?-->
      {% if pagination.same_type %}
        <div class="pagination-box same-type-pagination" style="border: 3px solid #0055aa;background: #f0f8ff;">
          <h4>åŒç±»å‹èµ›äº‹ç¿»ï¿½?/h4>
          <div class="pagination-controls">
            <div class="pagination-left">
              {% if pagination.same_type.has_prev %}
                <a href="/tournament/{{ pagination.same_type.prev_info.t_id }}" class="pagination-btn prev-btn">
                  ï¿½?ä¸Šä¸€ï¿½?                  <div class="btn-info">
                    <div class="season-year">{{ pagination.same_type.prev_info.season_year }}</div>
                    <div class="tournament-info">ç¬¬{{ pagination.same_type.prev_info.session_number }}å±Š{{ pagination.same_type.prev_info.type_name }}</div>
                  </div>
                </a>
                <div class="pagination-info desktop-only">
                  <div class="season-year">{{ pagination.same_type.prev_info.season_year }}</div>
                  <div class="tournament-info">ç¬¬{{ pagination.same_type.prev_info.session_number }}å±Š{{ pagination.same_type.prev_info.type_name }}</div>
                </div>
              {% else %}
                <span class="pagination-btn disabled">
                  ï¿½?ä¸Šä¸€ï¿½?                  <div class="btn-info">
                    <div class="season-year">-</div>
                    <div class="tournament-info">ï¿½?/div>
                  </div>
                </span>
              {% endif %}
            </div>
            <!-- <div class="pagination-center">
              <div class="current-tournament">
                <div class="season-year">{{ tournament.season.year if tournament.season else tournament.season_id }}</div>
                <div class="tournament-info">ç¬¬{{ tournament.type_session_number }}å±Š{% if tournament.type == 1 %}æ­£èµ›{% elif tournament.type == 2 %}å°èµ›{% elif tournament.type == 3 %}æ€»å†³èµ›{% endif %}</div>
              </div>
            </div> -->
            <div class="pagination-right">
              {% if pagination.same_type.has_next %}
                <a href="/tournament/{{ pagination.same_type.next_info.t_id }}" class="pagination-btn next-btn">
                  ä¸‹ä¸€ï¿½?ï¿½?                  <div class="btn-info">
                    <div class="season-year">{{ pagination.same_type.next_info.season_year }}</div>
                    <div class="tournament-info">ç¬¬{{ pagination.same_type.next_info.session_number }}å±Š{{ pagination.same_type.next_info.type_name }}</div>
                  </div>
                </a>
                <div class="pagination-info desktop-only">
                  <div class="season-year">{{ pagination.same_type.next_info.season_year }}</div>
                  <div class="tournament-info">ç¬¬{{ pagination.same_type.next_info.session_number }}å±Š{{ pagination.same_type.next_info.type_name }}</div>
                </div>
              {% else %}
                <span class="pagination-btn disabled">
                  ä¸‹ä¸€ï¿½?ï¿½?                  <div class="btn-info">
                    <div class="season-year">-</div>
                    <div class="tournament-info">ï¿½?/div>
                  </div>
                </span>
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}
      
      <!-- æ‰€æœ‰èµ›äº‹ç¿»ï¿½?-->
      {% if pagination.all_tournaments %}
        <div class="pagination-box all-tournaments-pagination" style="border: 3px solid #55aa00;background: #f8fff0;">
          <h4>æ‰€æœ‰èµ›äº‹ç¿»ï¿½?/h4>
          <div class="pagination-controls">
            <div class="pagination-left">
              {% if pagination.all_tournaments.has_prev %}
                <a href="/tournament/{{ pagination.all_tournaments.prev_info.t_id }}" class="pagination-btn prev-btn">
                  ï¿½?ä¸Šä¸€ï¿½?                  <div class="btn-info">
                    <div class="season-year">{{ pagination.all_tournaments.prev_info.season_year }}</div>
                    <div class="tournament-info">ç¬¬{{ pagination.all_tournaments.prev_info.session_number }}å±Š{{ pagination.all_tournaments.prev_info.type_name }}</div>
                  </div>
                </a>
                <div class="pagination-info desktop-only">
                  <div class="season-year">{{ pagination.all_tournaments.prev_info.season_year }}</div>
                  <div class="tournament-info">ç¬¬{{ pagination.all_tournaments.prev_info.session_number }}å±Š{{ pagination.all_tournaments.prev_info.type_name }}</div>
                </div>
              {% else %}
                <span class="pagination-btn disabled">
                  ï¿½?ä¸Šä¸€ï¿½?                  <div class="btn-info">
                    <div class="season-year">-</div>
                    <div class="tournament-info">ï¿½?/div>
                  </div>
                </span>
              {% endif %}
            </div>
            <!-- <div class="pagination-center">
              <div class="current-tournament">
                <div class="season-year">{{ tournament.season.year if tournament.season else tournament.season_id }}</div>
                <div class="tournament-info">ç¬¬{{ tournament.type_session_number }}å±Š{% if tournament.type == 1 %}æ­£èµ›{% elif tournament.type == 2 %}å°èµ›{% elif tournament.type == 3 %}æ€»å†³èµ›{% endif %}</div>
              </div>
            </div> -->
            <div class="pagination-right">
              {% if pagination.all_tournaments.has_next %}
                <a href="/tournament/{{ pagination.all_tournaments.next_info.t_id }}" class="pagination-btn next-btn">
                  ä¸‹ä¸€ï¿½?ï¿½?                  <div class="btn-info">
                    <div class="season-year">{{ pagination.all_tournaments.next_info.season_year }}</div>
                    <div class="tournament-info">ç¬¬{{ pagination.all_tournaments.next_info.session_number }}å±Š{{ pagination.all_tournaments.next_info.type_name }}</div>
                  </div>
                </a>
                <div class="pagination-info desktop-only">
                  <div class="season-year">{{ pagination.all_tournaments.next_info.season_year }}</div>
                  <div class="tournament-info">ç¬¬{{ pagination.all_tournaments.next_info.session_number }}å±Š{{ pagination.all_tournaments.next_info.type_name }}</div>
                </div>
              {% else %}
                <span class="pagination-btn disabled">
                  ä¸‹ä¸€ï¿½?ï¿½?                  <div class="btn-info">
                    <div class="season-year">-</div>
                    <div class="tournament-info">ï¿½?/div>
                  </div>
                </span>
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  {% endif %}
  
  <!-- é¡µé¢å¯¼èˆª -->
  {% if tournament.type != 2 or tournament.type_session_number < 2 %}
    <div class="page-navigation">
      <button onclick="showPage('group-stage')" class="page-btn" id="btn-group-stage">å°ç»„ï¿½?/button>
      <button onclick="showPage('knockout')" class="page-btn" id="btn-knockout" style="background-color: #ff6b6b; color: white;">æ·˜æ±°ï¿½?/button>
    </div>
  {% endif %}

  <!-- æœ€ç»ˆæ’åé¡µï¿½?-->
  <!-- <div id="page-final-ranking" class="page-content">
    <h3>æœ€ç»ˆæ’ï¿½?/h3>
    <table class="table table-striped">
        <thead>
          <tr>
          <th>æ’å</th>
          <th>é€‰æ‰‹</th>
          <th>ç§¯åˆ†</th>
          <th>å¾—åˆ†</th>
          <th>å¤±åˆ†</th>
          <th>å‡€ï¿½?/th>
          </tr>
        </thead>
        <tbody>
        {% for r in final_rankings %}
          <tr {% if r.player.name == 'é€€ï¿½? or r.player.name == 'å¤§èµ›æ’åå·²ç§»ï¿½? or r.player.name == 'å°èµ›æ’åå·²ç§»ï¿½? or r.player.name == 'N/A' %}class="cancelled"{% endif %}>
            <td>{{ loop.index }}</td>
            <td>{{ r.player.name }}</td>
            <td>{{ r.scores or 'æœªè®¡ï¿½? }}</td>
            <td>{{ r.goals_for or 0 }}</td>
            <td>{{ r.goals_against or 0 }}</td>
            <td>{{ (r.goals_for or 0) - (r.goals_against or 0) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
  </div> -->


  <!-- å°ç»„èµ›é¡µï¿½?-->
  <div id="page-group-stage" class="page-content">
    <!-- å°ç»„èµ›ç®¡ç†æ¨¡å—ï¼ˆä»…é™t_formatï¿½?,2,3çš„èµ›äº‹ï¼‰ -->
      {% if session.get('admin_logged_in') and tournament.t_format in [1, 2, 3] %}
      <!-- æ£€æŸ¥åˆ†ç»„çŠ¶ï¿½?-->
      {% set has_groups = group_stage_data and group_stage_data.groups %}
      {% set has_players = has_groups and group_stage_data.groups[0].players|length > 0 %}
      
      {% if has_groups and has_players %}
        <!-- å·²åˆ†ç»„ä¸”å·²åˆ†é…é€‰æ‰‹çš„æƒ…ï¿½?-->
        <div class="admin-controls" style="text-align: center;">
          <h4>ğŸ† å°ç»„èµ›ç®¡ï¿½?/h4>
          <p>åˆ†ç»„ä¿¡æ¯å·²å®Œæˆï¼Œå…±{{ group_stage_data.groups|length }}ä¸ªå°ï¿½?/p>
          <button onclick="showGroupSettings()" class="btn btn-primary">é‡æ–°è®¾ç½®åˆ†ç»„</button>
        </div>
        
        <!-- éšè—çš„åˆ†ç»„è®¾ç½®æ¨¡ï¿½?-->
        <div id="group-settings" style="display: none;">
          <h4>âœï¸ å°ç»„èµ›è®¾ï¿½?/h4>
          <form id="group-settings-form">
            <div class="form-group">
              <label for="group-size-edit">ğŸ‘¥ æ¯ç»„äººæ•°</label>
              <select id="group-size-edit" name="group_size" class="form-control">
                {% for factor in range(2, 9) %}
                  {% if tournament.player_count % factor == 0 %}
                    <option value="{{ factor }}" {% if group_stage_data.groups[0].players|length == factor %}selected{% endif %}>{{ factor }}ï¿½?/option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
            
            <div class="form-group">
              <label for="round-robin-type-edit">âš™ï¸ èµ›åˆ¶ç±»å‹</label>
              <select id="round-robin-type-edit" name="round_robin_type" class="form-control">
                <option value="single">å•å¾ªï¿½?/option>
                <option value="double">åŒå¾ªï¿½?/option>
              </select>
              <span class="help-text">
                å•å¾ªç¯ï¼šæ¯å¯¹é€‰æ‰‹åªæ¯”èµ›ä¸€æ¬¡ï¼›åŒå¾ªç¯ï¼šæ¯å¯¹é€‰æ‰‹æ¯”èµ›ä¸¤æ¬¡ï¼ˆä¸»å®¢åœºï¿½?              </span>
            </div>
            
            {% for group in group_stage_data.groups %}
              <div class="group-settings">
                <h6>ğŸ·ï¿½?{{ group.t_name }}</h6>
                <div class="form-group">
                  <label>ğŸ‘¤ é€‰æ‰‹åˆ—è¡¨</label>
                  <div class="player-list">
                    {% for player in group.players %}
                      <div class="player-item">
                        <span>{{ player.name }}</span>
                        <button type="button" onclick="removePlayerFromGroup({{ group.t_id }}, {{ player.player_id }})" class="btn btn-sm btn-danger">ç§»é™¤</button>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
    {% endfor %}
            
            <button type="submit" class="btn btn-success">ä¿å­˜è®¾ç½®</button>
            <button type="button" onclick="hideGroupSettings()" class="btn btn-secondary">å–æ¶ˆ</button>
          </form>
        </div>
      {% elif has_groups and not has_players %}
        <!-- å·²ç¡®å®šæ¯ç»„äººæ•°ä½†æœªå¡«å†™é€‰æ‰‹åˆ†ç»„çš„æƒ…ï¿½?-->
        <div class="admin-controls" style="text-align: center;">
          <h4>ğŸ‘¥ é€‰æ‰‹åˆ†ç»„è®¾ç½®</h4>
          <p>åˆ†ç»„å·²åˆ›å»ºï¼Œå…±{{ group_stage_data.groups|length }}ä¸ªå°ç»„ï¼Œè¯·åˆ†é…é€‰æ‰‹</p>
        </div>
        
        <!-- é€‰æ‰‹åˆ†ç»„è®¾ç½®åŒºåŸŸï¼ˆç›´æ¥æ˜¾ç¤ºï¼‰ -->
        <div id="player-grouping">
          <h4>ğŸ‘¥ é€‰æ‰‹åˆ†ç»„è®¾ç½®</h4>
          <div id="grouping-form">
            <!-- åŠ¨æ€ç”Ÿæˆçš„åˆ†ç»„ç•Œé¢ -->
          </div>
          <div class="grouping-actions">
            <button onclick="submitPlayerGrouping()" class="btn btn-success">ç¡®è®¤åˆ†ç»„</button>
            <button onclick="resetToGroupSettings()" class="btn btn-secondary">é‡æ–°è®¾ç½®åˆ†ç»„</button>
          </div>
        </div>
        
        <!-- éšè—çš„åˆ†ç»„è®¾ç½®æ¨¡ï¿½?-->
        <div id="group-settings" style="display: none;">
          <h4>ğŸ† å°ç»„èµ›è®¾ï¿½?/h4>
          <form id="group-settings-form">
            <div class="form-group">
              <label for="group-size">ğŸ‘¥ æ¯ç»„äººæ•°</label>
              <select id="group-size" name="group_size" class="form-control">
                {% for factor in range(2, 9) %}
                  {% if tournament.player_count % factor == 0 %}
                    <option value="{{ factor }}">{{ factor }}ï¿½?/option>
                  {% endif %}
                {% endfor %}
              </select>
              <span class="help-text">
                é€‰æ‹©æ¯ç»„äººæ•°ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—åˆ†ç»„æ•°é‡
              </span>
            </div>
            
            <div class="form-group">
              <label for="round-robin-type">âš™ï¸ èµ›åˆ¶ç±»å‹</label>
              <select id="round-robin-type" name="round_robin_type" class="form-control">
                <option value="single">å•å¾ªï¿½?/option>
                <option value="double">åŒå¾ªï¿½?/option>
              </select>
              <span class="help-text">
                å•å¾ªç¯ï¼šæ¯å¯¹é€‰æ‰‹åªæ¯”èµ›ä¸€æ¬¡ï¼›åŒå¾ªç¯ï¼šæ¯å¯¹é€‰æ‰‹æ¯”èµ›ä¸¤æ¬¡ï¼ˆä¸»å®¢åœºï¿½?              </span>
            </div>
            
            <button type="submit" class="btn btn-primary">ç”Ÿæˆåˆ†ç»„</button>
          </form>
        </div>
  {% else %}
        <!-- æœªåˆ†ç»„çš„æƒ…å†µ -->
        <div id="group-settings">
          <h4>ğŸ† å°ç»„èµ›è®¾ï¿½?/h4>
          <form id="group-settings-form">
            <div class="form-group">
              <label for="group-size">ğŸ‘¥ æ¯ç»„äººæ•°</label>
              <select id="group-size" name="group_size" class="form-control">
                {% for factor in range(2, 9) %}
                  {% if tournament.player_count % factor == 0 %}
                    <option value="{{ factor }}">{{ factor }}ï¿½?/option>
                  {% endif %}
                {% endfor %}
              </select>
              <span class="help-text">
                é€‰æ‹©æ¯ç»„äººæ•°ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—åˆ†ç»„æ•°é‡
              </span>
            </div>
            
            <div class="form-group">
              <label for="round-robin-type">âš™ï¸ èµ›åˆ¶ç±»å‹</label>
              <select id="round-robin-type" name="round_robin_type" class="form-control">
                <option value="single">å•å¾ªï¿½?/option>
                <option value="double">åŒå¾ªï¿½?/option>
              </select>
              <span class="help-text">
                å•å¾ªç¯ï¼šæ¯å¯¹é€‰æ‰‹åªæ¯”èµ›ä¸€æ¬¡ï¼›åŒå¾ªç¯ï¼šæ¯å¯¹é€‰æ‰‹æ¯”èµ›ä¸¤æ¬¡ï¼ˆä¸»å®¢åœºï¿½?              </span>
            </div>
            
            <button type="submit" class="btn btn-primary">ç”Ÿæˆåˆ†ç»„</button>
          </form>
        </div>
        
        <!-- é€‰æ‰‹åˆ†ç»„è®¾ç½®åŒºåŸŸï¼ˆç”Ÿæˆåˆ†ç»„åæ˜¾ç¤ºï¿½?-->
        <div id="player-grouping" style="display: none;">
          <h4>ğŸ‘¥ é€‰æ‰‹åˆ†ç»„è®¾ç½®</h4>
          <div id="grouping-form">
            <!-- åŠ¨æ€ç”Ÿæˆçš„åˆ†ç»„ç•Œé¢ -->
          </div>
          <div class="grouping-actions">
            <button onclick="submitPlayerGrouping()" class="btn btn-success">ç¡®è®¤åˆ†ç»„</button>
            <button onclick="cancelPlayerGrouping()" class="btn btn-secondary">å–æ¶ˆ</button>
          </div>
        </div>
      {% endif %}
  {% endif %}
    
    <!-- æ¯”èµ›ç­›é€‰å™¨ï¼ˆä»…é™å¤§èµ›ï¼Œä¸”ä¸æ˜¯å•å¾ªç¯/åŒå¾ªç¯èµ›ï¿½?-->
     
          <!-- <div class="filter-group">
            <label for="filter-group">å°ç»„ï¿½?/label>
            <select id="filter-group" class="filter-select">
              <option value="">å…¨éƒ¨å°ç»„</option>
              {% if group_stage_data and group_stage_data.groups %}
                {% for group in group_stage_data.groups %}
                  <option value="{{ group.t_name }}">{{ group.t_name }}</option>
                {% endfor %}
              {% endif %}
            </select>
          </div> -->
    {% if tournament.type == 1 %}
      <!-- <div class="match-filter">
        <h4>æ¯”èµ›ç­›ï¿½?/h4>
        <div class="filter-controls">
          
          <div class="filter-group">
            <label for="filter-status">æ¯”èµ›çŠ¶æ€ï¼š</label>
            <select id="filter-status" class="filter-select">
              <option value="">å…¨éƒ¨çŠ¶ï¿½?/option>
              <option value="completed">å·²å®Œï¿½?/option>
              <option value="pending">æœªå¼€ï¿½?/option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="filter-player">é€‰æ‰‹ï¿½?/label>
            <select id="filter-player" class="filter-select">
              <option value="">å…¨éƒ¨é€‰æ‰‹</option>
              {% if group_stage_data and group_stage_data.groups %}
                {% for group in group_stage_data.groups %}
                  {% for player in group.players %}
                    <option value="{{ player.name }}">{{ player.name }}</option>
                  {% endfor %}
                {% endfor %}
              {% endif %}
            </select>
          </div>
          
          <div class="filter-actions">
            <button onclick="clearMatchFilters()" class="btn btn-secondary">æ¸…é™¤ç­›ï¿½?/button>
            <button onclick="applyMatchFilters()" class="btn btn-primary">åº”ç”¨ç­›ï¿½?/button>
          </div>
        </div>
      </div> -->
    
    <!-- å°ç»„èµ›æ˜¾ç¤ºï¼ˆä»…é™éå•å¾ªç¯/åŒå¾ªç¯èµ›çš„å¤§èµ›ï¼‰ -->
    {% if group_stage_data and group_stage_data.groups and not (tournament.type == 1 and tournament.t_format in [4,5]) %}
      <!-- å°ç»„åˆ†é¡µå¯¼èˆª -->
      <div class="group-navigation">
      {% for group in group_stage_data.groups %}
          <button onclick="showGroup('{{ group.t_name }}')" class="group-btn {% if loop.first %}active{% endif %}" id="btn-{{ group.t_name }}">{{ group.t_name }}ï¿½?/button>
        {% endfor %}
      </div>
      
      {% for group in group_stage_data.groups %}
        <div class="group-section" id="group-{{ group.t_name }}" {% if not loop.first %}style="display: none;"{% endif %}>
          <!-- <h4>{{ group.t_name }}</h4> -->
          
          
          <!-- æ’åè¡¨æ ¼ -->
          <div class="group-ranking">
            <!-- æ¡Œé¢ç«¯æ’åè¡¨ï¿½?-->
            <div class="desktop-ranking">
              <table class="table table-striped group-table">
                <thead>
                  <tr>
                    <th>æ’å</th>
                      <th>é€‰æ‰‹</th>
                      <th>åœºæ¬¡</th>
                      <th>ï¿½?/th>
                      <th>ï¿½?/th>
                      <th>ï¿½?/th>
                      <th>æ€»å¾—ï¿½?/th>
                      <th>æ€»å¤±ï¿½?/th>
                      <th>å‡€èƒœåˆ†</th>
                      <th>ç§¯åˆ†</th>
                      <th>æ€»æ’ï¿½?/th>
                  </tr>
                </thead>
                <tbody>
                  {% for player in group.players %}
                    <tr class="{% if tournament.t_format == 1 and player.total_rank <= 8 %}top8{% endif %}">
                      <td>{{ player.group_rank }}</td>
                      <td><a href="/player/{{ player.player_id }}">{{ player.name }}</a></td>
                      
                      <!-- <td>{{ player.matches_played }}</td>
                        -->
                      <!-- <td style="
                       {% if group.player_count - 1 
                       == player.wins + player.draws + player.losses %}
                       background-color: #f3e6ff; font-weight: bold;{% endif %}">{{ player.wins + player.draws + player.losses }}</td> -->
                      
                      <td style="{% if player.total_matches == player.wins + player.draws + player.losses %}background-color: rgba(205,255,155,0.75); font-weight: bold;{% endif %}">
                        {{ player.wins + player.draws + player.losses }}
                      </td>
                      <td>{{ player.wins }}</td>
                      <td>{{ player.draws }}</td>
                      <td>{{ player.losses }}</td>
                      <td>{{ player.goals_for }}</td>
                      <td>{{ player.goals_against }}</td>
                      <td>{{ player.goals_for - player.goals_against }}</td>
                      <td>{{ player.points }}</td>
                      <td>{{ player.total_rank }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
            <!-- ç§»åŠ¨ç«¯æ’åå¡ï¿½?-->
            <div class="mobile-ranking">
              {% for player in group.players %}
                <div class="player-card {% if tournament.t_format == 1 and player.total_rank <= 8 %}top8{% endif %}">
                  <div class="player-header">
                    <span class="player-name"><a href="/player/{{ player.player_id }}">{{ player.name }}</a></span>
                    <span class="group-rank">å°ç»„ ç¬¬{{ player.group_rank }}</span>
                    <span class="total-rank" style="margin-left: 1em;">æ€»æ’ï¿½?ç¬¬{{ player.total_rank }}</span>
                  </div>
                  <div class="player-stats">
                    <div class="stat-row">
                      <span class="stat-value">{{ player.wins }}</span>
                      <span class="stat-label">ï¿½?/span>
                    </div>
                    <div class="stat-row">
                      <span class="stat-value">{{ player.losses }}</span>
                      <span class="stat-label">ï¿½?/span>
                    </div>
                    <div class="stat-row">
                      <span class="stat-value">{{ player.goals_for }}</span>
                      <span class="stat-label">å¾—åˆ†</span>
                    </div>
                    <div class="stat-row">
                      <span class="stat-value">{{ player.goals_against }}</span>
                      <span class="stat-label">å¤±åˆ†</span>
                    </div>
                    <div class="stat-row">
                      <span class="stat-value">{{ player.goals_for - player.goals_against }}</span>
                      <span class="stat-label">å‡€ï¿½?/span>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
          
          <!-- ç»„å†…ç­›é€‰å™¨ -->
          <div class="group-filter">
            <!-- <h5>æ¯”èµ›ç­›ï¿½?/h5> -->
            <div class="filter-controls">
              <div class="filter-group">
                <label for="filter-status-{{ group.t_name }}">æ¯”èµ›çŠ¶æ€ï¼š</label>
                <select id="filter-status-{{ group.t_name }}" class="filter-select">
                  <option value="">å…¨éƒ¨çŠ¶ï¿½?/option>
                  <option value="completed">å·²å®Œï¿½?/option>
                  <option value="pending">æœªå¼€ï¿½?/option>
                </select>
              </div>
              
              <div class="filter-group">
                <label for="filter-player-{{ group.t_name }}">é€‰æ‰‹ï¿½?/label>
                <select id="filter-player-{{ group.t_name }}" class="filter-select">
                  <option value="">å…¨éƒ¨é€‰æ‰‹</option>
                  {% for player in group.players %}
                    <option value="{{ player.name }}">{{ player.name }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <div class="filter-actions">
                <button onclick="clearGroupFilters('{{ group.t_name }}')" class="btn btn-secondary">æ¸…é™¤ç­›ï¿½?/button>
                <button onclick="applyGroupFilters('{{ group.t_name }}')" class="btn btn-primary">åº”ç”¨ç­›ï¿½?/button>
              </div>
            </div>
          </div>
          
          <!-- æ¯”èµ›ç»“æœ - è‡ªé€‚åº”å¡ç‰‡æ ·å¼ -->
          <div class="group-matches">
            <!-- <h5>{{ group.t_name }}ç»„æ¯”ï¿½?/h5> -->
            <div class="matches-grid">
              {% for match in group.matches %}
                <div class="match-card" 
                     data-group="{{ group.t_name }}" 
                     data-player1="{{ match.player1.name }}" 
                     data-player2="{{ match.player2.name }}"
                     data-status="{% if match.player_1_score is not none and match.player_2_score is not none and not (match.player_1_score == 0 and match.player_2_score == 0) %}completed{% else %}pending{% endif %}"
                     data-group-name="{{ group.t_name }}">
                  <div class="match-header">
                    <span class="match-title">{% if match.m_type == 14 %}é™„åŠ èµ›{% else %}ç¬¬{{ loop.index }}åœº{% endif %}</span>
                  </div>
                  <div class="match-players">
                    <div class="player-info">
                      <span class="player-name">{{ match.player1.name }}</span>
                      {% if match.m_type == 2 %}
                        <span class="home-away-tag home">ï¿½?/span>
                      {% elif match.m_type == 3 %}
                        <span class="home-away-tag away">ï¿½?/span>
                      {% endif %}
                      <div class="score-display">
                        {% if match.player_1_score is not none and match.player_2_score is not none and match.player_1_score >= 0 and match.player_2_score >= 0 %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                   data-match-id="{{ match.m_id }}" data-player="1" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}">
                          {% else %}
                            <span class="score {% if match.player_1_score > match.player_2_score %}winner_1{% elif match.player_1_score == match.player_2_score and match.player_1_score > 0 %}tier_1{% endif %}">{{ match.player_1_score }}</span>
                          {% endif %}
                        {% else %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                   data-match-id="{{ match.m_id }}" data-player="1" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}">
                          {% else %}
                            <span class="score">-</span>
                          {% endif %}
                        {% endif %}
                      </div>
                    </div>
                    <div class="vs-divider">VS</div>
                    <div class="player-info">
                      <span class="player-name">{{ match.player2.name }}</span>
                      {% if match.m_type == 2 %}
                        <span class="home-away-tag away">ï¿½?/span>
                      {% elif match.m_type == 3 %}
                        <span class="home-away-tag home">ï¿½?/span>
                      {% endif %}
                      <div class="score-display">
                        {% if match.player_1_score is not none and match.player_2_score is not none and match.player_1_score >= 0 and match.player_2_score >= 0 %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                   data-match-id="{{ match.m_id }}" data-player="2" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}">
                          {% else %}
                            <span class="score {% if match.player_2_score > match.player_1_score %}winner_2{% elif match.player_2_score == match.player_1_score and match.player_2_score > 0 %}tier_2{% endif %}">{{ match.player_2_score }}</span>
                          {% endif %}
                        {% else %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                   data-match-id="{{ match.m_id }}" data-player="2" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}">
                          {% else %}
                            <span class="score">-</span>
                          {% endif %}
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% if session.get('admin_logged_in') %}
                    <div class="match-actions">
                      <button class="btn btn-sm btn-primary" onclick="submitScore({{ match.m_id }})">
                        {% if match.player_1_score is not none and match.player_2_score is not none and match.player_1_score >= 0 and match.player_2_score >= 0 %}
                          æ›´æ–°
                        {% else %}
                          æäº¤
                        {% endif %}
                      </button>
                    </div>
                  {% else %}
                    {% if match.player_1_score is not none and match.player_2_score is not none %}
                      <!-- <div class="match-result">
                        {% if match.player_1_score > match.player_2_score %}
                          <span class="winner">{{ match.player1.name }} è·èƒœ</span>
                        {% elif match.player_2_score > match.player_1_score %}
                          <span class="winner">{{ match.player2.name }} è·èƒœ</span>
                        {% else %}
                          <span class="draw">å¹³å±€</span>
                        {% endif %}
                      </div> -->
                    {% endif %}
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      {% endfor %}
      {% endif %}
    {% endif %}
    
    <!-- å•å¾ªç¯èµ›æ˜¾ç¤ºï¼ˆæ‰€æœ‰èµ›äº‹ç±»å‹éƒ½æ”¯æŒï¿½?-->
    {% if tournament.t_format in [4, 5, 6] %}
      <!-- ç®¡ç†å‘˜æ§åˆ¶é¢æ¿ï¼ˆå•å¾ªï¿½?åŒå¾ªç¯èµ›/è‹è¶…èµ›åˆ¶ï¼Œç®¡ç†å‘˜ç™»å½•æ—¶æ˜¾ç¤ºï¼‰ -->
      {% if session.get('admin_logged_in') %}
        <!-- ç®¡ç†å‘˜æ§åˆ¶é¢æ¿åˆ‡æ¢æŒ‰ï¿½?-->
        <div class="admin-controls-toggle" style="text-align: center; margin-bottom: 20px;">
          <button onclick="toggleAdminControls()" class="btn btn-outline-primary" id="admin-toggle-btn">
            <i class="fas fa-cog"></i> ç®¡ç†å‘˜æ§åˆ¶é¢ï¿½?          </button>
        </div>
        
        <div class="admin-controls" id="admin-controls" style="display: none;">
          <h4>ç®¡ç†å‘˜æ§åˆ¶é¢ï¿½?/h4>
          
          <!-- é€‰æ‰‹é€‰æ‹©åŒºåŸŸ -->
          <div class="player-selection">
            <h5>é€‰æ‹©å‚èµ›é€‰æ‰‹ï¼ˆå…±{{ tournament.player_count }}äººï¼‰</h5>
            
            <div id="player-selectors" class="player-selectors">
              <!-- æ ¹æ®èµ›äº‹å‚èµ›äººæ•°ç”Ÿæˆçš„é€‰æ‰‹é€‰æ‹©ï¿½?-->
              {% for i in range(1, tournament.player_count + 1) %}
                <div class="player-selector">
                  <label for="player-{{ i }}">é€‰æ‰‹{{ i }}ï¿½?/label>
                  <select id="player-{{ i }}" name="player-{{ i }}">
                    <option value="">è¯·é€‰æ‹©é€‰æ‰‹</option>
                    {% for player in participants %}
                      <option value="{{ player.player_id }}">{{ player.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              {% endfor %}
            </div>
            
            <div class="selection-actions">
              <button onclick="submitPlayerSelection()" class="btn btn-primary">ç¡®è®¤å‚èµ›é€‰æ‰‹</button>
              <button onclick="clearPlayerSelection()" class="btn btn-secondary">æ¸…ç©ºé€‰æ‹©</button>
            </div>
          </div>
          
          <!-- è‹è¶…èµ›åˆ¶ä¸»å®¢åœºé€‰æ‹©åŒºåŸŸ -->
          {% if tournament.t_format == 6 %}
          <div class="jiangsu-premier-league-selection" style="display: none;">
            <h5>ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿ è‹è¶…èµ›åˆ¶ä¸»å®¢åœºé€‰æ‹©</h5>
            <div class="alert alert-info">
              <p>è‹è¶…èµ›åˆ¶ï¼šæ¯ä¸ªé€‰æ‰‹éœ€è¦é€‰æ‹© <strong>{{ (tournament.player_count - 1) // 2 }}</strong> ä¸ªä¸»åœºå¯¹ï¿½?/p>
              <p>å‰©ä½™å¯¹æ‰‹å°†è‡ªåŠ¨å®‰æ’ä¸ºå®¢åœºï¼ˆè¯¥é€‰æ‰‹ä½œä¸ºé€‰æ‰‹2ï¿½?/p>
            </div>
            
            <div id="home-away-selectors" class="home-away-selectors">
              <!-- åŠ¨æ€ç”Ÿæˆä¸»å®¢åœºé€‰æ‹©ï¿½?-->
            </div>
            
            <div class="selection-actions">
              <button onclick="submitHomeAwaySelection()" class="btn btn-primary">ç¡®è®¤ä¸»å®¢åœºå®‰ï¿½?/button>
              <button onclick="clearHomeAwaySelection()" class="btn btn-secondary">æ¸…ç©ºé€‰æ‹©</button>
            </div>
          </div>
          {% endif %}
          
          <!-- åœºæ¬¡ç®¡ç†åŒºåŸŸ -->
          <div class="match-management" style="display: none;">
            <h5>åœºæ¬¡ç®¡ç†</h5>
            <div class="control-buttons">
              <button onclick="generateRoundRobinMatches()" class="btn btn-primary">
                {% if tournament.t_format == 4 %}ç”Ÿæˆå•å¾ªç¯èµ›åœºæ¬¡{% elif tournament.t_format == 5 %}ç”ŸæˆåŒå¾ªç¯èµ›åœºæ¬¡{% elif tournament.t_format == 6 %}ç”Ÿæˆè‹è¶…èµ›åˆ¶åœºæ¬¡{% else %}ç”Ÿæˆå¾ªç¯èµ›åœºæ¬¡{% endif %}
              </button>
              <button onclick="clearAllMatches()" class="btn btn-danger">æ¸…ç©ºæ‰€æœ‰åœºï¿½?/button>
            </div>
          </div>
          
          <!-- æ·˜æ±°èµ›ç®¡ç†åŒºï¿½?-->
          <div class="knockout-management" style="display: none;">
            <h5>æ·˜æ±°èµ›ç®¡ï¿½?/h5>
            <div class="alert alert-info">
              <p>å¾ªç¯èµ›å·²ç»“æŸï¼Œå¯ä»¥ç”ŸæˆåŠå†³èµ›èµ„æ ¼èµ›ï¿½?/p>
            </div>
            <div class="control-buttons">
              <button onclick="generateSemifinalQualifier()" class="btn btn-success">
                ğŸ¥ˆ ç”ŸæˆåŠå†³èµ›èµ„æ ¼èµ›
              </button>
            </div>
          </div>
        </div>
      {% endif %}
      
      <!-- å•å¾ªç¯èµ›ä½¿ç”¨ç»Ÿä¸€çš„group-sectionæ¨¡æ¿ -->
      {% if group_stage_data and group_stage_data.groups %}
        <!-- å°ç»„åˆ†é¡µå¯¼èˆª -->
        <div class="group-navigation">
          {% for group in group_stage_data.groups %}
            <button onclick="showGroup('{{ group.t_name }}')" class="group-btn {% if loop.first %}active{% endif %}" id="btn-{{ group.t_name }}">{{ group.t_name }}ï¿½?/button>
          {% endfor %}
        </div>
        
        <!-- å† äºšå­£å†›å±•ç¤ºï¼ˆä»…å°èµ›å†³èµ›å®Œæˆåæ˜¾ç¤ºï¼‰ -->
        {% if tournament.type == 2 and minor_knockout_data and minor_knockout_data.final_rankings %}
          {% set is_gold_completed = minor_knockout_data.gold_match and minor_knockout_data.gold_match.player_1_score is not none and minor_knockout_data.gold_match.player_2_score is not none and minor_knockout_data.gold_match.winner_id %}
          {% set is_bronze_completed = minor_knockout_data.bronze_match and minor_knockout_data.bronze_match.player_1_score is not none and minor_knockout_data.bronze_match.player_2_score is not none and minor_knockout_data.bronze_match.winner_id %}
          {% set finals_completed = is_gold_completed and is_bronze_completed %}
          {% if finals_completed %}
            <div class="group-section" style="display: none;">
              <div class="medal-podium">
                  <div class="podium-container">
                  <!-- å† å†› --> 
                  {% set gold_player = minor_knockout_data.final_rankings | selectattr('final_rank', 'equalto', 1) | first %}
                  {% if gold_player %}
                    <div class="podium-item gold-podium">
                      <!-- <div class="podium-rank">1</div> -->
                      <div class="podium-player">
                        <div class="medal-icon">ğŸ¥‡</div>
                        <div class="player-name">{{ gold_player.name }}</div>
                        <div class="medal-label">å† å†›</div>
                      </div>
                    </div>
                  {% endif %}

                  <!-- äºšå†› -->
                  {% set silver_player = minor_knockout_data.final_rankings | selectattr('final_rank', 'equalto', 2) | first %}
                  {% if silver_player %}
                    <div class="podium-item silver-podium">
                      <!-- <div class="podium-rank">2</div> -->
                      <div class="podium-player">
                        <div class="medal-icon">ğŸ¥ˆ</div>
                        <div class="player-name">{{ silver_player.name }}</div>
                        <div class="medal-label">äºšå†›</div>
                      </div>
                    </div>
                  {% endif %}
                  
                  
                  
                  <!-- å­£å†› -->
                  {% set bronze_player = minor_knockout_data.final_rankings | selectattr('final_rank', 'equalto', 3) | first %}
                  {% if bronze_player %}
                    <div class="podium-item bronze-podium">
                      <!-- <div class="podium-rank">3</div> -->
                      <div class="podium-player">
                        <div class="medal-icon">ğŸ¥‰</div>
                        <div class="player-name">{{ bronze_player.name }}</div>
                        <div class="medal-label">å­£å†›</div>
                      </div>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endif %}
        {% endif %}
    
        {% for group in group_stage_data.groups %}
          <div class="group-section" id="group-{{ group.t_name }}" {% if not loop.first %}style="display: none;"{% endif %}>
            <!-- <h4>{{ group.t_name }}</h4> -->
            
            
            <!-- æ’ååˆ‡æ¢å¼€ï¿½?-->
            <div class="ranking-switch-container">
              <label class="ranking-switch">
                <input type="checkbox" id="rankingToggle" {% if tournament.type == 2 and minor_knockout_data and minor_knockout_data.final_rankings %}checked{% endif %}>
                <span class="slider"></span>
              </label>
              <span class="switch-label" id="switchLabel">
                {% if tournament.type == 2 and minor_knockout_data and minor_knockout_data.final_rankings %}
                  {% set is_gold_completed = minor_knockout_data.gold_match and minor_knockout_data.gold_match.player_1_score is not none and minor_knockout_data.gold_match.player_2_score is not none and minor_knockout_data.gold_match.winner_id %}
                  {% set is_bronze_completed = minor_knockout_data.bronze_match and minor_knockout_data.bronze_match.player_1_score is not none and minor_knockout_data.bronze_match.player_2_score is not none and minor_knockout_data.bronze_match.winner_id %}
                  {% set finals_completed = is_gold_completed and is_bronze_completed %}
                  {% if finals_completed %}æ˜¾ç¤ºå¾ªç¯èµ›æ’å{% else %}æ˜¾ç¤ºæœ€ç»ˆæ€»æ’å{% endif %}
                {% else %}æ˜¾ç¤ºæœ€ç»ˆæ€»æ’å{% endif %}
              </span>
            </div>
            
            <!-- å¾ªç¯èµ›æ’åè¡¨ï¿½?-->
            <div class="group-ranking" id="roundRobinRanking" {% if tournament.type == 2 and minor_knockout_data and minor_knockout_data.final_rankings %}{% set is_gold_completed = minor_knockout_data.gold_match and minor_knockout_data.gold_match.player_1_score is not none and minor_knockout_data.gold_match.player_2_score is not none and minor_knockout_data.gold_match.winner_id %}{% set is_bronze_completed = minor_knockout_data.bronze_match and minor_knockout_data.bronze_match.player_1_score is not none and minor_knockout_data.bronze_match.player_2_score is not none and minor_knockout_data.bronze_match.winner_id %}{% set finals_completed = is_gold_completed and is_bronze_completed %}{% if finals_completed %}style="display: none;"{% endif %}{% endif %}>
              <h5>å¾ªç¯èµ›æ’ï¿½?/h5>
              <!-- æ¡Œé¢ç«¯æ’åè¡¨ï¿½?-->
              <div class="desktop-ranking">
                <table class="table table-striped group-table">
                <thead>
                  <tr>
                    <th>æ’å</th>
                    <th>é€‰æ‰‹</th>
                    <th>åœºæ¬¡</th>
                    <th>ï¿½?/th>
                    <th>ï¿½?/th>
                    <th>ï¿½?/th>
                    <th>æ€»å¾—ï¿½?/th>
                    <th>æ€»å¤±ï¿½?/th>
                    <th>å‡€èƒœåˆ†</th>
                    <th>ç§¯åˆ†</th>
                  </tr>
                </thead>
                <tbody>
                    {% for player in group.players %}
                      <tr class="{% if tournament.type == 2 and tournament.type_session_number == 1 and tournament.t_format in [4, 5, 6] and player.group_rank <= 6 %}top6{% elif tournament.type == 2 and tournament.type_session_number >= 2 and tournament.t_format in [4, 5, 6] and player.group_rank in [3, 4] %}top6{% elif tournament.t_format in [4, 5, 6] and player.group_rank <= 2 %}top2{% elif tournament.t_format in [4, 5, 6] and player.group_rank <= 6 %}top6{% endif %}">
                        <td>
                          <strong>{{ player.group_rank }}</strong>
                        </td>
                        <td>
                          <a href="/player/{{ player.player_id }}">{{ player.name }}</a>
                        </td>
                        <td style="{% if player.total_matches == player.wins + player.draws + player.losses %}background-color: rgba(205,255,155,0.75); font-weight: bold;{% endif %}">
                          {{ player.wins + player.draws + player.losses }}
                        </td>
                        <td>{{ player.wins }}</td>
                        <td>{{ player.draws }}</td>
                        <td>{{ player.losses }}</td>
                        <td>{{ player.goals_for }}</td>
                        <td>{{ player.goals_against }}</td>
                        <td>{{ player.goal_difference }}</td>
                        <td style="font-weight: bold;">{{ player.points }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
              
              <!-- ç§»åŠ¨ç«¯æ’åå¡ï¿½?-->
              <div class="mobile-ranking">
                {% for player in group.players %}
                  <div class="player-card {% if tournament.type == 2 and tournament.type_session_number == 1 and tournament.t_format in [4, 5, 6] and player.group_rank <= 6 %}top6{% elif tournament.type == 2 and tournament.type_session_number >= 2 and tournament.t_format in [4, 5, 6] and player.group_rank in [3, 4] %}top6{% elif tournament.t_format in [4, 5, 6] and player.group_rank <= 2 %}top2{% elif tournament.t_format in [4, 5, 6] and player.group_rank <= 6 %}top6{% endif %}">
                    <div class="card-header">
                      <div class="rank-info">
                        <span class="rank-number">{{ player.group_rank }}</span>
                      </div>
                      <div class="player-info">
                        <h4 class="player-name">
                          <a href="/player/{{ player.player_id }}">{{ player.name }}</a>
                        </h4>
                        <div class="points-display">{{ player.points }} ï¿½?/div>
                      </div>
                    </div>
                    <div class="card-stats">
                      <div class="stat-item">
                        <span class="stat-label">ï¿½?/span>
                        <span class="stat-value wins">{{ player.wins }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">ï¿½?/span>
                        <span class="stat-value draws">{{ player.draws }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">ï¿½?/span>
                        <span class="stat-value losses">{{ player.losses }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">å‡€èƒœåˆ†</span>
                        <span class="stat-value goal-diff">{{ player.goal_difference }}</span>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
            
            <!-- æœ€ç»ˆæ€»æ’åè¡¨æ ¼ï¼ˆä»…å°èµ›ä¸”å†³èµ›å®Œæˆåæ˜¾ç¤ºï¼‰ -->
            {% if tournament.type == 2 and minor_knockout_data and minor_knockout_data.final_rankings %}
              {% set is_gold_completed = minor_knockout_data.gold_match and minor_knockout_data.gold_match.player_1_score is not none and minor_knockout_data.gold_match.player_2_score is not none and minor_knockout_data.gold_match.winner_id %}
              {% set is_bronze_completed = minor_knockout_data.bronze_match and minor_knockout_data.bronze_match.player_1_score is not none and minor_knockout_data.bronze_match.player_2_score is not none and minor_knockout_data.bronze_match.winner_id %}
              {% set finals_completed = is_gold_completed and is_bronze_completed %}
              
              {% if finals_completed %}
                <div class="group-ranking final-ranking" id="finalRanking">
                  <h5>ğŸ† æœ€ç»ˆæ€»æ’ï¿½?/h5>
                  <!-- æ¡Œé¢ç«¯æœ€ç»ˆæ’åè¡¨ï¿½?-->
                  <div class="desktop-ranking">
                    <table class="table table-striped group-table">
                    <thead>
                      <tr>
                        <th>æ’å</th>
                        <th>é€‰æ‰‹</th>
                        <th>åœºæ¬¡</th>
                        <th>ï¿½?/th>
                        <th>ï¿½?/th>
                        <th>ï¿½?/th>
                        <th>æ€»å¾—ï¿½?/th>
                        <th>æ€»å¤±ï¿½?/th>
                        <th>å‡€èƒœåˆ†</th>
                        <th>ç§¯åˆ†</th>
                        <!-- <th>å¥–ç‰Œ</th> -->
                      </tr>
                    </thead>
                    <tbody>
                        {% for player in minor_knockout_data.final_rankings %}
                          {% set final_rank = player.final_rank or player.rank %}
                          <tr class="medal-row {% if final_rank == 1 %}gold-medal{% elif final_rank == 2 %}silver-medal{% elif final_rank == 3 %}bronze-medal{% elif final_rank == 4 %}fourth-place{% endif %}">
                            <td>
                              <!-- <span class="medal-icon">
                                {% if final_rank == 1 %}ğŸ¥‡{% elif final_rank == 2 %}ğŸ¥ˆ{% elif final_rank == 3 %}ğŸ¥‰{% elif final_rank == 4 %}ğŸ…{% endif %}
                              </span> -->
                              
                              {% if final_rank == 1 %}
                              <span class="medal-icon">ğŸ¥‡</span>
                              {% elif final_rank == 2 %}
                              <span class="medal-icon">ğŸ¥ˆ</span>
                              {% elif final_rank == 3 %}
                              <span class="medal-icon">ğŸ¥‰</span>
                              {% elif final_rank == 4 %}
                              <span class="medal-icon">ğŸ…</span>
                              {% else %}
                              <strong>{{ final_rank }}</strong>
                              {% endif %}
                            </td>
                            <td>
                              <a href="/player/{{ player.player_id }}">{{ player.name }}</a>
                              <!-- <span class="medal-label">
                                {% if final_rank == 1 %}å† å†›{% elif final_rank == 2 %}äºšå†›{% elif final_rank == 3 %}å­£å†›{% elif final_rank == 4 %}æ®¿å†›{% endif %}
                              </span> -->
                            </td>
                            <td>{{ player.wins + player.draws + player.losses }}</td>
                            <td>{{ player.wins }}</td>
                            <td>{{ player.draws }}</td>
                            <td>{{ player.losses }}</td>
                            <td>{{ player.goals_for }}</td>
                            <td>{{ player.goals_against }}</td>
                            <td>{{ player.goal_difference }}</td>
                            <td style="font-weight: bold;">{{ player.final_points or player.points }}</td>
                            <!-- <td>
                              <span class="medal-badge">
                                {% if final_rank == 1 %}ğŸ¥‡ å† å†›{% elif final_rank == 2 %}ğŸ¥ˆ äºšå†›{% elif final_rank == 3 %}ğŸ¥‰ å­£å†›{% elif final_rank == 4 %}ğŸ… æ®¿å†›{% endif %}
                              </span>
                            </td> -->
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                  
                <!-- ç§»åŠ¨ç«¯æœ€ç»ˆæ’åå¡ï¿½?-->
                <div class="mobile-ranking" style="text-align: center;">
                  {% for player in minor_knockout_data.final_rankings %}
                    {% set final_rank = player.final_rank or player.rank %}
                    <div class="player-card medal-card {% if final_rank == 1 %}gold-card{% elif final_rank == 2 %}silver-card{% elif final_rank == 3 %}bronze-card{% elif final_rank == 4 %}fourth-card{% endif %}">
                      <div class="card-header">
                        <div class="rank-info">
                          <!-- <span class="rank-number">{{ final_rank }}</span> -->
                          <!-- <span class="medal-icon">
                            {% if final_rank == 1 %}ğŸ¥‡{% elif final_rank == 2 %}ğŸ¥ˆ{% elif final_rank == 3 %}ğŸ¥‰{% elif final_rank == 4 %}ğŸ…{% endif %}
                          </span> -->
                          {% if final_rank == 1 %}
                          <span class="medal-icon">ğŸ¥‡</span>
                          {% elif final_rank == 2 %}
                          <span class="medal-icon">ğŸ¥ˆ</span>
                          {% elif final_rank == 3 %}
                          <span class="medal-icon">ğŸ¥‰</span>
                          {% elif final_rank == 4 %}
                          <span class="medal-icon">ğŸ…</span>
                          {% else %}
                          <span class="rank-number">{{ final_rank }}</span>
                          {% endif %}
                        </div>
                        <div class="player-info">
                          <h4 class="player-name">
                            <a href="/player/{{ player.player_id }}">{{ player.name }}</a>
                            <!-- <span class="medal-label">
                              {% if final_rank == 1 %}å† å†›{% elif final_rank == 2 %}äºšå†›{% elif final_rank == 3 %}å­£å†›{% elif final_rank == 4 %}æ®¿å†›{% endif %}
                            </span> -->
                          </h4>
                          <div class="points-display">{{ player.final_points or player.points }} ï¿½?/div>
                        </div>
                      </div>
                      <div class="card-stats">
                        <div class="stat-item">
                          <span class="stat-label">ï¿½?/span>
                          <span class="stat-value wins">{{ player.wins }}</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label">ï¿½?/span>
                          <span class="stat-value draws">{{ player.draws }}</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label">ï¿½?/span>
                          <span class="stat-value losses">{{ player.losses }}</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label">å‡€èƒœåˆ†</span>
                          <span class="stat-value goal-diff">{{ player.goal_difference }}</span>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          {% endif %}
        
            <!-- ç»„å†…ç­›é€‰å™¨ -->
            <div class="group-filter">
              <div class="filter-controls">
                <div class="filter-group">
                  <label for="filter-status-{{ group.t_name }}">æ¯”èµ›çŠ¶æ€ï¼š</label>
                  <select id="filter-status-{{ group.t_name }}" class="filter-select">
                    <option value="">å…¨éƒ¨çŠ¶ï¿½?/option>
                    <option value="completed">å·²å®Œï¿½?/option>
                    <option value="pending">æœªå¼€ï¿½?/option>
                  </select>
                </div>
                
                <div class="filter-group">
                  <label for="filter-player-{{ group.t_name }}">é€‰æ‰‹ï¿½?/label>
                  <select id="filter-player-{{ group.t_name }}" class="filter-select">
                    <option value="">å…¨éƒ¨é€‰æ‰‹</option>
                    {% for player in group.players %}
                      <option value="{{ player.name }}">{{ player.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                
                <div class="filter-actions">
                  <button onclick="clearGroupFilters('{{ group.t_name }}')" class="btn btn-secondary">æ¸…ç©ºç­›ï¿½?/button>
                  <button onclick="applyGroupFilters('{{ group.t_name }}')" class="btn btn-primary">åº”ç”¨ç­›ï¿½?/button>
                </div>
              </div>
            </div>
            <!-- æ¯”èµ›ç»“æœï¼ˆä½¿ç”¨å¤§èµ›æ¨¡æ¿ï¼‰ -->
            <div class="group-matches">
              <h5>å•å¾ªç¯æ¯”ï¿½?/h5>
              <div class="matches-grid">
                {% for match in group.matches %}
                <div class="match-card" 
                data-group="{{ group.t_name }}" 
                data-player1="{{ match.player1.name }}" 
                data-player2="{{ match.player2.name }}"
                data-status="{% if match.player_1_score is not none and match.player_2_score is not none and not (match.player_1_score == 0 and match.player_2_score == 0) %}completed{% else %}pending{% endif %}"
                data-group-name="{{ group.t_name }}">
                  <div class="match-header">
                    <span class="match-title">{% if match.m_type == 14 %}é™„åŠ èµ›{% else %}ç¬¬{{ loop.index }}åœº{% endif %}</span>
                  </div>
                  <div class="match-players">
                    <div class="player-info">
                      <span class="player-name">{{ match.player1.name }}</span>
                      {% if match.m_type == 2 %}
                        <span class="home-away-tag home">ï¿½?/span>
                      {% elif match.m_type == 3 %}
                        <span class="home-away-tag away">ï¿½?/span>
                      {% endif %}
                      <div class="score-display">
                        {% if match.player_1_score is not none and match.player_2_score is not none and match.player_1_score >= 0 and match.player_2_score >= 0 %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                    data-match-id="{{ match.m_id }}" data-player="1" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}">
                          {% else %}
                            <span class="score {% if match.player_1_score > match.player_2_score %}winner_1{% elif match.player_1_score == match.player_2_score and match.player_1_score > 0 %}tier_1{% endif %}">{{ match.player_1_score }}</span>
                          {% endif %}
                        {% else %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                    data-match-id="{{ match.m_id }}" data-player="1" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}">
                          {% else %}
                            <span class="score">-</span>
                          {% endif %}
                        {% endif %}
                      </div>
                    </div>
                    <div class="vs-divider">VS</div>
                    <div class="player-info">
                      <span class="player-name">{{ match.player2.name }}</span>
                      {% if match.m_type == 2 %}
                        <span class="home-away-tag away">ï¿½?/span>
                      {% elif match.m_type == 3 %}
                        <span class="home-away-tag home">ï¿½?/span>
                      {% endif %}
                      <div class="score-display">
                        {% if match.player_1_score is not none and match.player_2_score is not none and match.player_1_score >= 0 and match.player_2_score >= 0 %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                    data-match-id="{{ match.m_id }}" data-player="2" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}">
                          {% else %}
                            <span class="score {% if match.player_2_score > match.player_1_score %}winner_2{% elif match.player_2_score == match.player_1_score and match.player_2_score > 0 %}tier_2{% endif %}">{{ match.player_2_score }}</span>
                          {% endif %}
                        {% else %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                    data-match-id="{{ match.m_id }}" data-player="2" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}">
                          {% else %}
                            <span class="score">-</span>
                          {% endif %}
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% if session.get('admin_logged_in') %}
                    <div class="match-actions">
                      <button class="btn btn-sm btn-primary" onclick="submitScore({{ match.m_id }})">
                        {% if match.player_1_score is not none and match.player_2_score is not none and match.player_1_score >= 0 and match.player_2_score >= 0 %}
                          æ›´æ–°
                        {% else %}
                          æäº¤
                        {% endif %}
                      </button>
                    </div>
                  {% else %}
                    {% if match.player_1_score is not none and match.player_2_score is not none %}
                      <!-- <div class="match-result">
                        {% if match.player_1_score > match.player_2_score %}
                          <span class="winner">{{ match.player1.name }} è·èƒœ</span>
                        {% elif match.player_2_score > match.player_1_score %}
                          <span class="winner">{{ match.player2.name }} è·èƒœ</span>
                        {% else %}
                          <span class="draw">å¹³å±€</span>
                        {% endif %}
                      </div> -->
                    {% endif %}
                  {% endif %}
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endfor %}
      {% endif %}
      
      <!-- å°èµ›æ‰‹åŠ¨ç”Ÿæˆé‡‘ç‰Œèµ›å’Œé“œç‰Œèµ›æŒ‰ï¿½?-->
      {% if tournament.type == 2 and session.get('admin_logged_in') and not minor_knockout_data %}
        <div class="group-section">
          <div class="admin-controls">
            <h4>å†³èµ›ç®¡ç†</h4>
            <div class="alert alert-info">
              <p>å¾ªç¯èµ›å·²ç»“æŸï¼Œå¯ä»¥ç”Ÿæˆé‡‘ç‰Œèµ›å’Œé“œç‰Œèµ›å¯¹é˜µï¿½?/p>
            </div>
            <div class="control-buttons">
              <button onclick="generateMinorTournamentFinals()" class="btn btn-primary">
                ğŸ† ç”Ÿæˆé‡‘ç‰Œèµ›å’Œé“œç‰Œï¿½?              </button>
            </div>
          </div>
        </div>
      {% endif %}
      
      <!-- è‹è¶…èµ›åˆ¶æ·˜æ±°èµ›é€‰æ‹© -->
      {% if tournament.t_format == 6 and session.get('admin_logged_in') %}
        <div class="group-section">
          <div class="admin-controls">
            <h4>ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿ è‹è¶…èµ›åˆ¶æ·˜æ±°èµ›ç®¡ï¿½?/h4>
            <div class="alert alert-info">
              <p>è‹è¶…èµ›åˆ¶å¾ªç¯èµ›å·²ç»“æŸï¼Œè¯·é€‰æ‹©æ·˜æ±°èµ›æ¨¡å¼ï¼š</p>
            </div>
            <div class="control-buttons">
              <button onclick="generateJiangsuPremierLeagueFinals()" class="btn btn-primary">
                ğŸ† ç›´æ¥ç”Ÿæˆé‡‘ç‰Œèµ›å’Œé“œç‰Œï¿½?              </button>
              <button onclick="generateJiangsuPremierLeagueSemifinals()" class="btn btn-success">
                ğŸ¥ˆ ç”ŸæˆåŠå†³èµ›èµ„æ ¼èµ›
              </button>
            </div>
          </div>
        </div>
      {% endif %}
      
      
      <!-- å†³èµ›ï¼ˆä»…å°èµ›æ˜¾ç¤ºï¿½?-->
      {% if tournament.type == 2 and minor_knockout_data and (minor_knockout_data.gold_match or minor_knockout_data.bronze_match) %}
        <div class="group-section">
          <!-- <h4>å†³èµ›</h4> -->
          
          <!-- é‡‘ç‰Œï¿½?-->
          {% if minor_knockout_data.gold_match %}
            <div class="group-matches">
              <!-- <h5>ğŸ¥‡ é‡‘ç‰Œï¿½?/h5> -->
              <div class="matches-grid">
                <div class="match-card gold-medal-match" 
                     data-group="å†³èµ›" 
                     data-player1="{{ minor_knockout_data.gold_match.player_1_name }}" 
                     data-player2="{{ minor_knockout_data.gold_match.player_2_name }}"
                     data-status="{% if minor_knockout_data.gold_match.player_1_score is not none and minor_knockout_data.gold_match.player_2_score is not none %}completed{% else %}pending{% endif %}"
                     data-group-name="å†³èµ›">
                  <div class="match-header">
                    <span class="match-title">é‡‘ç‰Œï¿½?/span>
                  </div>
                  <div class="match-players">
                    <div class="player-info">
                      <span class="player-name">{{ minor_knockout_data.gold_match.player_1_name }}</span>
                      <div class="score-display">
                        {% if minor_knockout_data.gold_match.player_1_score is not none and minor_knockout_data.gold_match.player_2_score is not none %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                   data-match-id="{{ minor_knockout_data.gold_match.m_id }}" data-player="1" 
                                   value="{{ minor_knockout_data.gold_match.player_1_score or '' }}">
                          {% else %}
                            <span class="score {% if minor_knockout_data.gold_match.player_1_score > minor_knockout_data.gold_match.player_2_score %}winner_1{% elif minor_knockout_data.gold_match.player_1_score == minor_knockout_data.gold_match.player_2_score and minor_knockout_data.gold_match.player_1_score > 0 %}tier_1{% endif %}">{{ minor_knockout_data.gold_match.player_1_score }}</span>
                          {% endif %}
                        {% else %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                   data-match-id="{{ minor_knockout_data.gold_match.m_id }}" data-player="1">
                          {% else %}
                            <span class="score">-</span>
                          {% endif %}
                        {% endif %}
                      </div>
                    </div>
                    <div class="vs-divider">VS</div>
                    <div class="player-info">
                      <span class="player-name">{{ minor_knockout_data.gold_match.player_2_name }}</span>
                      <div class="score-display">
                        {% if minor_knockout_data.gold_match.player_1_score is not none and minor_knockout_data.gold_match.player_2_score is not none %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                   data-match-id="{{ minor_knockout_data.gold_match.m_id }}" data-player="2" 
                                   value="{{ minor_knockout_data.gold_match.player_2_score or '' }}">
                          {% else %}
                            <span class="score {% if minor_knockout_data.gold_match.player_2_score > minor_knockout_data.gold_match.player_1_score %}winner_2{% elif minor_knockout_data.gold_match.player_1_score == minor_knockout_data.gold_match.player_2_score and minor_knockout_data.gold_match.player_2_score > 0 %}tier_2{% endif %}">{{ minor_knockout_data.gold_match.player_2_score }}</span>
                          {% endif %}
                        {% else %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                   data-match-id="{{ minor_knockout_data.gold_match.m_id }}" data-player="2">
                          {% else %}
                            <span class="score">-</span>
                          {% endif %}
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% if session.get('admin_logged_in') %}
                    <div class="match-actions">
                      <button class="btn btn-sm btn-primary" onclick="submitScore({{ minor_knockout_data.gold_match.m_id }})">
                        {% if minor_knockout_data.gold_match.player_1_score is not none and minor_knockout_data.gold_match.player_2_score is not none %}
                          æ›´æ–°
                        {% else %}
                          æäº¤
                        {% endif %}
                      </button>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endif %}
          
          <!-- é“œç‰Œï¿½?-->
          <!-- {% if minor_knockout_data.bronze_match %}
            <div class="group-matches">
              <h5>ğŸ¥‰ é“œç‰Œï¿½?/h5>
              <div class="matches-grid">
                <div class="match-card bronze-match" style="border: 2px solid #cd7f32; background-color: #fdf5e6;">
                  <div class="match-header">
                    <span class="match-title">é“œç‰Œï¿½?/span>
                  </div>
                  <div class="match-players">
                <div class="player-info">
                  <span class="player-name">{{ minor_knockout_data.bronze_match.player1_name }}</span>
                  {% if session.get('admin_logged_in') %}
                    <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                           data-match-id="{{ minor_knockout_data.bronze_match.m_id }}" data-player="1" 
                           value="{{ minor_knockout_data.bronze_match.player_1_score or '' }}">
                  {% else %}
                    <span class="score">{{ minor_knockout_data.bronze_match.player_1_score or '-' }}</span>
                  {% endif %}
                </div>
                <div class="vs-divider">VS</div>
                <div class="player-info">
                  <span class="player-name">{{ minor_knockout_data.bronze_match.player2_name }}</span>
                  {% if session.get('admin_logged_in') %}
                    <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                           data-match-id="{{ minor_knockout_data.bronze_match.m_id }}" data-player="2" 
                           value="{{ minor_knockout_data.bronze_match.player_2_score or '' }}">
                  {% else %}
                    <span class="score">{{ minor_knockout_data.bronze_match.player_2_score or '-' }}</span>
                  {% endif %}
                </div>
              </div>
              {% if session.get('admin_logged_in') %}
                    <div class="match-actions">
                  <button class="btn btn-sm btn-primary" onclick="submitScore({{ minor_knockout_data.bronze_match.m_id }})">
                    {% if minor_knockout_data.bronze_match.player_1_score is not none and minor_knockout_data.bronze_match.player_2_score is not none %}
                      æ›´æ–°
                    {% else %}
                      æäº¤
                    {% endif %}
                  </button>
                </div>
              {% endif %}
            </div>
          {% endif %} -->
          
          <!-- é“œç‰Œï¿½?-->
          {% if minor_knockout_data.bronze_match %}
            <div class="group-matches">
              <!-- <h5>ğŸ¥‰ é“œç‰Œï¿½?/h5> -->
              <div class="matches-grid">
                <div class="match-card bronze-medal-match" 
                     data-group="å†³èµ›" 
                     data-player1="{{ minor_knockout_data.bronze_match.player_1_name }}" 
                     data-player2="{{ minor_knockout_data.bronze_match.player_2_name }}"
                     data-status="{% if minor_knockout_data.bronze_match.player_1_score is not none and minor_knockout_data.bronze_match.player_2_score is not none %}completed{% else %}pending{% endif %}"
                     data-group-name="å†³èµ›">
                  <div class="match-header">
                    <span class="match-title">é“œç‰Œï¿½?/span>
                  </div>
                  <div class="match-players">
                    <div class="player-info">
                      <span class="player-name">{{ minor_knockout_data.bronze_match.player_1_name }}</span>
                      <div class="score-display">
                        {% if minor_knockout_data.bronze_match.player_1_score is not none and minor_knockout_data.bronze_match.player_2_score is not none %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                   data-match-id="{{ minor_knockout_data.bronze_match.m_id }}" data-player="1" 
                                   value="{{ minor_knockout_data.bronze_match.player_1_score or '' }}">
                          {% else %}
                            <span class="score {% if minor_knockout_data.bronze_match.player_1_score > minor_knockout_data.bronze_match.player_2_score %}winner_1{% elif minor_knockout_data.bronze_match.player_1_score == minor_knockout_data.bronze_match.player_2_score and minor_knockout_data.bronze_match.player_1_score > 0 %}tier_1{% endif %}">{{ minor_knockout_data.bronze_match.player_1_score }}</span>
                          {% endif %}
                        {% else %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                   data-match-id="{{ minor_knockout_data.bronze_match.m_id }}" data-player="1">
                          {% else %}
                            <span class="score">-</span>
                          {% endif %}
                        {% endif %}
                      </div>
                    </div>
                    <div class="vs-divider">VS</div>
                    <div class="player-info">
                      <span class="player-name">{{ minor_knockout_data.bronze_match.player_2_name }}</span>
                      <div class="score-display">
                        {% if minor_knockout_data.bronze_match.player_1_score is not none and minor_knockout_data.bronze_match.player_2_score is not none %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                   data-match-id="{{ minor_knockout_data.bronze_match.m_id }}" data-player="2" 
                                   value="{{ minor_knockout_data.bronze_match.player_2_score or '' }}">
                          {% else %}
                            <span class="score {% if minor_knockout_data.bronze_match.player_2_score > minor_knockout_data.bronze_match.player_1_score %}winner_2{% elif minor_knockout_data.bronze_match.player_1_score == minor_knockout_data.bronze_match.player_2_score and minor_knockout_data.bronze_match.player_2_score > 0 %}tier_2{% endif %}">{{ minor_knockout_data.bronze_match.player_2_score }}</span>
                          {% endif %}
                        {% else %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                   data-match-id="{{ minor_knockout_data.bronze_match.m_id }}" data-player="2">
                          {% else %}
                            <span class="score">-</span>
                          {% endif %}
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% if session.get('admin_logged_in') %}
                    <div class="match-actions">
                      <button class="btn btn-sm btn-primary" onclick="submitScore({{ minor_knockout_data.bronze_match.m_id }})">
                        {% if minor_knockout_data.bronze_match.player_1_score is not none and minor_knockout_data.bronze_match.player_2_score is not none %}
                          æ›´æ–°
                        {% else %}
                          æäº¤
                        {% endif %}
                      </button>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      {% endif %}
    {% endif %}
  </div>

  <!-- æ·˜æ±°èµ›é¡µï¿½?-->
  <div id="page-knockout" class="page-content">
    <!-- <h3>æ·˜æ±°ï¿½?/h3> -->
    
    {% if tournament.t_format in [1, 3] %}
      <div class="knockout-management" id="knockout-management">
        <h4 style="margin-top: 0; color: #495057;">æ·˜æ±°èµ›ç®¡ï¿½?/h4>
        
        <!-- 1/4å†³èµ›ç®¡ç† -->
        <div class="knockout-module">
          <h5 style="color: #495057;">1/4å†³èµ›</h5>
          
          <!-- 1/4å†³èµ›ç±»å‹é€‰æ‹© -->
          <div class="quarterfinal-type-options">
            <h6>1/4å†³èµ›ç±»å‹</h6>
            <div class="quarterfinal-type-group">
              <div class="quarterfinal-type-option" onclick="selectQuarterfinalType('direct')">
                <input type="radio" name="quarterfinal-type" value="direct" id="quarterfinal-direct">
                <label for="quarterfinal-direct">ç›´æ¥æ¨¡å¼</label>
          </div>
              <div class="quarterfinal-type-option" onclick="selectQuarterfinalType('qualifier')">
                <input type="radio" name="quarterfinal-type" value="qualifier" id="quarterfinal-qualifier">
                <label for="quarterfinal-qualifier">èµ„æ ¼èµ›æ¨¡ï¿½?/label>
              </div>
              <div class="quarterfinal-type-option" onclick="selectQuarterfinalType('manual')">
                <input type="radio" name="quarterfinal-type" value="manual" id="quarterfinal-manual">
                <label for="quarterfinal-manual">æ‰‹åŠ¨æŒ‡å®šä½æ¬¡</label>
              </div>
              <div class="quarterfinal-type-option" onclick="selectQuarterfinalType('random')">
                <input type="radio" name="quarterfinal-type" value="random" id="quarterfinal-random">
                <label for="quarterfinal-random">éšæœºä½æ¬¡</label>
              </div>
            </div>
            
            <!-- éšæœºä½æ¬¡å­é€‰é¡¹ -->
            <div id="random-sub-options" style="display: none;">
              <div class="random-sub-group">
                <div class="random-sub-option" onclick="selectRandomSubOption('avoid')">
                  <input type="radio" name="random-sub-option" value="avoid" id="random-avoid">
                  <label for="random-avoid">å›é¿åŒç»„</label>
                </div>
                <div class="random-sub-option" onclick="selectRandomSubOption('allow')">
                  <input type="radio" name="random-sub-option" value="allow" id="random-allow">
                  <label for="random-allow">ä¸å›é¿åŒï¿½?/label>
                </div>
              </div>
            </div>
          </div>
          <!-- æ‰‹åŠ¨æŒ‡å®šä½æ¬¡é€‰æ‹©ç•Œé¢ -->
          <div id="manual-position-selection" style="display: none;">
            <h6>æ‰‹åŠ¨æŒ‡å®šä½æ¬¡</h6>
            <div class="position-selection-grid">
              <div class="position-slot">
                <label>1</label>
                <select id="position-1" class="form-control">
                  <option value="">é€‰æ‹©é€‰æ‰‹</option>
                </select>
              </div>
              <div class="position-slot">
                <label>2</label>
                <select id="position-2" class="form-control">
                  <option value="">é€‰æ‹©é€‰æ‰‹</option>
                </select>
              </div>
              <div class="position-slot">
                <label>3</label>
                <select id="position-3" class="form-control">
                  <option value="">é€‰æ‹©é€‰æ‰‹</option>
                </select>
              </div>
              <div class="position-slot">
                <label>4</label>
                <select id="position-4" class="form-control">
                  <option value="">é€‰æ‹©é€‰æ‰‹</option>
                </select>
              </div>
              <div class="position-slot">
                <label>5</label>
                <select id="position-5" class="form-control">
                  <option value="">é€‰æ‹©é€‰æ‰‹</option>
                </select>
              </div>
              <div class="position-slot">
                <label>6</label>
                <select id="position-6" class="form-control">
                  <option value="">é€‰æ‹©é€‰æ‰‹</option>
                </select>
              </div>
              <div class="position-slot">
                <label>7</label>
                <select id="position-7" class="form-control">
                  <option value="">é€‰æ‹©é€‰æ‰‹</option>
                </select>
              </div>
              <div class="position-slot">
                <label>8</label>
                <select id="position-8" class="form-control">
                  <option value="">é€‰æ‹©é€‰æ‰‹</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="module-actions" style="display: none;">
            <button onclick="generateQuarterfinal()" class="btn btn-primary">ç”Ÿæˆ1/4å†³èµ›</button>
            <button onclick="updateKnockout()" class="btn btn-secondary">æ›´æ–°æ·˜æ±°ï¿½?/button>
          </div>
          <div class="module-status"></div>
        </div>
      </div>
    {% else %}
      <div class="alert alert-info">
        <h4>æ­¤èµ›äº‹ä¸æ”¯æŒæ·˜æ±°èµ›æ¨¡ï¿½?/h4>
        <p>åªæœ‰"å°ç»„ï¿½?1/4å†³èµ›"ï¿½?å°ç»„ï¿½?åŠå†³èµ›èµ„æ ¼èµ›"æ ¼å¼çš„èµ›äº‹æ‰æ”¯æŒæ·˜æ±°èµ›åŠŸèƒ½ï¿½?/p>
      </div>
    {% endif %}
    
    <!-- æ·˜æ±°èµ›æ ‘å½¢å¸ƒå±€æ˜¾ç¤º -->
    {% set knockout_matches = [] %}
    {% for match in matches %}
      {% if match.m_type in [8, 9, 10, 11, 12, 13] %}
        {% set _ = knockout_matches.append(match) %}
      {% endif %}
    {% endfor %}
    
    <!-- æ·˜æ±°èµ›ç½‘æ ¼å¸ƒå±€æ˜¾ç¤º -->
    
    {% if knockout_matches %}
      <div class="knockout-grid-container">
        <h4 style="color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px;">æ·˜æ±°èµ›å¯¹ï¿½?/h4>
        
        <!-- æ»‘åŠ¨å¯¼èˆªï¼ˆä»…åœ¨çª„å±æ—¶æ˜¾ç¤ºï¿½?-->
        <div class="sliding-nav" style="display: none;">
          <button class="slide-btn prev" onclick="slideKnockoutGrid(-1)">ï¿½?/button>
          <div class="slide-indicators">
            {% set semifinal_qualifier_matches = knockout_matches|selectattr('m_type', 'equalto', 9)|list %}
            {% set quarterfinal_matches = knockout_matches|selectattr('m_type', 'equalto', 8)|list %}
            {% set semifinal_matches = knockout_matches|selectattr('m_type', 'equalto', 10)|list %}
            {% set gold_matches = knockout_matches|selectattr('m_type', 'equalto', 11)|list %}
            {% set bronze_matches = knockout_matches|selectattr('m_type', 'equalto', 12)|list %}
            
            {% if semifinal_qualifier_matches %}
              <span class="slide-indicator active" data-slide="0" onclick="goToSlide(0)">åŠå†³èµ›èµ„æ ¼èµ›</span>
            {% endif %}
            
            {% if quarterfinal_matches %}
              <span class="slide-indicator {% if not semifinal_qualifier_matches %}active{% endif %}" 
                    data-slide="{% if semifinal_qualifier_matches %}1{% else %}0{% endif %}" 
                    onclick="goToSlide({% if semifinal_qualifier_matches %}1{% else %}0{% endif %})">1/4å†³èµ›</span>
            {% endif %}
            
            {% if semifinal_matches %}
              <span class="slide-indicator {% if not semifinal_qualifier_matches and not quarterfinal_matches %}active{% endif %}" 
                    data-slide="{% if semifinal_qualifier_matches and quarterfinal_matches %}2{% elif semifinal_qualifier_matches or quarterfinal_matches %}1{% else %}0{% endif %}" 
                    onclick="goToSlide({% if semifinal_qualifier_matches and quarterfinal_matches %}2{% elif semifinal_qualifier_matches or quarterfinal_matches %}1{% else %}0{% endif %})">åŠå†³ï¿½?/span>
            {% endif %}
            
            {% if gold_matches or bronze_matches %}
              <span class="slide-indicator {% if not semifinal_qualifier_matches and not quarterfinal_matches and not semifinal_matches %}active{% endif %}" 
                    data-slide="{% if semifinal_qualifier_matches and quarterfinal_matches and semifinal_matches %}3{% elif (semifinal_qualifier_matches and quarterfinal_matches) or (semifinal_qualifier_matches and semifinal_matches) or (quarterfinal_matches and semifinal_matches) %}2{% elif semifinal_qualifier_matches or quarterfinal_matches or semifinal_matches %}1{% else %}0{% endif %}" 
                    onclick="goToSlide({% if semifinal_qualifier_matches and quarterfinal_matches and semifinal_matches %}3{% elif (semifinal_qualifier_matches and quarterfinal_matches) or (semifinal_qualifier_matches and semifinal_matches) or (quarterfinal_matches and semifinal_matches) %}2{% elif semifinal_qualifier_matches or quarterfinal_matches or semifinal_matches %}1{% else %}0{% endif %})">å†³èµ›</span>
            {% endif %}
          </div>
          <button class="slide-btn next" onclick="slideKnockoutGrid(1)">ï¿½?/button>
        </div>
        
        <div class="knockout-grid">
          <!-- åŠå†³èµ›èµ„æ ¼èµ›è½®æ¬¡ -->
          {% set semifinal_qualifier_matches = knockout_matches|selectattr('m_type', 'equalto', 9)|list %}
          {% if semifinal_qualifier_matches %}
              {% for match in semifinal_qualifier_matches %}
              <div class="knockout-card-qualifier">
                <div class="knockout-card-title">åŠå†³èµ›èµ„æ ¼èµ›</div>
                <div class="knockout-card-players">
                  <div class="knockout-card-player {% if match.player_1_score > match.player_2_score %}winner{% endif %}">
                    <span>{{ match.player1.name }}</span>
                    {% if session.get('admin_logged_in') %}
                      <input type="number" class="knockout-card-score" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}" min="0" 
                             data-match-id="{{ match.m_id }}" data-player="1"
                             style="width: 40px; padding: 2px; border: 1px solid #ced4da; border-radius: 3px; text-align: center;">
                    {% else %}
                      <span class="knockout-card-score">{{ match.player_1_score }}</span>
                    {% endif %}
                  </div>
                  <div class="knockout-card-player {% if match.player_2_score > match.player_1_score %}winner{% endif %}">
                    <span>{{ match.player2.name }}</span>
                    {% if session.get('admin_logged_in') %}
                      <input type="number" class="knockout-card-score" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}" min="0" 
                             data-match-id="{{ match.m_id }}" data-player="2"
                             style="width: 40px; padding: 2px; border: 1px solid #ced4da; border-radius: 3px; text-align: center;">
                    {% else %}
                      <span class="knockout-card-score">{{ match.player_2_score }}</span>
                    {% endif %}
                  </div>
                  </div>
                  {% if session.get('admin_logged_in') %}
                <div class="knockout-card-actions">
                  <button class="btn btn-sm btn-primary" onclick="submitKnockoutScore({{ match.m_id|tojson }})" 
                          {% if match.player_1_score < 0 or match.player_2_score < 0 %}disabled{% endif %}>
                    æäº¤
                  </button>
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
          {% endif %}
          
          <!-- 1/4å†³èµ›è½®æ¬¡ -->
          {% set quarterfinal_matches = knockout_matches|selectattr('m_type', 'equalto', 8)|list %}
          {% if quarterfinal_matches %}
              {% for match in quarterfinal_matches %}
              <div class="knockout-card-quarterfinal" data-type="quarterfinal" id="quarterfinal-{{ loop.index }}">
                <div class="knockout-card-title">1/4å†³èµ›</div>
                <div class="knockout-card-players">
                  <div class="knockout-card-player {% if match.player_1_score > match.player_2_score %}winner{% endif %}">
                    <span>
                      {% if match.player_1_id == -1 %}
                        å¾…èµ„æ ¼èµ›ç»“æœ
                      {% else %}
                        {{ match.player1.name if match.player1 else 'å¾…å®š' }}
                      {% endif %}
                    </span>
                    {% if match.player_1_id != -1 %}
                      {% if session.get('admin_logged_in') %}
                        <input type="number" class="knockout-card-score" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}" min="0" 
                               data-match-id="{{ match.m_id }}" data-player="1"
                               style="width: 40px; padding: 2px; border: 1px solid #ced4da; border-radius: 3px; text-align: center;">
                      {% else %}
                        <span class="knockout-card-score">{{ match.player_1_score }}</span>
                      {% endif %}
                    {% else %}
                      <span class="knockout-card-score">-</span>
                    {% endif %}
                  </div>
                  <div class="knockout-card-player {% if match.player_2_score > match.player_1_score %}winner{% endif %}">
                    <span>
                      {% if match.player_2_id == -1 %}
                        å¾…èµ„æ ¼èµ›ç»“æœ
                      {% else %}
                        {{ match.player2.name if match.player2 else 'å¾…å®š' }}
                      {% endif %}
                    </span>
                    {% if match.player_2_id != -1 %}
                      {% if session.get('admin_logged_in') %}
                        <input type="number" class="knockout-card-score" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}" min="0" 
                               data-match-id="{{ match.m_id }}" data-player="2"
                               style="width: 40px; padding: 2px; border: 1px solid #ced4da; border-radius: 3px; text-align: center;">
                      {% else %}
                        <span class="knockout-card-score">{{ match.player_2_score }}</span>
                      {% endif %}
                    {% else %}
                      <span class="knockout-card-score">-</span>
                    {% endif %}
                  </div>
                </div>
                {% if session.get('admin_logged_in') and match.player_1_id != -1 and match.player_2_id != -1 %}
                  <div class="knockout-card-actions">
                    <button class="btn btn-sm btn-primary" onclick="submitKnockoutScore({{ match.m_id|tojson }})" 
                            {% if match.player_1_score < 0 or match.player_2_score < 0 %}disabled{% endif %}>
                      æäº¤
                    </button>
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
          {% endif %}
          
          <!-- åŠå†³èµ›è½®ï¿½?-->
          {% set semifinal_matches = knockout_matches|selectattr('m_type', 'equalto', 10)|list %}
          {% if semifinal_matches %}
            {% for match in semifinal_matches %}
              {% if match.player_1_id and match.player_2_id %}
              <div class="knockout-card-semifinal" id="semifinal-{{ loop.index }}">
                <div class="knockout-card-title">åŠå†³ï¿½?/div>
                <div class="knockout-card-players">
                  <div class="knockout-card-player {% if match.player_1_score > match.player_2_score %}winner{% endif %}">
                    <span>{{ match.player1.name if match.player1 else 'å¾…å®š' }}</span>
                    {% if session.get('admin_logged_in') %}
                      <input type="number" class="knockout-card-score" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}" min="0" 
                             data-match-id="{{ match.m_id }}" data-player="1"
                             style="width: 40px; padding: 2px; border: 1px solid #ced4da; border-radius: 3px; text-align: center;">
                    {% else %}
                      <span class="knockout-card-score">{{ match.player_1_score if match.player_1_score >= 0 else '' }}</span>
                    {% endif %}
              </div>
                  <div class="knockout-card-player {% if match.player_2_score > match.player_1_score %}winner{% endif %}">
                    <span>{{ match.player2.name if match.player2 else 'å¾…å®š' }}</span>
                    {% if session.get('admin_logged_in') %}
                      <input type="number" class="knockout-card-score" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}" min="0" 
                             data-match-id="{{ match.m_id }}" data-player="2"
                             style="width: 40px; padding: 2px; border: 1px solid #ced4da; border-radius: 3px; text-align: center;">
                    {% else %}
                      <span class="knockout-card-score">{{ match.player_2_score if match.player_2_score >= 0 else '' }}</span>
                    {% endif %}
              </div>
            </div>
                {% if session.get('admin_logged_in') %}
                  <div class="knockout-card-actions">
                    <button class="btn btn-sm btn-primary" onclick="submitKnockoutScore({{ match.m_id|tojson }})" 
                            {% if match.player_1_score < 0 or match.player_2_score < 0 %}disabled{% endif %}>
                      æäº¤
                    </button>
              </div>
                {% endif %}
              </div>
              {% endif %}
            {% endfor %}
          {% endif %}
          
          <!-- é‡‘ç‰Œèµ›è½®ï¿½?-->
          {% set gold_matches = knockout_matches|selectattr('m_type', 'equalto', 11)|list %}
          {% if gold_matches %}
            {% for match in gold_matches %}
              {% if match.player_1_id and match.player_2_id %}
              <div class="knockout-card-gold" id="gold-match">
                <div class="knockout-card-title">ğŸ¥‡ é‡‘ç‰Œï¿½?/div>
                <div class="knockout-card-players">
                  <div class="knockout-card-player {% if match.player_1_score > match.player_2_score %}winner{% endif %}">
                    <span>{{ match.player1.name if match.player1 else 'å¾…å®š' }}</span>
                    {% if session.get('admin_logged_in') %}
                      <input type="number" class="knockout-card-score" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}" min="0" 
                             data-match-id="{{ match.m_id }}" data-player="1"
                             style="width: 40px; padding: 2px; border: 1px solid #ced4da; border-radius: 3px; text-align: center;">
                    {% else %}
                      <span class="knockout-card-score">{{ match.player_1_score if match.player_1_score >= 0 else '' }}</span>
                    {% endif %}
            </div>
                  <div class="knockout-card-player {% if match.player_2_score > match.player_1_score %}winner{% endif %}">
                    <span>{{ match.player2.name if match.player2 else 'å¾…å®š' }}</span>
                    {% if session.get('admin_logged_in') %}
                      <input type="number" class="knockout-card-score" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}" min="0" 
                             data-match-id="{{ match.m_id }}" data-player="2"
                             style="width: 40px; padding: 2px; border: 1px solid #ced4da; border-radius: 3px; text-align: center;">
                    {% else %}
                      <span class="knockout-card-score">{{ match.player_2_score if match.player_2_score >= 0 else '' }}</span>
                    {% endif %}
          </div>
              </div>
                {% if session.get('admin_logged_in') %}
                  <div class="knockout-card-actions">
                    <button class="btn btn-sm btn-primary" onclick="submitKnockoutScore({{ match.m_id|tojson }})" 
                            {% if match.player_1_score < 0 or match.player_2_score < 0 %}disabled{% endif %}>
                      æäº¤
                    </button>
              </div>
                {% endif %}
            </div>
              {% endif %}
            {% endfor %}
          {% endif %}
          
          <!-- é“œç‰Œèµ›è½®ï¿½?-->
          {% set bronze_matches = knockout_matches|selectattr('m_type', 'equalto', 12)|list %}
          {% if bronze_matches %}
            {% for match in bronze_matches %}
              {% if match.player_1_id and match.player_2_id %}
              <div class="knockout-card-bronze" id="bronze-match">
                <div class="knockout-card-title">ğŸ¥‰ é“œç‰Œï¿½?/div>
                <div class="knockout-card-players">
                  <div class="knockout-card-player {% if match.player_1_score > match.player_2_score %}winner{% endif %}">
                    <span>{{ match.player1.name if match.player1 else 'å¾…å®š' }}</span>
                    {% if session.get('admin_logged_in') %}
                      <input type="number" class="knockout-card-score" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}" min="0" 
                             data-match-id="{{ match.m_id }}" data-player="1"
                             style="width: 40px; padding: 2px; border: 1px solid #ced4da; border-radius: 3px; text-align: center;">
                    {% else %}
                      <span class="knockout-card-score">{{ match.player_1_score if match.player_1_score >= 0 else '' }}</span>
                    {% endif %}
              </div>
                  <div class="knockout-card-player {% if match.player_2_score > match.player_1_score %}winner{% endif %}">
                    <span>{{ match.player2.name if match.player2 else 'å¾…å®š' }}</span>
                    {% if session.get('admin_logged_in') %}
                      <input type="number" class="knockout-card-score" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}" min="0" 
                             data-match-id="{{ match.m_id }}" data-player="2"
                             style="width: 40px; padding: 2px; border: 1px solid #ced4da; border-radius: 3px; text-align: center;">
                    {% else %}
                      <span class="knockout-card-score">{{ match.player_2_score if match.player_2_score >= 0 else '' }}</span>
                    {% endif %}
              </div>
            </div>
                {% if session.get('admin_logged_in') %}
                  <div class="knockout-card-actions">
                    <button class="btn btn-sm btn-primary" onclick="submitKnockoutScore({{ match.m_id|tojson }})" 
                            {% if match.player_1_score < 0 or match.player_2_score < 0 %}disabled{% endif %}>
                      æäº¤
                    </button>
          </div>
                {% endif %}
              </div>
              {% endif %}
            {% endfor %}
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>

  <script>
    // å…¨å±€å˜é‡
    let selectedQuarterfinalType = null;
    let selectedRandomSubOption = null;
    // é€‰æ‰‹é€‰æ‹©åŠŸèƒ½ï¼ˆå¸¦é˜²æŠ–ï¿½?    function updatePlayerOptions() {
      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      if (updatePlayerOptionsTimeout) {
        clearTimeout(updatePlayerOptionsTimeout);
      }
      
      // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œå»¶è¿Ÿæ‰§è¡Œ
      updatePlayerOptionsTimeout = setTimeout(function() {
        updatePlayerOptionsImmediate();
      }, 100);
    }
    
    // ç«‹å³æ‰§è¡Œæ›´æ–°
    function updatePlayerOptionsImmediate() {
      try {
        const playerCount = {{ tournament.player_count }};
        const allPlayers = {{ participants | tojson }};
        
        // è°ƒè¯•ä¿¡æ¯ï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶æ˜¾ç¤ºï¿½?        if (!window.playerOptionsInitialized) {
          console.log('playerCount:', playerCount);
          console.log('allPlayers:', allPlayers);
          window.playerOptionsInitialized = true;
        }
        
        // æ£€æŸ¥æ•°æ®æœ‰æ•ˆï¿½?        if (!allPlayers || !Array.isArray(allPlayers) || allPlayers.length === 0) {
          console.error('allPlayersæ•°æ®æ— æ•ˆæˆ–ä¸ºï¿½?', allPlayers);
          alert('æ²¡æœ‰å¯ç”¨çš„é€‰æ‰‹æ•°æ®ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
          return;
        }
        
        // è·å–æ‰€æœ‰å·²é€‰æ‹©çš„é€‰æ‰‹ID
        const selectedPlayerIds = new Set();
        for (let i = 1; i <= playerCount; i++) {
          const select = document.getElementById(`player-${i}`);
          if (select && select.value) {
            selectedPlayerIds.add(parseInt(select.value));
          }
        }
        
        // æ›´æ–°æ‰€æœ‰ä¸‹æ‹‰æ¡†çš„é€‰é¡¹
        for (let i = 1; i <= playerCount; i++) {
          const select = document.getElementById(`player-${i}`);
          if (!select) continue;
          
          const currentValue = select.value;
          
          // æ¸…ç©ºé€‰é¡¹
          select.innerHTML = '<option value="">è¯·é€‰æ‹©é€‰æ‰‹</option>';
          
          // æ·»åŠ å¯ç”¨é€‰é¡¹
          allPlayers.forEach(function(player) {
            try {
              // æ£€æŸ¥playerå¯¹è±¡ç»“æ„
              if (!player || typeof player !== 'object') {
                console.error('æ— æ•ˆçš„playerå¯¹è±¡:', player);
                return;
              }
              
              const playerId = player.player_id;
              const playerName = player.name;
              
              // æ£€æŸ¥å¿…è¦å±ï¿½?              if (!playerId || !playerName) {
                console.error('playerç¼ºå°‘å¿…è¦å±ï¿½?', player);
                return;
              }
              
              const isSelected = selectedPlayerIds.has(playerId);
              const isCurrentSelection = parseInt(currentValue) === playerId;
              
              // å¦‚æœè¿™ä¸ªé€‰æ‰‹æ²¡æœ‰è¢«é€‰ä¸­ï¼Œæˆ–è€…æ˜¯å½“å‰ä¸‹æ‹‰æ¡†çš„é€‰ä¸­é¡¹ï¼Œåˆ™æ˜¾ï¿½?              if (!isSelected || isCurrentSelection) {
                const option = document.createElement('option');
                option.value = playerId;
                option.textContent = playerName; // ä½¿ç”¨textContentè€Œä¸æ˜¯innerHTML
                if (isCurrentSelection) {
                  option.selected = true;
                }
                select.appendChild(option);
              }
            } catch (error) {
              console.error('å¤„ç†playeræ—¶å‡ºï¿½?', error, player);
            }
          });
        }
      } catch (error) {
        console.error('updatePlayerOptionså‡½æ•°å‡ºé”™:', error);
        alert('æ›´æ–°é€‰æ‰‹é€‰é¡¹æ—¶å‡ºé”™ï¼Œè¯·åˆ·æ–°é¡µé¢é‡ï¿½?);
      }
    }
    
    // åˆå§‹åŒ–é€‰æ‰‹é€‰æ‹©ï¿½?    function initializePlayerSelectors() {
      const playerCount = {{ tournament.player_count }};
      
      for (let i = 1; i <= playerCount; i++) {
        const select = document.getElementById(`player-${i}`);
        if (select) {
          select.addEventListener('change', updatePlayerOptions);
        }
      }
      
      // åˆå§‹åŒ–é€‰é¡¹
      updatePlayerOptionsImmediate();
    }
    
    // ç”Ÿæˆåœºæ¬¡
    function generateMatches() {
      const tournamentId = {{ tournament.t_id }};
        const selectedPlayers = [];
        
      // è·å–é€‰ä¸­çš„é€‰æ‰‹
      const playerCount = {{ tournament.player_count }};
        for (let i = 1; i <= playerCount; i++) {
          const select = document.getElementById(`player-${i}`);
          if (select && select.value) {
            selectedPlayers.push(parseInt(select.value));
          }
        }
        
        if (selectedPlayers.length !== playerCount) {
        alert('è¯·é€‰æ‹©æ‰€æœ‰é€‰æ‰‹');
          return;
        }
        
      // å‘é€è¯·æ±‚ç”Ÿæˆåœºï¿½?      fetch('/admin-secret/tournament/' + tournamentId + '/set-participants', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
          participants: selectedPlayers
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
          alert('åœºæ¬¡ç”ŸæˆæˆåŠŸï¿½?);
            location.reload();
          } else {
          alert('ç”Ÿæˆå¤±è´¥ï¿½? + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
        alert('ç”Ÿæˆå¤±è´¥ï¿½? + error.message);
        });
    }
    
    // ç”ŸæˆåŠå†³èµ›èµ„æ ¼èµ›ï¼ˆé€šç”¨å‡½æ•°ï¿½?    function generateSemifinalQualifier() {
      const tournamentId = {{ tournament.t_id }};
      
      if (confirm('ç¡®å®šè¦ç”ŸæˆåŠå†³èµ›èµ„æ ¼èµ›å—ï¼Ÿè¿™å°†è¦†ç›–ç°æœ‰çš„æ·˜æ±°èµ›æ•°æ®ï¿½?)) {
        fetch('/admin-secret/tournament/' + tournamentId + '/generate-semifinal-qualifier', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('åŠå†³èµ›èµ„æ ¼èµ›ç”ŸæˆæˆåŠŸï¿½?);
            location.reload();
          } else {
            alert('ç”Ÿæˆå¤±è´¥ï¿½? + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('ç”Ÿæˆå¤±è´¥ï¿½? + error.message);
        });
      }
    }
    
    // æ·˜æ±°èµ›è½®æ’­å›¾æ‹–æ‹½åŠŸèƒ½
    let isDragging = false;
    let startX = 0;
    let currentTranslate = 0;
    let previousTranslate = 0;
    let animationID = 0;
    
    function initCarouselDrag() {
      const carousel = document.querySelector('.knockout-carousel');
      if (!carousel) return;
      
      // é¼ æ ‡äº‹ä»¶
      carousel.addEventListener('mousedown', dragStart);
      carousel.addEventListener('mousemove', dragMove);
      carousel.addEventListener('mouseup', dragEnd);
      carousel.addEventListener('mouseleave', dragEnd);
      
      // è§¦æ‘¸äº‹ä»¶
      carousel.addEventListener('touchstart', dragStart);
      carousel.addEventListener('touchmove', dragMove);
      carousel.addEventListener('touchend', dragEnd);
      
      // é˜²æ­¢å›¾ç‰‡æ‹–æ‹½
      carousel.addEventListener('dragstart', (e) => e.preventDefault());
    }
    
    function dragStart(e) {
      if (e.type === 'touchstart') {
        startX = e.touches[0].clientX;
        } else {
        startX = e.clientX;
      }
      isDragging = true;
      
      const carousel = document.querySelector('.knockout-carousel');
      carousel.style.cursor = 'grabbing';
    }
    
    function dragMove(e) {
      if (!isDragging) return;
      
      e.preventDefault();
      
      let currentX = 0;
      if (e.type === 'touchmove') {
        currentX = e.touches[0].clientX;
      } else {
        currentX = e.clientX;
      }
      
      currentTranslate = previousTranslate + currentX - startX;
    }
    
    function dragEnd() {
      isDragging = false;
      
      const carousel = document.querySelector('.knockout-carousel');
      carousel.style.cursor = 'grab';
      
      const movedBy = currentTranslate - previousTranslate;
      
      if (movedBy < -100 && currentKnockoutRound < totalKnockoutRounds - 1) {
        // å‘å·¦æ»‘åŠ¨ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ï¿½?        changeKnockoutRound(1);
      } else if (movedBy > 100 && currentKnockoutRound > 0) {
        // å‘å³æ»‘åŠ¨ï¼Œåˆ‡æ¢åˆ°ä¸Šä¸€ï¿½?        changeKnockoutRound(-1);
      }
      
      previousTranslate = currentTranslate;
    }
    
    // æ·˜æ±°èµ›è½®æ’­å›¾åŠŸèƒ½
    let currentKnockoutRound = 0;
    let totalKnockoutRounds = 0;
    
    // åˆå§‹åŒ–è½®æ’­å›¾è½®æ¬¡æ•°é‡
    function initKnockoutRounds() {
      const indicators = document.querySelectorAll('.indicator');
      totalKnockoutRounds = indicators.length;
      
      // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ´»è·ƒçš„æŒ‡ç¤ºå™¨ä½œä¸ºåˆå§‹è½®ï¿½?      indicators.forEach((indicator, index) => {
        if (indicator.classList.contains('active')) {
          currentKnockoutRound = index;
        }
      });
      
      // åŠ¨æ€è®¾ç½®è½®æ’­å›¾å®½åº¦
      if (totalKnockoutRounds > 0) {
        const carouselTrack = document.querySelector('.carousel-track');
        const carouselSlides = document.querySelectorAll('.carousel-slide');
        
        if (carouselTrack && carouselSlides.length > 0) {
          // è®¾ç½®è½¨é“å®½åº¦ä¸ºè½®æ¬¡æ•°é‡çš„100%
          carouselTrack.style.width = (totalKnockoutRounds * 100) + '%';
          
          // è®¾ç½®æ¯ä¸ªè½®æ¬¡çš„å®½ï¿½?          carouselSlides.forEach(slide => {
            slide.style.width = (100 / totalKnockoutRounds) + '%';
          });
        }
      }
    }
    
    function changeKnockoutRound(direction) {
      const slides = document.querySelectorAll('.carousel-slide');
      const indicators = document.querySelectorAll('.indicator');
      
      if (totalKnockoutRounds === 0) return;
      
      // ç§»é™¤å½“å‰æ´»è·ƒçŠ¶ï¿½?      slides[currentKnockoutRound].classList.remove('active');
      indicators[currentKnockoutRound].classList.remove('active');
      
      // è®¡ç®—æ–°çš„è½®æ¬¡
      currentKnockoutRound += direction;
      if (currentKnockoutRound < 0) {
        currentKnockoutRound = totalKnockoutRounds - 1;
      } else if (currentKnockoutRound >= totalKnockoutRounds) {
        currentKnockoutRound = 0;
      }
      
      // æ·»åŠ æ–°çš„æ´»è·ƒçŠ¶ï¿½?      slides[currentKnockoutRound].classList.add('active');
      indicators[currentKnockoutRound].classList.add('active');
    }
    
    // ç‚¹å‡»æŒ‡ç¤ºå™¨åˆ‡æ¢è½®ï¿½?    function goToKnockoutRound(round) {
      const slides = document.querySelectorAll('.carousel-slide');
      const indicators = document.querySelectorAll('.indicator');
      
      if (totalKnockoutRounds === 0) return;
      
      // ç§»é™¤å½“å‰æ´»è·ƒçŠ¶ï¿½?      slides[currentKnockoutRound].classList.remove('active');
      indicators[currentKnockoutRound].classList.remove('active');
      
      // è®¾ç½®æ–°çš„è½®æ¬¡
      currentKnockoutRound = round;
      
      // æ·»åŠ æ–°çš„æ´»è·ƒçŠ¶ï¿½?      slides[currentKnockoutRound].classList.add('active');
      indicators[currentKnockoutRound].classList.add('active');
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥ç°æœ‰æ ¼ï¿½?    document.addEventListener('DOMContentLoaded', function() {
      console.log('é¡µé¢è„šæœ¬å¼€å§‹æ‰§ï¿½?);
      
      // åˆå§‹åŒ–å“åº”å¼æ»‘åŠ¨ç½‘æ ¼
      initSlidingGrid();
      initGridDrag();
      
      // ç›‘å¬çª—å£å¤§å°å˜åŒ–
      window.addEventListener('resize', handleResize);
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯å°èµ›ï¼ˆç¬¬2å±Šèµ·ï¿½?      const isMinorTournament = {{ 'true' if tournament.type == 2 and tournament.type_session_number >= 2 else 'false' }};
      
      if (isMinorTournament) {
        // å°èµ›ï¼ˆç¬¬2å±Šèµ·ï¼‰ï¼šéšè—åˆ†é¡µæŒ‰é’®ï¼Œç›´æ¥æ˜¾ç¤ºå°ç»„èµ›é¡µé¢
        const pageNavigation = document.querySelector('.page-navigation');
        if (pageNavigation) {
          pageNavigation.style.display = 'none';
        }
        
        // ç¡®ä¿å°ç»„èµ›é¡µé¢å¯ï¿½?        const groupStagePage = document.getElementById('page-group-stage');
        if (groupStagePage) {
          groupStagePage.style.display = 'block';
        }
        
        // éšè—å…¶ä»–é¡µé¢
        const knockoutPage = document.getElementById('page-knockout');
        if (knockoutPage) {
          knockoutPage.style.display = 'none';
        }
      }
    });
  </script>
</body>
</html>
