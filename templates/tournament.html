{% extends 'layout.html' %}
{% block content %}
  <div class="tournament-info">
    <h2>{{ tournament.season.year if tournament.season else tournament.season_id }} - ç¬¬{{ tournament.type_session_number }}å±Š</h2>
    
    {% if session.get('admin_logged_in') %}
      <p><a href="/admin-secret">è¿”å›åå°ç®¡ç†é¦–é¡µ</a></p>
    {% endif %}
    
    <!-- æŠ¥åæŒ‰é’® -->
    {% if not session.get('admin_logged_in') %}
      
      {% if session.get('user_logged_in') and current_user and current_user.player_id %}
        {% set user_signed_up = false %}
        {% for signup in tournament.signups %}
          {% if signup.u_id == current_user.uid %}
            {% set user_signed_up = true %}
          {% endif %}
        {% endfor %}
        
        {% if not user_signed_up %}
          {% set signup_closed = false %}
          {% if signup_deadline %}
            {% set now = moment().utcnow() %}
            {% if signup_deadline < now %}
              {% set signup_closed = true %}
            {% endif %}
          {% endif %}
          
          {% if not signup_closed %}
            <p><a href="/tournament/{{ tournament.t_id }}/signup" class="btn btn-success">æŠ¥åå‚èµ›</a></p>
          {% else %}
            <p><span class="text-muted">æŠ¥åå·²æˆªæ­¢</span></p>
          {% endif %}
        {% else %}
          <p><span class="text-success">âœ“ å·²æŠ¥å</span></p>
        {% endif %}
      {% elif session.get('user_logged_in') %}
        <p><a href="/user/profile" class="btn btn-warning">ç»‘å®šé€‰æ‰‹åæŠ¥å</a></p>
      {% else %}
        <p><a href="/login" class="btn btn-primary">ç™»å½•åæŠ¥å</a></p>
      {% endif %}

    {% endif %}
    

    <p>
      ç±»å‹
      &NonBreakingSpace;
      <b>{% if tournament.type == 1 %}æ­£èµ›{% elif tournament.type == 2 %}å°èµ› (CM250){% elif tournament.type == 3 %}æ€»å†³èµ›{% else %}æœªçŸ¥ç±»å‹{% endif %}</b>
    </p>
    <p>
      å‚èµ›äººæ•°
      &NonBreakingSpace;
      <b>{{ tournament.player_count or 'æœªè®¾ç½®' }}</b>
    </p>
    <p>
      èµ›åˆ¶
      &NonBreakingSpace;
      <b>{{ t_format_labels.get(tournament.t_format) if tournament.t_format is not none else 'æœªè®¾ç½®' }}</b>
    </p>
    <p>
      èµ›å­£
      &NonBreakingSpace;
      <b><a href="/season/{{ tournament.season_id }}">{{ tournament.season.year if tournament.season else tournament.season_id }}</a></b>
    </p>
  </div>
  
  {% if pagination %}
    <div class="pagination-container">
      <!-- åŒç±»å‹èµ›äº‹ç¿»é¡µ -->
      {% if pagination.same_type %}
        <div class="pagination-box same-type-pagination" style="border: 3px solid #0055aa;background: #f0f8ff;">
          <h4>åŒç±»å‹èµ›äº‹ç¿»é¡µ</h4>
          <div class="pagination-controls">
            <div class="pagination-left">
              {% if pagination.same_type.has_prev %}
                <a href="/tournament/{{ pagination.same_type.prev_info.t_id }}" class="pagination-btn prev-btn">
                  â† ä¸Šä¸€å±Š
                  <div class="btn-info">
                    <div class="season-year">{{ pagination.same_type.prev_info.season_year }}</div>
                    <div class="tournament-info">ç¬¬{{ pagination.same_type.prev_info.session_number }}å±Š{{ pagination.same_type.prev_info.type_name }}</div>
                  </div>
                </a>
                <div class="pagination-info desktop-only">
                  <div class="season-year">{{ pagination.same_type.prev_info.season_year }}</div>
                  <div class="tournament-info">ç¬¬{{ pagination.same_type.prev_info.session_number }}å±Š{{ pagination.same_type.prev_info.type_name }}</div>
                </div>
              {% else %}
                <span class="pagination-btn disabled">
                  â† ä¸Šä¸€å±Š
                  <div class="btn-info">
                    <div class="season-year">-</div>
                    <div class="tournament-info">-</div>
                  </div>
                </span>
              {% endif %}
            </div>
            <div class="pagination-right">
              {% if pagination.same_type.has_next %}
                <a href="/tournament/{{ pagination.same_type.next_info.t_id }}" class="pagination-btn next-btn">
                  ä¸‹ä¸€å±Š â†’
                  <div class="btn-info">
                    <div class="season-year">{{ pagination.same_type.next_info.season_year }}</div>
                    <div class="tournament-info">ç¬¬{{ pagination.same_type.next_info.session_number }}å±Š{{ pagination.same_type.next_info.type_name }}</div>
                  </div>
                </a>
                <div class="pagination-info desktop-only">
                  <div class="season-year">{{ pagination.same_type.next_info.season_year }}</div>
                  <div class="tournament-info">ç¬¬{{ pagination.same_type.next_info.session_number }}å±Š{{ pagination.same_type.next_info.type_name }}</div>
                </div>
              {% else %}
                <span class="pagination-btn disabled">
                  ä¸‹ä¸€å±Š â†’
                  <div class="btn-info">
                    <div class="season-year">-</div>
                    <div class="tournament-info">-</div>
                  </div>
                </span>
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}
      
      <!-- æ‰€æœ‰èµ›äº‹ç¿»é¡µ -->
      {% if pagination.all_tournaments %}
        <div class="pagination-box all-tournaments-pagination" style="border: 3px solid #28a745;background: #f8fff8;">
          <h4>æ‰€æœ‰èµ›äº‹ç¿»é¡µ</h4>
          <div class="pagination-controls">
            <div class="pagination-left">
              {% if pagination.all_tournaments.has_prev %}
                <a href="/tournament/{{ pagination.all_tournaments.prev_info.t_id }}" class="pagination-btn prev-btn">
                  â† ä¸Šä¸€å±Š
                  <div class="btn-info">
                    <div class="season-year">{{ pagination.all_tournaments.prev_info.season_year }}</div>
                    <div class="tournament-info">ç¬¬{{ pagination.all_tournaments.prev_info.session_number }}å±Š{{ pagination.all_tournaments.prev_info.type_name }}</div>
                  </div>
                </a>
                <div class="pagination-info desktop-only">
                  <div class="season-year">{{ pagination.all_tournaments.prev_info.season_year }}</div>
                  <div class="tournament-info">ç¬¬{{ pagination.all_tournaments.prev_info.session_number }}å±Š{{ pagination.all_tournaments.prev_info.type_name }}</div>
                </div>
              {% else %}
                <span class="pagination-btn disabled">
                  â† ä¸Šä¸€å±Š
                  <div class="btn-info">
                    <div class="season-year">-</div>
                    <div class="tournament-info">-</div>
                  </div>
                </span>
              {% endif %}
            </div>
            <div class="pagination-right">
              {% if pagination.all_tournaments.has_next %}
                <a href="/tournament/{{ pagination.all_tournaments.next_info.t_id }}" class="pagination-btn next-btn">
                  ä¸‹ä¸€å±Š â†’
                  <div class="btn-info">
                    <div class="season-year">{{ pagination.all_tournaments.next_info.season_year }}</div>
                    <div class="tournament-info">ç¬¬{{ pagination.all_tournaments.next_info.session_number }}å±Š{{ pagination.all_tournaments.next_info.type_name }}</div>
                  </div>
                </a>
                <div class="pagination-info desktop-only">
                  <div class="season-year">{{ pagination.all_tournaments.next_info.season_year }}</div>
                  <div class="tournament-info">ç¬¬{{ pagination.all_tournaments.next_info.session_number }}å±Š{{ pagination.all_tournaments.next_info.type_name }}</div>
                </div>
              {% else %}
                <span class="pagination-btn disabled">
                  ä¸‹ä¸€å±Š â†’
                  <div class="btn-info">
                    <div class="season-year">-</div>
                    <div class="tournament-info">-</div>
                  </div>
                </span>
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  {% endif %}
  
  <!-- é¡µé¢å¯¼èˆªï¼ˆå°èµ›ä»ç¬¬2å±Šèµ·ç¦ç”¨ï¼‰ -->
    {% if not (tournament.type == 2 and tournament.type_session_number >= 2) %}
    <div class="page-navigation">
      {% if tournament.t_format == 7 %}
        <button onclick="showPage('group-stage')" class="page-btn" id="btn-group-stage">èµ›äº‹æ’å</button>
        <button onclick="showPage('knockout')" class="page-btn" id="btn-knockout" style="background-color: #ff6b6b; color: white;">åœºæ¬¡</button>
      {% else %}
        <button onclick="showPage('group-stage')" class="page-btn" id="btn-group-stage">å°ç»„èµ›</button>
        <button onclick="showPage('knockout')" class="page-btn" id="btn-knockout" style="background-color: #ff6b6b; color: white;">æ·˜æ±°èµ›</button>
      {% endif %}
    </div>
  {% endif %}

  <!-- å°ç»„èµ›é¡µé¢ -->
  <div id="page-group-stage" class="page-content">
    
    
    <!-- å°ç»„èµ›ç®¡ç†æ¨¡å—ï¼ˆä»…é™t_formatä¸º1,2,3çš„èµ›äº‹ï¼‰ -->
    {% if tournament.t_format in [1, 2, 3] and session.get('admin_logged_in') %}
      <!-- æ£€æŸ¥åˆ†ç»„çŠ¶æ€ -->
      {% set has_groups = group_stage_data and group_stage_data.groups %}
      {% set has_players = has_groups and group_stage_data.groups[0].players|length > 0 %}
      
      {% if has_groups and has_players %}
        <!-- å·²åˆ†ç»„ä¸”å·²åˆ†é…é€‰æ‰‹çš„æƒ…å†µ -->
        <div class="group-management">
          <h4>ğŸ† å°ç»„èµ›ç®¡ç†</h4>
          <p>åˆ†ç»„ä¿¡æ¯å·²å®Œæˆï¼Œå…±{{ group_stage_data.groups|length }}ä¸ªå°ç»„</p>
          <button onclick="toggleAdminControls()" class="btn btn-secondary">æ˜¾ç¤ºç®¡ç†å‘˜æ§åˆ¶é¢æ¿</button>
        </div>
        
        <!-- éšè—çš„åˆ†ç»„è®¾ç½®æ¨¡å— -->
        <div id="group-settings" style="display: none;">
          <h4>ğŸ† å°ç»„èµ›è®¾ç½®</h4>
          <form id="group-settings-form" onsubmit="handleGroupSettingsSubmit(event)">
            <div class="form-group">
              <label for="group-size">ğŸ‘¥ æ¯ç»„äººæ•°</label>
              <select id="group-size" name="group_size" class="form-control">
                {% for factor in range(2, 9) %}
                  {% if tournament.player_count % factor == 0 %}
                    <option value="{{ factor }}">{{ factor }}äºº</option>
                  {% endif %}
                {% endfor %}
              </select>
              <span class="help-text">
                é€‰æ‹©æ¯ç»„äººæ•°ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—åˆ†ç»„æ•°é‡
              </span>
            </div>
            
            <div class="form-group">
              <label for="round-robin-type">âš™ï¸ èµ›åˆ¶ç±»å‹</label>
              <select id="round-robin-type" name="round_robin_type" class="form-control">
                <option value="single">å•å¾ªç¯</option>
                <option value="double">åŒå¾ªç¯</option>
              </select>
              <span class="help-text">
                å•å¾ªç¯ï¼šæ¯å¯¹é€‰æ‰‹åªæ¯”èµ›ä¸€æ¬¡ï¼›åŒå¾ªç¯ï¼šæ¯å¯¹é€‰æ‰‹æ¯”èµ›ä¸¤æ¬¡ï¼ˆä¸»å®¢åœºï¼‰
              </span>
            </div>
            
            <button type="submit" class="btn btn-primary">é‡æ–°ç”Ÿæˆåˆ†ç»„</button>
          </form>
                      </div>
      {% elif has_groups and not has_players %}
        <!-- å·²åˆ†ç»„ä½†æœªåˆ†é…é€‰æ‰‹çš„æƒ…å†µ -->
        <div class="group-management">
          <h4>ğŸ‘¥ é€‰æ‰‹åˆ†ç»„è®¾ç½®</h4>
          <p>åˆ†ç»„å·²åˆ›å»ºï¼Œå…±{{ group_stage_data.groups|length }}ä¸ªå°ç»„ï¼Œè¯·åˆ†é…é€‰æ‰‹</p>
                  </div>
        
        <!-- é€‰æ‰‹åˆ†ç»„è®¾ç½®åŒºåŸŸï¼ˆç›´æ¥æ˜¾ç¤ºï¼‰ -->
        <div id="player-grouping">
          <h4>ğŸ‘¥ é€‰æ‰‹åˆ†ç»„è®¾ç½®</h4>
          <div id="grouping-form">
            <!-- åŠ¨æ€ç”Ÿæˆçš„åˆ†ç»„ç•Œé¢ -->
                </div>
          <div class="grouping-actions">
            <button onclick="submitPlayerGrouping()" class="btn btn-success">ç¡®è®¤åˆ†ç»„</button>
            <button onclick="resetToGroupSettings()" class="btn btn-secondary">é‡æ–°è®¾ç½®åˆ†ç»„</button>
              </div>
        </div>
        
        <script>
        // é¡µé¢åŠ è½½å®Œæˆåï¼Œå¦‚æœæœ‰åˆ†ç»„ä½†æ²¡æœ‰é€‰æ‰‹ï¼Œè‡ªåŠ¨ç”Ÿæˆåˆ†ç»„ç•Œé¢
        document.addEventListener('DOMContentLoaded', function() {
          {% if has_groups and not has_players %}
            // ä½¿ç”¨ç°æœ‰åˆ†ç»„ä¿¡æ¯ç”Ÿæˆåˆ†ç»„ç•Œé¢
            generateExistingGroupingInterface();
          {% endif %}
        });
        </script>
        
        <!-- éšè—çš„åˆ†ç»„è®¾ç½®æ¨¡å— -->
        <div id="group-settings" style="display: none;">
          <h4>ğŸ† å°ç»„èµ›è®¾ç½®</h4>
          <form id="group-settings-form" onsubmit="handleGroupSettingsSubmit(event)">
            <div class="form-group">
              <label for="group-size">ğŸ‘¥ æ¯ç»„äººæ•°</label>
              <select id="group-size" name="group_size" class="form-control">
                {% for factor in range(2, 9) %}
                  {% if tournament.player_count % factor == 0 %}
                    <option value="{{ factor }}">{{ factor }}äºº</option>
                  {% endif %}
                {% endfor %}
              </select>
              <span class="help-text">
                é€‰æ‹©æ¯ç»„äººæ•°ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—åˆ†ç»„æ•°é‡
              </span>
            </div>
            
            <div class="form-group">
              <label for="round-robin-type">âš™ï¸ èµ›åˆ¶ç±»å‹</label>
              <select id="round-robin-type" name="round_robin_type" class="form-control">
                <option value="single">å•å¾ªç¯</option>
                <option value="double">åŒå¾ªç¯</option>
              </select>
              <span class="help-text">
                å•å¾ªç¯ï¼šæ¯å¯¹é€‰æ‰‹åªæ¯”èµ›ä¸€æ¬¡ï¼›åŒå¾ªç¯ï¼šæ¯å¯¹é€‰æ‰‹æ¯”èµ›ä¸¤æ¬¡ï¼ˆä¸»å®¢åœºï¼‰
              </span>
            </div>
            
            <button type="submit" class="btn btn-primary">é‡æ–°ç”Ÿæˆåˆ†ç»„</button>
          </form>
        </div>
      {% else %}
        <!-- æœªåˆ†ç»„çš„æƒ…å†µ -->
        <div id="group-settings">
          <h4>ğŸ† å°ç»„èµ›è®¾ç½®</h4>
          <form id="group-settings-form" onsubmit="handleGroupSettingsSubmit(event)">
            <div class="form-group">
              <label for="group-size">ğŸ‘¥ æ¯ç»„äººæ•°</label>
              <select id="group-size" name="group_size" class="form-control">
                {% for factor in range(2, 9) %}
                  {% if tournament.player_count % factor == 0 %}
                    <option value="{{ factor }}">{{ factor }}äºº</option>
      {% endif %}
                {% endfor %}
            </select>
              <span class="help-text">
                é€‰æ‹©æ¯ç»„äººæ•°ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—åˆ†ç»„æ•°é‡
              </span>
            </div>
            
            <div class="form-group">
              <label for="round-robin-type">âš™ï¸ èµ›åˆ¶ç±»å‹</label>
              <select id="round-robin-type" name="round_robin_type" class="form-control">
                <option value="single">å•å¾ªç¯</option>
                <option value="double">åŒå¾ªç¯</option>
            </select>
                <span class="help-text">
                  å•å¾ªç¯ï¼šæ¯å¯¹é€‰æ‰‹åªæ¯”èµ›ä¸€æ¬¡ï¼›åŒå¾ªç¯ï¼šæ¯å¯¹é€‰æ‰‹æ¯”èµ›ä¸¤æ¬¡ï¼ˆä¸»å®¢åœºï¼‰
                </span>
          </div>
          
            <button type="submit" class="btn btn-primary">ç”Ÿæˆåˆ†ç»„</button>
          </form>
          </div>
          
        <!-- é€‰æ‰‹åˆ†ç»„è®¾ç½®åŒºåŸŸï¼ˆç”Ÿæˆåˆ†ç»„åæ˜¾ç¤ºï¼‰ -->
        <div id="player-grouping" style="display: none;">
          <h4>ğŸ‘¥ é€‰æ‰‹åˆ†ç»„è®¾ç½®</h4>
          <div id="grouping-form">
            <!-- åŠ¨æ€ç”Ÿæˆçš„åˆ†ç»„ç•Œé¢ -->
          </div>
          <div class="grouping-actions">
            <button onclick="submitPlayerGrouping()" class="btn btn-success">ç¡®è®¤åˆ†ç»„</button>
            <button onclick="resetToGroupSettings()" class="btn btn-secondary">é‡æ–°è®¾ç½®åˆ†ç»„</button>
        </div>
        </div>
      {% endif %}
    {% endif %}

    
    <!-- å°ç»„èµ›å†…å®¹æ˜¾ç¤ºï¼ˆä»…é™t_formatä¸º1,2,3çš„èµ›äº‹ï¼‰ -->
    {% if tournament.t_format in [1, 2, 3] and group_stage_data and group_stage_data.groups %}
      <!-- å°ç»„å¯¼èˆªï¼ˆå°èµ›ä»ç¬¬2å±Šèµ·ç¦ç”¨ï¼‰ -->
      {% if not (tournament.type == 2 and tournament.type_session_number >= 2) %}
      <div class="group-navigation">
      {% for group in group_stage_data.groups %}
          <button onclick="showGroup('{{ group.t_name }}')" class="group-btn {% if loop.first %}active{% endif %}" id="btn-{{ group.t_name }}">{{ group.t_name }}ç»„</button>
        {% endfor %}
      </div>
      {% endif %}
      
      <!-- å°ç»„å†…å®¹ -->
      {% for group in group_stage_data.groups %}
        <div class="group-section" id="group-{{ group.t_name }}" {% if not loop.first and not (tournament.type == 2 and tournament.type_session_number >= 2) %}style="display: none;"{% endif %}>
          <!-- æ’åè¡¨æ ¼ -->
          <div class="group-ranking">
            <!-- æ¡Œé¢ç«¯æ’åè¡¨æ ¼ -->
            <div class="desktop-ranking">
              <table class="table table-striped group-table">
                <thead>
                  <tr>
                    <th>æ’å</th>
                      <th>é€‰æ‰‹</th>
                      <th>åœºæ¬¡</th>
                      <th>èƒœ</th>
                      <th>å¹³</th>
                      <th>è´Ÿ</th>
                      <th>æ€»å¾—åˆ†</th>
                      <th>æ€»å¤±åˆ†</th>
                      <th>å‡€èƒœåˆ†</th>
                      <th>ç§¯åˆ†</th>
                      <th>æ€»æ’å</th>
                  </tr>
                </thead>
                <tbody>
                  {% for player in group.players %}
                    <tr class="{% if tournament.t_format == 1 and player.total_rank <= 8 %}top8{% endif %}">
                      <td>{{ player.group_rank }}</td>
                      <td><a href="/player/{{ player.player_id }}">{{ player.name }}</a></td>
                      <td style="{% if player.total_matches == player.wins + player.draws + player.losses %}background-color: rgba(205,255,155,0.75); font-weight: bold;{% endif %}">
                        {{ player.wins + player.draws + player.losses }}
                      </td>
                      <td>{{ player.wins }}</td>
                      <td>{{ player.draws }}</td>
                      <td>{{ player.losses }}</td>
                      <td>{{ player.goals_for }}</td>
                      <td>{{ player.goals_against }}</td>
                      <td>{{ player.goal_difference }}</td>
                      <td>{{ player.points }}</td>
                      <td>{{ player.total_rank }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
            <!-- ç§»åŠ¨ç«¯æ’åå¡ç‰‡ -->
            <div class="mobile-ranking">
              {% for player in group.players %}
                <div class="player-card {% if tournament.t_format == 1 and player.total_rank <= 8 %}top8{% endif %}">
                  <div class="player-info">
                    <span class="player-name"><a href="/player/{{ player.player_id }}">{{ player.name }}</a></span>
                    <span class="group-rank">å°ç»„ ç¬¬{{ player.group_rank }}</span>
                    <span class="total-rank" style="margin-left: 0.5em;">æ€»æ’å ç¬¬{{ player.total_rank }}</span>
                  </div>
                  <div class="player-stats">
                    <div class="stat-item">
                      <span class="stat-label">ç§¯åˆ†</span>
                      <span class="stat-value">{{ player.points }}</span>
                    </div>
                    <div class="stat-item">
                      <span class="stat-label">èƒœ</span>
                      <span class="stat-value">{{ player.wins }}</span>
                    </div>
                    <div class="stat-item">
                      <span class="stat-label">å¹³</span>
                      <span class="stat-value">{{ player.draws }}</span>
                    </div>
                    <div class="stat-item">
                      <span class="stat-label">è´Ÿ</span>
                      <span class="stat-value">{{ player.losses }}</span>
                    </div>
                    <div class="stat-item">
                      <span class="stat-label">å‡€èƒœåˆ†</span>
                      <span class="stat-value">{{ player.goal_difference }}</span>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
          
            <!-- å°èµ›é‡‘ç‰Œèµ›ã€é“œç‰Œèµ›ï¼ˆä»…å°èµ›ä»ç¬¬2å±Šèµ·æ˜¾ç¤ºï¼Œåœ¨æœ€ç»ˆæ’åä¸­æ˜¾ç¤ºï¼‰ -->
            {% if tournament.type == 2 and tournament.type_session_number >= 2 and tournament.t_format in [4, 5] and loop.first %}
              {% set gold_matches = knockout_matches|selectattr('m_type', 'equalto', 12)|list %}
              {% set bronze_matches = knockout_matches|selectattr('m_type', 'equalto', 11)|list %}
              <!-- è°ƒè¯•ä¿¡æ¯ -->
              <!-- tournament.type: {{ tournament.type }}, type_session_number: {{ tournament.type_session_number }}, t_format: {{ tournament.t_format }}, loop.first: {{ loop.first }} -->
              <!-- knockout_matches count: {{ knockout_matches|length }}, gold_matches: {{ gold_matches|length }}, bronze_matches: {{ bronze_matches|length }} -->
              <!-- æ¡ä»¶æ£€æŸ¥: type>=2: {{ tournament.type == 2 }}, session>=2: {{ tournament.type_session_number >= 2 }}, format in [4,5]: {{ tournament.t_format in [4, 5] }}, loop.first: {{ loop.first }} -->
              
              <!-- é‡‘ç‰Œèµ›ã€é“œç‰Œèµ›å°†åœ¨æœ€ç»ˆæ’åéƒ¨åˆ†æ˜¾ç¤º -->
            {% endif %}
          
          <!-- æ¯”èµ›ç»“æœ - è‡ªé€‚åº”å¡ç‰‡æ ·å¼ -->
          <div class="group-matches">
            <div class="matches-grid">
              {% for match in group.matches %}
                <div class="match-card" 
                     data-group="{{ group.t_name }}" 
                     data-player1="{{ match.player1.name }}" 
                     data-player2="{{ match.player2.name }}"
                     data-status="{% if match.player_1_score is not none and match.player_2_score is not none and not (match.player_1_score == 0 and match.player_2_score == 0) %}completed{% else %}pending{% endif %}"
                     data-group-name="{{ group.t_name }}">
                  <div class="match-header">
                    <span class="match-title">{% if match.m_type == 14 %}é™„åŠ èµ›{% else %}ç¬¬{{ loop.index }}åœº{% endif %}</span>
                  </div>
                  <div class="match-players">
                    <div class="player-info">
                      <span class="player-name">{{ match.player1.name }}</span>
                      {% if match.m_type == 2 %}
                        <span class="home-away-tag home">ä¸»</span>
                      {% elif match.m_type == 3 %}
                        <span class="home-away-tag away">å®¢</span>
                      {% endif %}
                      <div class="score-display">
                        {% if match.player_1_score is not none and match.player_2_score is not none and match.player_1_score >= 0 and match.player_2_score >= 0 %}
                          {% if session.get('admin_logged_in') or (current_user and current_user.player_id and (match.player_1_id == current_user.player_id or match.player_2_id == current_user.player_id)) %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                   data-match-id="{{ match.m_id }}" data-player="1" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}">
                          {% else %}
                            <span class="score {% if match.player_1_score > match.player_2_score %}winner_1{% elif match.player_1_score == match.player_2_score and match.player_1_score > 0 %}tier_1{% endif %}">{{ match.player_1_score }}</span>
                          {% endif %}
                        {% else %}
                          {% if session.get('admin_logged_in') or (current_user and current_user.player_id and (match.player_1_id == current_user.player_id or match.player_2_id == current_user.player_id)) %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                   data-match-id="{{ match.m_id }}" data-player="1" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}">
                          {% else %}
                            <span class="score">-</span>
                          {% endif %}
                        {% endif %}
                      </div>
                    </div>
                    <div class="vs-divider">VS</div>
                    <div class="player-info">
                      <span class="player-name">{{ match.player2.name }}</span>
                      {% if match.m_type == 2 %}
                        <span class="home-away-tag away">å®¢</span>
                      {% elif match.m_type == 3 %}
                        <span class="home-away-tag home">ä¸»</span>
                      {% endif %}
                      <div class="score-display">
                        {% if match.player_1_score is not none and match.player_2_score is not none and match.player_1_score >= 0 and match.player_2_score >= 0 %}
                          {% if session.get('admin_logged_in') or (current_user and current_user.player_id and (match.player_1_id == current_user.player_id or match.player_2_id == current_user.player_id)) %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                   data-match-id="{{ match.m_id }}" data-player="2" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}">
                          {% else %}
                            <span class="score {% if match.player_2_score > match.player_1_score %}winner_2{% elif match.player_2_score == match.player_1_score and match.player_2_score > 0 %}tier_2{% endif %}">{{ match.player_2_score }}</span>
                          {% endif %}
                        {% else %}
                          {% if session.get('admin_logged_in') or (current_user and current_user.player_id and (match.player_1_id == current_user.player_id or match.player_2_id == current_user.player_id)) %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                   data-match-id="{{ match.m_id }}" data-player="2" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}">
                          {% else %}
                            <span class="score">-</span>
                          {% endif %}
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% if session.get('admin_logged_in') or (current_user and current_user.player_id and (match.player_1_id == current_user.player_id or match.player_2_id == current_user.player_id)) %}
                    <div class="match-actions">
                      <button onclick="submitScore({{ match.m_id }})" class="btn btn-sm btn-primary" 
                              {% if match.player_1_score is none or match.player_2_score is none %}disabled{% endif %}>
                        æäº¤æ¯”åˆ†
                      </button>
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      {% endfor %}
      {% endif %}
    
    <!-- å•å¾ªç¯èµ›æ˜¾ç¤ºï¼ˆä»…é™t_formatä¸º4,5,6çš„èµ›äº‹ï¼‰ -->
    {% if tournament.t_format in [4, 5, 6] %}
      <!-- æ£€æŸ¥æ˜¯å¦å·²æœ‰åœºæ¬¡ -->
      {% set has_round_robin_matches = false %}
      {% if group_stage_data and group_stage_data.groups %}
        {% for group in group_stage_data.groups %}
          {% if group.matches and group.matches|length > 0 %}
            {% set has_round_robin_matches = true %}
          {% endif %}
        {% endfor %}
    {% endif %}
    
      <!-- å·²æœ‰åœºæ¬¡æ—¶æ˜¾ç¤ºçš„ç®¡ç†é¢æ¿åˆ‡æ¢æŒ‰é’® -->
      {% if session.get('admin_logged_in') and has_round_robin_matches %}
        <div class="admin-toggle-section">
          <button onclick="toggleAdminControls()" class="btn btn-secondary">æ˜¾ç¤ºç®¡ç†å‘˜æ§åˆ¶é¢æ¿</button>
        </div>
      {% endif %}
      
      <!-- ç®¡ç†å‘˜æ§åˆ¶é¢æ¿ï¼ˆå•å¾ªç¯/åŒå¾ªç¯èµ›/è‹è¶…èµ›åˆ¶ï¼Œç®¡ç†å‘˜ç™»å½•æ—¶æ˜¾ç¤ºï¼Œä¸”æ— åœºæ¬¡æ—¶æ˜¾ç¤ºï¼‰ -->
      {% if session.get('admin_logged_in') and not has_round_robin_matches %}
        <div class="admin-controls">
          <h4>ç®¡ç†å‘˜æ§åˆ¶é¢æ¿</h4>
          
          <!-- é€‰æ‰‹ç®¡ç† -->
          <div class="player-management">
            <h5>é€‰æ‰‹ç®¡ç†</h5>
            <div class="form-group">
              <label for="player-count">å‚èµ›äººæ•°ï¼š</label>
              <input type="number" id="player-count" value="{{ tournament.player_count or '' }}" min="2" max="50">
            </div>
            
              <!-- æ ¹æ®èµ›äº‹å‚èµ›äººæ•°ç”Ÿæˆçš„é€‰æ‰‹é€‰æ‹©å™¨ -->
            <div class="player-selectors">
              {% for i in range(1, (tournament.player_count or 8) + 1) %}
                <div class="form-group">
                  <label for="player-{{ i }}">é€‰æ‰‹{{ i }}ï¼š</label>
                  <select id="player-{{ i }}" class="form-control" onchange="updatePlayerOptions()">
                    <option value="">è¯·é€‰æ‹©é€‰æ‰‹</option>
                    {% if participants %}
                    {% for player in participants %}
                      <option value="{{ player.player_id }}" data-player-id="{{ player.player_id }}">{{ player.name }}</option>
                    {% endfor %}
                    {% endif %}
                  </select>
                </div>
              {% endfor %}
            </div>
            
            {% if tournament.t_format == 6 %}
              <div class="jiangsu-info">
                <p>è‹è¶…èµ›åˆ¶ï¼šæ¯ä¸ªé€‰æ‰‹éœ€è¦é€‰æ‹© <strong>{{ (tournament.player_count - 1) // 2 }}</strong> ä¸ªä¸»åœºå¯¹æ‰‹</p>
                <p>å‰©ä½™å¯¹æ‰‹å°†è‡ªåŠ¨å®‰æ’ä¸ºå®¢åœºï¼ˆè¯¥é€‰æ‰‹ä½œä¸ºé€‰æ‰‹2ï¼‰</p>
            </div>
              
              <!-- åŠ¨æ€ç”Ÿæˆä¸»å®¢åœºé€‰æ‹©å™¨ -->
              <div class="home-away-selectors" id="home-away-selectors" style="display: none;">
                <!-- è¿™é‡Œä¼šé€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
              </div>
          
              <div class="form-actions">
                <button onclick="submitHomeAwaySelection()" class="btn btn-primary">ç¡®è®¤ä¸»å®¢åœºå®‰æ’</button>
              </div>
            {% else %}
              <div class="form-actions">
                <button onclick="generateMatches()" class="btn btn-primary">ç”Ÿæˆåœºæ¬¡</button>
              <button onclick="clearAllMatches()" class="btn btn-danger">æ¸…ç©ºæ‰€æœ‰åœºæ¬¡</button>
            </div>
            {% endif %}
          </div>
        </div>
      {% endif %}
      
      <!-- åŒè´¥æ·˜æ±°èµ›ç®¡ç†æ¨¡å—ï¼ˆä»…é™t_formatä¸º7çš„èµ›äº‹ï¼‰ -->
      {% if tournament.t_format == 7 and session.get('admin_logged_in') %}
        <div class="double-elimination-management">
          <h4>ğŸ† åŒè´¥æ·˜æ±°èµ›ç®¡ç†</h4>
          <p>åŒè´¥æ·˜æ±°èµ›ï¼šé€‰æ‰‹éœ€è¦è¾“ä¸¤åœºæ‰ä¼šè¢«æ·˜æ±°ã€‚èƒœè€…ç»„å’Œè´¥è€…ç»„åˆ†åˆ«è¿›è¡Œæ¯”èµ›ã€‚</p>
          
          <!-- é€‰æ‰‹é€‰æ‹©å™¨ -->
          <div class="player-selectors">
            {% for i in range(1, (tournament.player_count or 8) + 1) %}
              <div class="form-group">
                <label for="player-{{ i }}">é€‰æ‰‹{{ i }}ï¼š</label>
                <select id="player-{{ i }}" class="form-control" onchange="updatePlayerOptions()">
                  <option value="">è¯·é€‰æ‹©é€‰æ‰‹</option>
                  {% if participants %}
                  {% for player in participants %}
                    <option value="{{ player.player_id }}" data-player-id="{{ player.player_id }}">{{ player.name }}</option>
                  {% endfor %}
                  {% endif %}
                </select>
              </div>
            {% endfor %}
          </div>
          
          <div class="form-actions">
            <button onclick="generateDoubleEliminationMatches()" class="btn btn-primary">ç”ŸæˆåŒè´¥æ·˜æ±°èµ›</button>
            <button onclick="clearAllMatches()" class="btn btn-danger">æ¸…ç©ºæ‰€æœ‰åœºæ¬¡</button>
          </div>
        </div>
      {% endif %}
      
      <!-- å¾ªç¯èµ›å†…å®¹æ˜¾ç¤ºï¼ˆä»…é™t_formatä¸º4,5,6çš„èµ›äº‹ï¼‰ -->
      {% if tournament.t_format in [4, 5, 6] and group_stage_data and group_stage_data.groups %}
        <!-- å°ç»„å¯¼èˆªï¼ˆå°èµ›ä»ç¬¬2å±Šèµ·ç¦ç”¨ï¼‰ -->
        {% if not (tournament.type == 2 and tournament.type_session_number >= 2) %}
        <div class="group-navigation">
          {% for group in group_stage_data.groups %}
            <button onclick="showGroup('{{ group.t_name }}')" class="group-btn {% if loop.first %}active{% endif %}" id="btn-{{ group.t_name }}">{{ group.t_name }}ç»„</button>
          {% endfor %}
                    </div>
                  {% endif %}

        <!-- å°ç»„å†…å®¹ -->
        {% for group in group_stage_data.groups %}
          <div class="group-section" id="group-{{ group.t_name }}" {% if not loop.first and not (tournament.type == 2 and tournament.type_session_number >= 2) %}style="display: none;"{% endif %}>
            <!-- æ’ååˆ‡æ¢å¼€å…³ï¼ˆå¤§èµ›å’Œå°èµ›çš„å•å¾ªç¯èµ›ã€åŒå¾ªç¯èµ›æ˜¾ç¤ºï¼‰ -->
            {% if tournament.t_format in [4, 5] %}
            <div class="ranking-toggle">
              <div class="toggle-switch">
                <input type="radio" id="group-rank-{{ group.t_name }}" name="rank-type-{{ group.t_name }}" value="group" checked>
                <label for="group-rank-{{ group.t_name }}">å¾ªç¯èµ›æ’å</label>
                
                <input type="radio" id="total-rank-{{ group.t_name }}" name="rank-type-{{ group.t_name }}" value="total">
                <label for="total-rank-{{ group.t_name }}">æœ€ç»ˆæ’å</label>
                      </div>
                    </div>
        {% endif %}
            
            <!-- å¾ªç¯èµ›æ’åè¡¨æ ¼ -->
            <div class="group-ranking" id="roundRobinRanking">
              <h5>å¾ªç¯èµ›æ’å</h5>
              <!-- æ¡Œé¢ç«¯æ’åè¡¨æ ¼ -->
              <div class="desktop-ranking">
                <table class="table table-striped group-table">
                <thead>
                  <tr>
                    <th>æ’å</th>
                    <th>é€‰æ‰‹</th>
                    <th>åœºæ¬¡</th>
                    <th>èƒœ</th>
                    <th>å¹³</th>
                    <th>è´Ÿ</th>
                    <th>æ€»å¾—åˆ†</th>
                    <th>æ€»å¤±åˆ†</th>
                    <th>å‡€èƒœåˆ†</th>
                    <th>ç§¯åˆ†</th>
                  </tr>
                </thead>
                <tbody>
                    {% for player in group.players %}
                      <tr class="{% if tournament.type == 2 and tournament.type_session_number == 1 and tournament.t_format in [4, 5, 6] and player.group_rank <= 6 %}top6{% elif tournament.type == 2 and tournament.type_session_number >= 2 and tournament.t_format in [4, 5, 6] and player.group_rank in [3, 4] %}top6{% elif tournament.type == 3 and tournament.t_format == 1 and player.group_rank <= 8 %}top8{% elif tournament.type == 3 and tournament.t_format == 3 and player.group_rank <= 6 %}top6{% elif tournament.type == 3 and tournament.t_format in [4, 5, 6] and player.group_rank <= 2 %}top2{% elif tournament.t_format in [4, 5, 6] and player.group_rank <= 2 %}top2{% elif tournament.t_format in [4, 5, 6] and player.group_rank <= 6 %}top6{% endif %}">
                        <td><strong>{{ player.group_rank }}</strong></td>
                        <td><a href="/player/{{ player.player_id }}">{{ player.name }}</a></td>
                        <td style="{% if player.total_matches == player.wins + player.draws + player.losses %}background-color: rgba(205,255,155,0.75); font-weight: bold;{% endif %}">
                          {{ player.wins + player.draws + player.losses }}
                        </td>
                        <td>{{ player.wins }}</td>
                        <td>{{ player.draws }}</td>
                        <td>{{ player.losses }}</td>
                        <td>{{ player.goals_for }}</td>
                        <td>{{ player.goals_against }}</td>
                        <td>{{ player.goal_difference }}</td>
                        <td style="font-weight: bold;">{{ player.points }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
              
              <!-- ç§»åŠ¨ç«¯æ’åå¡ç‰‡ -->
              <div class="mobile-ranking">
                {% for player in group.players %}
                  <div class="player-card {% if tournament.type == 2 and tournament.type_session_number == 1 and tournament.t_format in [4, 5, 6] and player.group_rank <= 6 %}top6{% elif tournament.type == 2 and tournament.type_session_number >= 2 and tournament.t_format in [4, 5, 6] and player.group_rank in [3, 4] %}top6{% elif tournament.type == 3 and tournament.t_format == 1 and player.group_rank <= 8 %}top8{% elif tournament.type == 3 and tournament.t_format == 3 and player.group_rank <= 6 %}top6{% elif tournament.type == 3 and tournament.t_format in [4, 5, 6] and player.group_rank <= 2 %}top2{% elif tournament.t_format in [4, 5, 6] and player.group_rank <= 2 %}top2{% elif tournament.t_format in [4, 5, 6] and player.group_rank <= 6 %}top6{% endif %}">
                      <div class="player-info">
                      <span class="player-name"><a href="/player/{{ player.player_id }}">{{ player.name }}</a></span>
                        <!-- <div class="points-display">{{ player.points }} åˆ†</div> -->
                      </div>
                    <div class="player-stats">
                      <div class="stat-item">
                        <span class="stat-label">ç§¯åˆ†</span>
                        <span class="stat-value">{{ player.points }}</span>
                    </div>
                      <div class="stat-item">
                        <span class="stat-label">èƒœ</span>
                        <span class="stat-value">{{ player.wins }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">å¹³</span>
                        <span class="stat-value">{{ player.draws }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">è´Ÿ</span>
                        <span class="stat-value">{{ player.losses }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">å‡€èƒœåˆ†</span>
                        <span class="stat-value">{{ player.goal_difference }}</span>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
            
            <!-- æœ€ç»ˆæ€»æ’åï¼ˆå¤§èµ›å’Œå°èµ›çš„å•å¾ªç¯èµ›ã€åŒå¾ªç¯èµ›æ˜¾ç¤ºï¼Œä¸”é‡‘ç‰Œèµ›é“œç‰Œèµ›å®Œæˆåæ‰æ˜¾ç¤ºï¼‰ -->
            {% if tournament.t_format in [4, 5] and loop.first %}
              {% set gold_bronze_completed = false %}
              {% if knockout_matches %}
                {% set gold_matches = knockout_matches|selectattr('m_type', 'equalto', 12)|list %}
                {% set bronze_matches = knockout_matches|selectattr('m_type', 'equalto', 11)|list %}
                {% if gold_matches and bronze_matches %}
                  {% set gold_completed = gold_matches|selectattr('player_1_score', 'defined')|selectattr('player_2_score', 'defined')|list %}
                  {% set bronze_completed = bronze_matches|selectattr('player_1_score', 'defined')|selectattr('player_2_score', 'defined')|list %}
                  {% if gold_completed|length == gold_matches|length and bronze_completed|length == bronze_matches|length %}
                    {% set gold_bronze_completed = true %}
                  {% endif %}
                {% endif %}
              {% endif %}
              
              {% if gold_bronze_completed %}
                <div class="group-ranking final-ranking-section" style="display: block;">
              {% else %}
                <div class="group-ranking final-ranking-section" style="display: none;">
              {% endif %}
                  <h5>ğŸ† æœ€ç»ˆæ€»æ’å</h5>
                  <!-- æ¡Œé¢ç«¯æœ€ç»ˆæ’åè¡¨æ ¼ï¼ˆå¤ç”¨å¾ªç¯èµ›æ’åè¡¨æ ¼ä»£ç ï¼‰ -->
                  <div class="desktop-ranking">
                    <table class="table table-striped group-table">
                    <thead>
                      <tr>
                        <th>æ’å</th>
                        <th>é€‰æ‰‹</th>
                        <th>åœºæ¬¡</th>
                        <th>èƒœ</th>
                        <th>å¹³</th>
                        <th>è´Ÿ</th>
                        <th>æ€»å¾—åˆ†</th>
                        <th>æ€»å¤±åˆ†</th>
                        <th>å‡€èƒœåˆ†</th>
                        <th>ç§¯åˆ†</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% if minor_knockout_data and minor_knockout_data.final_rankings %}
                        {% for player in minor_knockout_data.final_rankings %}
                          {% set final_rank = player.final_rank or player.rank %}
                          <tr class="medal-row {% if final_rank == 1 %}gold-medal{% elif final_rank == 2 %}silver-medal{% elif final_rank == 3 %}bronze-medal{% elif final_rank == 4 %}fourth-place{% endif %}">
                            <td>
                              {% if final_rank == 1 %}
                              <span class="medal-icon">ğŸ¥‡</span>
                              {% elif final_rank == 2 %}
                              <span class="medal-icon">ğŸ¥ˆ</span>
                              {% elif final_rank == 3 %}
                              <span class="medal-icon">ğŸ¥‰</span>
                              {% elif final_rank == 4 %}
                              <span class="medal-icon">ğŸ…</span>
                              {% endif %}
                              <strong>{{ final_rank }}</strong>
                            </td>
                            <td><a href="/player/{{ player.player_id }}">{{ player.name }}</a></td>
                            <td style="{% if player.total_matches == player.wins + player.draws + player.losses %}background-color: rgba(205,255,155,0.75); font-weight: bold;{% endif %}">
                              {{ player.wins + player.draws + player.losses }}
                            </td>
                            <td>{{ player.wins }}</td>
                            <td>{{ player.draws }}</td>
                            <td>{{ player.losses }}</td>
                            <td>{{ player.goals_for }}</td>
                            <td>{{ player.goals_against }}</td>
                            <td>{{ player.goal_difference }}</td>
                            <td style="font-weight: bold;">{{ player.final_points or player.points }}</td>
                        </tr>
                      {% endfor %}
                      {% endif %}
                    </tbody>
                  </table>
                </div>
                  
                <!-- ç§»åŠ¨ç«¯æœ€ç»ˆæ’åå¡ç‰‡ï¼ˆå¤ç”¨å¾ªç¯èµ›æ’åå¡ç‰‡ä»£ç ï¼‰ -->
                <div class="mobile-ranking">
                  {% if minor_knockout_data and minor_knockout_data.final_rankings %}
                  {% for player in minor_knockout_data.final_rankings %}
                    {% set final_rank = player.final_rank or player.rank %}
                    <div class="player-card medal-card {% if final_rank == 1 %}gold-card{% elif final_rank == 2 %}silver-card{% elif final_rank == 3 %}bronze-card{% elif final_rank == 4 %}fourth-card{% endif %}">
                        <div class="player-info">
                          <span class="player-name">
                          {% if final_rank == 1 %}
                          <span class="medal-icon">ğŸ¥‡</span>
                          {% elif final_rank == 2 %}
                          <span class="medal-icon">ğŸ¥ˆ</span>
                          {% elif final_rank == 3 %}
                          <span class="medal-icon">ğŸ¥‰</span>
                          {% elif final_rank == 4 %}
                          <span class="medal-icon">ğŸ…</span>
                          {% endif %}
                            <a href="/player/{{ player.player_id }}">{{ player.name }}</a>
                          </span>
                        </div>
                        <div class="player-stats">
                          <div class="stat-item">
                            <span class="stat-label">ç§¯åˆ†</span>
                            <span class="stat-value">{{ player.final_points or player.points }}</span>
                      </div>
                        <div class="stat-item">
                          <span class="stat-label">èƒœ</span>
                            <span class="stat-value">{{ player.wins }}</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label">å¹³</span>
                            <span class="stat-value">{{ player.draws }}</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label">è´Ÿ</span>
                            <span class="stat-value">{{ player.losses }}</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label">å‡€èƒœåˆ†</span>
                            <span class="stat-value">{{ player.goal_difference }}</span>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
            {% endif %}
                </div>
                </div>
                
              <!-- å°èµ›é‡‘ç‰Œèµ›ã€é“œç‰Œèµ›ï¼ˆåœ¨æœ€ç»ˆæ’åä¸­æ˜¾ç¤ºï¼Œæ²¿ç”¨å¾ªç¯èµ›æ§ä»¶ï¼‰ -->
              {% if tournament.type == 2 and tournament.type_session_number >= 2 and tournament.t_format in [4, 5] and loop.first %}
                {% set gold_matches = knockout_matches|selectattr('m_type', 'equalto', 12)|list %}
                {% set bronze_matches = knockout_matches|selectattr('m_type', 'equalto', 11)|list %}
                {% if gold_matches or bronze_matches %}
                  <!-- æ¯”èµ›ç»“æœ - è‡ªé€‚åº”å¡ç‰‡æ ·å¼ -->
            <div class="group-matches">
              <div class="matches-grid">
                      <!-- é‡‘ç‰Œèµ› -->
                      {% if gold_matches %}
                        {% for match in gold_matches %}
                          {% if match.player_1_id and match.player_2_id %}
                          <div class="match-card gold-match-card" 
                data-group="{{ group.t_name }}" 
                               data-player1="{{ match.player1.name if match.player1 else 'å¾…å®š' }}" 
                               data-player2="{{ match.player2.name if match.player2 else 'å¾…å®š' }}"
                data-status="{% if match.player_1_score is not none and match.player_2_score is not none and not (match.player_1_score == 0 and match.player_2_score == 0) %}completed{% else %}pending{% endif %}"
                data-group-name="{{ group.t_name }}">
                  <div class="match-header">
                              <span class="match-title">ğŸ¥‡ é‡‘ç‰Œèµ›</span>
                  </div>
                  <div class="match-players">
                    <div class="player-info">
                                <span class="player-name">{{ match.player1.name if match.player1 else 'å¾…å®š' }}</span>
                      <div class="score-display">
                          {% if session.get('admin_logged_in') %}
                                    <input type="number" class="score-input" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}" min="0" 
                                           data-match-id="{{ match.m_id }}" data-player="1">
                          {% else %}
                                    <span class="score {% if match.player_1_score > match.player_2_score %}winner_1{% elif match.player_1_score == match.player_2_score and match.player_1_score > 0 %}tier_1{% endif %}">{{ match.player_1_score if match.player_1_score >= 0 else '' }}</span>
                        {% endif %}
                      </div>
                    </div>
                    <div class="vs-divider">VS</div>
                    <div class="player-info">
                                <span class="player-name">{{ match.player2.name if match.player2 else 'å¾…å®š' }}</span>
                      <div class="score-display">
                          {% if session.get('admin_logged_in') %}
                                  <input type="number" class="score-input" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}" min="0" 
                                         data-match-id="{{ match.m_id }}" data-player="2">
                          {% else %}
                                  <span class="score {% if match.player_2_score > match.player_1_score %}winner_2{% elif match.player_2_score == match.player_1_score and match.player_2_score > 0 %}tier_2{% endif %}">{{ match.player_2_score if match.player_2_score >= 0 else '' }}</span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% if session.get('admin_logged_in') %}
                    <div class="match-actions">
                                <button class="btn btn-sm btn-primary" onclick="submitKnockoutScore({{ match.m_id|tojson }})" 
                                        {% if match.player_1_score < 0 or match.player_2_score < 0 %}disabled{% endif %}>
                                  æäº¤
                      </button>
                    </div>
                  {% endif %}
                </div>
                          {% endif %}
        {% endfor %}
      {% endif %}
      
                      <!-- é“œç‰Œèµ› -->
                      {% if bronze_matches %}
                        {% for match in bronze_matches %}
                          {% if match.player_1_id and match.player_2_id %}
                          <div class="match-card bronze-match-card" 
                               data-group="{{ group.t_name }}" 
                               data-player1="{{ match.player1.name if match.player1 else 'å¾…å®š' }}" 
                               data-player2="{{ match.player2.name if match.player2 else 'å¾…å®š' }}"
                               data-status="{% if match.player_1_score is not none and match.player_2_score is not none and not (match.player_1_score == 0 and match.player_2_score == 0) %}completed{% else %}pending{% endif %}"
                               data-group-name="{{ group.t_name }}">
                  <div class="match-header">
                              <span class="match-title">ğŸ¥‰ é“œç‰Œèµ›</span>
                  </div>
                  <div class="match-players">
                    <div class="player-info">
                                <span class="player-name">{{ match.player1.name if match.player1 else 'å¾…å®š' }}</span>
                      <div class="score-display">
                          {% if session.get('admin_logged_in') %}
                                    <input type="number" class="score-input" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}" min="0" 
                                           data-match-id="{{ match.m_id }}" data-player="1">
                          {% else %}
                                    <span class="score {% if match.player_1_score > match.player_2_score %}winner_1{% elif match.player_1_score == match.player_2_score and match.player_1_score > 0 %}tier_1{% endif %}">{{ match.player_1_score if match.player_1_score >= 0 else '' }}</span>
                        {% endif %}
                      </div>
                    </div>
                    <div class="vs-divider">VS</div>
                    <div class="player-info">
                                <span class="player-name">{{ match.player2.name if match.player2 else 'å¾…å®š' }}</span>
                      <div class="score-display">
                          {% if session.get('admin_logged_in') %}
                                  <input type="number" class="score-input" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}" min="0" 
                                         data-match-id="{{ match.m_id }}" data-player="2">
                          {% else %}
                                  <span class="score {% if match.player_2_score > match.player_1_score %}winner_2{% elif match.player_2_score == match.player_1_score and match.player_2_score > 0 %}tier_2{% endif %}">{{ match.player_2_score if match.player_2_score >= 0 else '' }}</span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% if session.get('admin_logged_in') %}
                    <div class="match-actions">
                                <button class="btn btn-sm btn-primary" onclick="submitKnockoutScore({{ match.m_id|tojson }})" 
                                        {% if match.player_1_score < 0 or match.player_2_score < 0 %}disabled{% endif %}>
                                  æäº¤
                      </button>
                    </div>
                  {% endif %}
            </div>
          {% endif %}
                        {% endfor %}
                  {% endif %}
                </div>
                </div>
                    {% endif %}
              {% endif %}
          {% endif %}
          
            <!-- æ¯”èµ›ç»“æœ - è‡ªé€‚åº”å¡ç‰‡æ ·å¼ -->
            <div class="group-matches">
              <div class="matches-grid">
                {% for match in group.matches %}
                <div class="match-card" 
                data-group="{{ group.t_name }}" 
                data-player1="{{ match.player1.name }}" 
                data-player2="{{ match.player2.name }}"
                data-status="{% if match.player_1_score is not none and match.player_2_score is not none and not (match.player_1_score == 0 and match.player_2_score == 0) %}completed{% else %}pending{% endif %}"
                data-group-name="{{ group.t_name }}">
                  <div class="match-header">
                      <span class="match-title">{% if match.m_type == 14 %}é™„åŠ èµ›{% else %}ç¬¬{{ loop.index }}åœº{% endif %}</span>
                  </div>
                  <div class="match-players">
                    <div class="player-info">
                      <span class="player-name">{{ match.player1.name }}</span>
                        {% if match.m_type == 2 %}
                        <span class="home-away-tag home">ä¸»</span>
                        {% elif match.m_type == 3 %}
                          <span class="home-away-tag away">å®¢</span>
                      {% endif %}
                      <div class="score-display">
                          {% if match.player_1_score is not none and match.player_2_score is not none and match.player_1_score >= 0 and match.player_2_score >= 0 %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                     data-match-id="{{ match.m_id }}" data-player="1" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}">
                          {% else %}
                            <span class="score {% if match.player_1_score > match.player_2_score %}winner_1{% elif match.player_1_score == match.player_2_score and match.player_1_score > 0 %}tier_1{% endif %}">{{ match.player_1_score }}</span>
                          {% endif %}
                        {% else %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                     data-match-id="{{ match.m_id }}" data-player="1" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}">
                          {% else %}
                            <span class="score">-</span>
                          {% endif %}
                        {% endif %}
                      </div>
                    </div>
                    <div class="vs-divider">VS</div>
                    <div class="player-info">
                      <span class="player-name">{{ match.player2.name }}</span>
                        {% if match.m_type == 2 %}
                        <span class="home-away-tag away">å®¢</span>
                        {% elif match.m_type == 3 %}
                          <span class="home-away-tag home">ä¸»</span>
                      {% endif %}
                      <div class="score-display">
                          {% if match.player_1_score is not none and match.player_2_score is not none and match.player_1_score >= 0 and match.player_2_score >= 0 %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                     data-match-id="{{ match.m_id }}" data-player="2" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}">
                          {% else %}
                            <span class="score {% if match.player_2_score > match.player_1_score %}winner_2{% elif match.player_2_score == match.player_1_score and match.player_2_score > 0 %}tier_2{% endif %}">{{ match.player_2_score }}</span>
                          {% endif %}
                        {% else %}
                          {% if session.get('admin_logged_in') %}
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" 
                                     data-match-id="{{ match.m_id }}" data-player="2" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}">
                          {% else %}
                            <span class="score">-</span>
                          {% endif %}
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% if session.get('admin_logged_in') %}
                    <div class="match-actions">
                        <button onclick="submitScore({{ match.m_id }})" class="btn btn-sm btn-primary" 
                                {% if match.player_1_score is none or match.player_2_score is none %}disabled{% endif %}>
                          æäº¤æ¯”åˆ†
                      </button>
                    </div>
                  {% endif %}
                </div>
                {% endfor %}
              </div>
            </div>
        </div>
        {% endfor %}
      {% endif %}
    {% endif %}
  </div>

  <!-- æ·˜æ±°èµ›é¡µé¢ -->
  <div id="page-knockout" class="page-content">
    <!-- <h3>æ·˜æ±°èµ›</h3> -->
    
    <!-- 1/4å†³èµ›é€‰æ‹©æ¨¡å—ï¼ˆä»…é™t_formatä¸º1çš„èµ›äº‹ï¼‰ -->
    {% if tournament.t_format == 1 and group_stage_data and group_stage_data.groups and has_groups and has_players %}
      {% set quarterfinal_matches = knockout_matches|selectattr('m_type', 'equalto', 8)|list %}
      {% if not quarterfinal_matches %}
        <div class="knockout-module">
          <h4>ğŸ† 1/4å†³èµ›è®¾ç½®</h4>
          <p>å°ç»„èµ›å·²å®Œæˆï¼Œè¯·é€‰æ‹©1/4å†³èµ›çš„ç”Ÿæˆæ–¹å¼</p>
          
          <!-- 1/4å†³èµ›ç±»å‹é€‰æ‹© -->
          <div class="quarterfinal-type-options">
            <h6>1/4å†³èµ›ç±»å‹</h6>
            <div class="quarterfinal-type-group">
              <div class="quarterfinal-type-option" onclick="selectQuarterfinalType('direct')">
                <input type="radio" name="quarterfinal-type" value="direct" id="quarterfinal-direct">
                <label for="quarterfinal-direct">ç›´æ¥æ¨¡å¼</label>
          </div>
              <div class="quarterfinal-type-option" onclick="selectQuarterfinalType('qualifier')">
                <input type="radio" name="quarterfinal-type" value="qualifier" id="quarterfinal-qualifier">
                <label for="quarterfinal-qualifier">èµ„æ ¼èµ›æ¨¡å¼</label>
          </div>
              <div class="quarterfinal-type-option" onclick="selectQuarterfinalType('manual')">
                <input type="radio" name="quarterfinal-type" value="manual" id="quarterfinal-manual">
                <label for="quarterfinal-manual">æ‰‹åŠ¨æŒ‡å®šä½æ¬¡</label>
        </div>
              <div class="quarterfinal-type-option" onclick="selectQuarterfinalType('random')">
                <input type="radio" name="quarterfinal-type" value="random" id="quarterfinal-random">
                <label for="quarterfinal-random">éšæœºä½æ¬¡</label>
      </div>
      </div>
            
            <!-- éšæœºä½æ¬¡å­é€‰é¡¹ -->
            <div id="random-sub-options" style="display: none;">
              <div class="random-sub-group">
                <div class="random-sub-option" onclick="selectRandomSubOption('avoid')">
                  <input type="radio" name="random-sub-option" value="avoid" id="random-avoid">
                  <label for="random-avoid">å›é¿åŒç»„</label>
                </div>
                <div class="random-sub-option" onclick="selectRandomSubOption('allow')">
                  <input type="radio" name="random-sub-option" value="allow" id="random-allow">
                  <label for="random-allow">ä¸å›é¿åŒç»„</label>
                </div>
              </div>
            </div>
          </div>
          
          <!-- æ‰‹åŠ¨æŒ‡å®šä½æ¬¡é€‰æ‹©ç•Œé¢ -->
          <div id="manual-position-selection" style="display: none;">
            <h6>æ‰‹åŠ¨æŒ‡å®šä½æ¬¡</h6>
            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
              è¯·ä¸ºæ¯ä¸ªä½æ¬¡é€‰æ‹©å¯¹åº”çš„é€‰æ‰‹ã€‚1/4å†³èµ›å¯¹é˜µï¼š1ä½ vs 8ä½ï¼Œ4ä½ vs 5ä½ï¼Œ2ä½ vs 7ä½ï¼Œ3ä½ vs 6ä½
            </p>
            
            <!-- ä¸ŠåŠåŒº -->
            <div class="half-section">
              <h6 style="color: #007bff; margin-bottom: 10px;">ä¸ŠåŠåŒº</h6>
              <div class="position-selection-grid">
                <div class="position-slot">
                  <label>1ä½ (ç§å­ä½)</label>
                  <select id="position-1" class="form-control">
                    <option value="">é€‰æ‹©é€‰æ‰‹</option>
                  </select>
                </div>
                <div class="position-slot">
                  <label>8ä½</label>
                  <select id="position-8" class="form-control">
                    <option value="">é€‰æ‹©é€‰æ‰‹</option>
                  </select>
                </div>
                <div class="position-slot">
                  <label>4ä½</label>
                  <select id="position-4" class="form-control">
                    <option value="">é€‰æ‹©é€‰æ‰‹</option>
                  </select>
                </div>
                <div class="position-slot">
                  <label>5ä½</label>
                  <select id="position-5" class="form-control">
                    <option value="">é€‰æ‹©é€‰æ‰‹</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- ä¸‹åŠåŒº -->
            <div class="half-section">
              <h6 style="color: #28a745; margin-bottom: 10px;">ä¸‹åŠåŒº</h6>
              <div class="position-selection-grid">
                <div class="position-slot">
                  <label>2ä½ (ç§å­ä½)</label>
                  <select id="position-2" class="form-control">
                    <option value="">é€‰æ‹©é€‰æ‰‹</option>
                  </select>
                </div>
                <div class="position-slot">
                  <label>7ä½</label>
                  <select id="position-7" class="form-control">
                    <option value="">é€‰æ‹©é€‰æ‰‹</option>
                  </select>
                </div>
                <div class="position-slot">
                  <label>3ä½</label>
                  <select id="position-3" class="form-control">
                    <option value="">é€‰æ‹©é€‰æ‰‹</option>
                  </select>
                </div>
                <div class="position-slot">
                  <label>6ä½</label>
                  <select id="position-6" class="form-control">
                    <option value="">é€‰æ‹©é€‰æ‰‹</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          
          <div class="module-actions">
            <button onclick="generateQuarterfinal()" class="btn btn-primary">ç”Ÿæˆ1/4å†³èµ›</button>
          </div>
          <div class="module-status"></div>
        </div>
        
        <!-- å‡é™èµ›æ¨¡å— -->
        <div id="promotion-relegation-module" class="tournament-module" style="display: none;">
          <h5>å‡é™èµ›ç®¡ç†</h5>
          <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
            å‡é™èµ›é‡‡ç”¨æ’åºç½‘ç»œé€»è¾‘ï¼Œé€šè¿‡4è½®æ¯”èµ›ç¡®å®šæœ€ç»ˆæ’åã€‚æ¯è½®æ¯”èµ›å®Œæˆåæ‰èƒ½ç”Ÿæˆä¸‹ä¸€è½®ã€‚
          </p>
          
          <div class="promotion-relegation-controls">
            <button onclick="generatePromotionRelegation()" class="btn btn-success">ç”Ÿæˆå‡é™èµ›</button>
            <button onclick="checkPromotionRelegationStatus()" class="btn btn-info">æ£€æŸ¥çŠ¶æ€</button>
          </div>
          
          <div class="promotion-relegation-status" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;">
            <h6>å‡é™èµ›çŠ¶æ€</h6>
            <div id="promotion-relegation-info"></div>
          </div>
        </div>
        
      {% endif %}
    {% endif %}


    
    {% if knockout_matches %}
      <div class="knockout-grid-container">
        <h4 style="color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px;">æ·˜æ±°èµ›å¯¹é˜µ</h4>
        
        <!-- æ»‘åŠ¨å¯¼èˆªï¼ˆä»…åœ¨çª„å±æ—¶æ˜¾ç¤ºï¼‰ -->
        <div class="sliding-nav" style="display: none;">
          <!-- <button class="slide-btn prev" onclick="slideKnockoutGrid(-1)">â€¹</button> -->
          <div class="slide-indicators">
            {% set semifinal_qualifier_matches = knockout_matches|selectattr('m_type', 'equalto', 9)|list %}
            {% set quarterfinal_matches = knockout_matches|selectattr('m_type', 'equalto', 8)|list %}
            {% set semifinal_matches = knockout_matches|selectattr('m_type', 'equalto', 10)|list %}
            {% set gold_matches = knockout_matches|selectattr('m_type', 'equalto', 12)|list %}
            {% set bronze_matches = knockout_matches|selectattr('m_type', 'equalto', 11)|list %}
            
            {% if semifinal_qualifier_matches %}
              <span class="slide-indicator active" data-slide="0" onclick="goToSlide(0)">åŠå†³èµ›èµ„æ ¼èµ›</span>
    {% endif %}
    
            {% if quarterfinal_matches %}
              <span class="slide-indicator {% if not semifinal_qualifier_matches %}active{% endif %}" 
                    data-slide="{% if semifinal_qualifier_matches %}1{% else %}0{% endif %}" 
                    onclick="goToSlide({% if semifinal_qualifier_matches %}1{% else %}0{% endif %})">1/4å†³èµ›</span>
      {% endif %}
            
            {% if semifinal_matches %}
              <span class="slide-indicator {% if not semifinal_qualifier_matches and not quarterfinal_matches %}active{% endif %}" 
                    data-slide="{% if semifinal_qualifier_matches and quarterfinal_matches %}2{% elif semifinal_qualifier_matches or quarterfinal_matches %}1{% else %}0{% endif %}" 
                    onclick="goToSlide({% if semifinal_qualifier_matches and quarterfinal_matches %}2{% elif semifinal_qualifier_matches or quarterfinal_matches %}1{% else %}0{% endif %})">åŠå†³èµ›</span>
            {% endif %}
            
            {% if gold_matches or bronze_matches %}
              <span class="slide-indicator {% if not semifinal_qualifier_matches and not quarterfinal_matches and not semifinal_matches %}active{% endif %}" 
                    data-slide="{% if semifinal_qualifier_matches and quarterfinal_matches and semifinal_matches %}3{% elif (semifinal_qualifier_matches and quarterfinal_matches) or (semifinal_qualifier_matches and semifinal_matches) or (quarterfinal_matches and semifinal_matches) %}2{% elif semifinal_qualifier_matches or quarterfinal_matches or semifinal_matches %}1{% else %}0{% endif %}" 
                    onclick="goToSlide({% if semifinal_qualifier_matches and quarterfinal_matches and semifinal_matches %}3{% elif (semifinal_qualifier_matches and quarterfinal_matches) or (semifinal_qualifier_matches and semifinal_matches) or (quarterfinal_matches and semifinal_matches) %}2{% elif semifinal_qualifier_matches or quarterfinal_matches or semifinal_matches %}1{% else %}0{% endif %})">å†³èµ›</span>
                        {% endif %}
                      </div>
          <!-- <button class="slide-btn next" onclick="slideKnockoutGrid(1)">â€º</button> -->
                    </div>
        
        <div class="knockout-grid">
          <!-- åŠå†³èµ›èµ„æ ¼èµ›é˜¶æ®µ -->
          {% set semifinal_qualifier_matches = knockout_matches|selectattr('m_type', 'equalto', 9)|list %}
          {% if semifinal_qualifier_matches %}
            <div class="knockout-stage">
              <!-- <h5 class="stage-title">åŠå†³èµ›èµ„æ ¼èµ›</h5> -->
              <div class="stage-matches">
                {% for match in semifinal_qualifier_matches %}
                <div class="knockout-card-qualifier">
                  <div class="knockout-card-players">
                    <div class="knockout-card-player {% if match.player_1_score > match.player_2_score %}winner{% endif %}">
                      <span>{{ match.player1.name }}</span>
                    {% if session.get('admin_logged_in') %}
                        <input type="number" class="knockout-card-score" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}" min="0" 
                               data-match-id="{{ match.m_id }}" data-player="1">
                    {% else %}
                        <span class="knockout-card-score">{{ match.player_1_score }}</span>
                    {% endif %}
                  </div>
                    <div class="knockout-card-player {% if match.player_2_score > match.player_1_score %}winner{% endif %}">
                      <span>{{ match.player2.name }}</span>
                    {% if session.get('admin_logged_in') %}
                        <input type="number" class="knockout-card-score" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}" min="0" 
                               data-match-id="{{ match.m_id }}" data-player="2">
                    {% else %}
                        <span class="knockout-card-score">{{ match.player_2_score }}</span>
                    {% endif %}
                    </div>
                  </div>
                  {% if session.get('admin_logged_in') %}
                    <div class="knockout-card-actions">
                      <button class="btn btn-sm btn-primary" onclick="submitKnockoutScore({{ match.m_id|tojson }})" 
                              {% if match.player_1_score < 0 or match.player_2_score < 0 %}disabled{% endif %}>
                        æäº¤
                      </button>
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
              </div>
            </div>
          {% endif %}
          
          <!-- 1/4å†³èµ›é˜¶æ®µ -->
          {% set quarterfinal_matches = knockout_matches|selectattr('m_type', 'equalto', 8)|list %}
          {% if quarterfinal_matches %}
            <div class="knockout-stage">
              <!-- <h5 class="stage-title">1/4å†³èµ›</h5> -->
              <div class="stage-matches">
              {% for match in quarterfinal_matches %}
                <div class="knockout-card-quarterfinal">
                  <div class="knockout-card-players">
                    <div class="knockout-card-player {% if match.player_1_score > match.player_2_score %}winner{% endif %}">
                      <span>
                        {% if match.player_1_id == -1 %}
                          å¾…èµ„æ ¼èµ›ç»“æœ
                  {% else %}
                          {{ match.player1.name if match.player1 else 'å¾…å®š' }}
                  {% endif %}
                      </span>
                      {% if match.player_1_id != -1 %}
                      {% if session.get('admin_logged_in') %}
                          <input type="number" class="knockout-card-score" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}" min="0" 
                                 data-match-id="{{ match.m_id }}" data-player="1">
                      {% else %}
                          <span class="knockout-card-score">{{ match.player_1_score }}</span>
                      {% endif %}
                    {% else %}
                        <span class="knockout-card-score">-</span>
                    {% endif %}
                  </div>
                    <div class="knockout-card-player {% if match.player_2_score > match.player_1_score %}winner{% endif %}">
                      <span>
                      {% if match.player_2_id == -1 %}
                        å¾…èµ„æ ¼èµ›ç»“æœ
                      {% else %}
                        {{ match.player2.name if match.player2 else 'å¾…å®š' }}
                      {% endif %}
                    </span>
                    {% if match.player_2_id != -1 %}
                      {% if session.get('admin_logged_in') %}
                          <input type="number" class="knockout-card-score" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}" min="0" 
                                 data-match-id="{{ match.m_id }}" data-player="2">
                      {% else %}
                          <span class="knockout-card-score">{{ match.player_2_score }}</span>
                      {% endif %}
                    {% else %}
                        <span class="knockout-card-score">-</span>
                    {% endif %}
                  </div>
                  </div>
                  {% if session.get('admin_logged_in') and match.player_1_id != -1 and match.player_2_id != -1 %}
                    <div class="knockout-card-actions">
                      <button class="btn btn-sm btn-primary" onclick="submitKnockoutScore({{ match.m_id|tojson }})" 
                              {% if match.player_1_score < 0 or match.player_2_score < 0 %}disabled{% endif %}>
                        æäº¤
                      </button>
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
                    </div>
            </div>
          {% endif %}
          
          <!-- åŠå†³èµ›é˜¶æ®µ -->
          {% set semifinal_matches = knockout_matches|selectattr('m_type', 'equalto', 10)|list %}
          {% if semifinal_matches %}
            <div class="knockout-stage">
              <!-- <h5 class="stage-title">åŠå†³èµ›</h5> -->
              <div class="stage-matches">
                {% for match in semifinal_matches %}
                  {% if match.player_1_id and match.player_2_id %}
                  <div class="knockout-card-semifinal">
                    <div class="knockout-card-players">
                      <div class="knockout-card-player {% if match.player_1_score > match.player_2_score %}winner{% endif %}">
                        <span>{{ match.player1.name if match.player1 else 'å¾…å®š' }}</span>
                          {% if session.get('admin_logged_in') %}
                          <input type="number" class="knockout-card-score" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}" min="0" 
                                 data-match-id="{{ match.m_id }}" data-player="1">
                          {% else %}
                          <span class="knockout-card-score">{{ match.player_1_score if match.player_1_score >= 0 else '' }}</span>
                          {% endif %}
              </div>
                      <div class="knockout-card-player {% if match.player_2_score > match.player_1_score %}winner{% endif %}">
                        <span>{{ match.player2.name if match.player2 else 'å¾…å®š' }}</span>
                          {% if session.get('admin_logged_in') %}
                          <input type="number" class="knockout-card-score" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}" min="0" 
                                 data-match-id="{{ match.m_id }}" data-player="2">
                          {% else %}
                          <span class="knockout-card-score">{{ match.player_2_score if match.player_2_score >= 0 else '' }}</span>
                        {% endif %}
              </div>
            </div>
                  {% if session.get('admin_logged_in') %}
                      <div class="knockout-card-actions">
                        <button class="btn btn-sm btn-primary" onclick="submitKnockoutScore({{ match.m_id|tojson }})" 
                                {% if match.player_1_score < 0 or match.player_2_score < 0 %}disabled{% endif %}>
                          æäº¤
                      </button>
              </div>
                  {% endif %}
              </div>
          {% endif %}
                {% endfor %}
            </div>
          </div>
    {% endif %}
    
          <!-- å†³èµ›é˜¶æ®µï¼ˆé‡‘ç‰Œèµ›å’Œé“œç‰Œèµ›ï¼‰- å°èµ›ä»ç¬¬2å±Šèµ·ä¸æ˜¾ç¤º -->
          {% if not (tournament.type == 2 and tournament.type_session_number >= 2) %}
          {% set gold_matches = knockout_matches|selectattr('m_type', 'equalto', 12)|list %}
          {% set bronze_matches = knockout_matches|selectattr('m_type', 'equalto', 11)|list %}
          {% if gold_matches or bronze_matches %}
            <div class="knockout-stage">
              <!-- <h5 class="stage-title">å†³èµ›</h5> -->
              <div class="stage-matches">
                <!-- é‡‘ç‰Œèµ› -->
                {% if gold_matches %}
                  {% for match in gold_matches %}
                    {% if match.player_1_id and match.player_2_id %}
                    <div class="knockout-card-gold">
                      <div class="knockout-card-players">
                        <div class="knockout-card-player {% if match.player_1_score > match.player_2_score %}winner{% endif %}">
                          <span>{{ match.player1.name if match.player1 else 'å¾…å®š' }}</span>
                    {% if session.get('admin_logged_in') %}
                            <input type="number" class="knockout-card-score" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}" min="0" 
                                   data-match-id="{{ match.m_id }}" data-player="1">
                    {% else %}
                            <span class="knockout-card-score">{{ match.player_1_score if match.player_1_score >= 0 else '' }}</span>
                    {% endif %}
              </div>
                        <div class="knockout-card-player {% if match.player_2_score > match.player_1_score %}winner{% endif %}">
                          <span>{{ match.player2.name if match.player2 else 'å¾…å®š' }}</span>
                    {% if session.get('admin_logged_in') %}
                            <input type="number" class="knockout-card-score" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}" min="0" 
                                   data-match-id="{{ match.m_id }}" data-player="2">
                    {% else %}
                            <span class="knockout-card-score">{{ match.player_2_score if match.player_2_score >= 0 else '' }}</span>
                    {% endif %}
              </div>
            </div>
                  {% if session.get('admin_logged_in') %}
                        <div class="knockout-card-actions">
                          <button class="btn btn-sm btn-primary" onclick="submitKnockoutScore({{ match.m_id|tojson }})" 
                                  {% if match.player_1_score < 0 or match.player_2_score < 0 %}disabled{% endif %}>
                            æäº¤
                          </button>
              </div>
                  {% endif %}
              </div>
                    {% endif %}
              {% endfor %}
          {% endif %}
          
                <!-- é“œç‰Œèµ› -->
                {% if bronze_matches %}
                  {% for match in bronze_matches %}
                    {% if match.player_1_id and match.player_2_id %}
                    <div class="knockout-card-bronze">
                      <div class="knockout-card-players">
                        <div class="knockout-card-player {% if match.player_1_score > match.player_2_score %}winner{% endif %}">
                          <span>{{ match.player1.name if match.player1 else 'å¾…å®š' }}</span>
                      {% if session.get('admin_logged_in') %}
                            <input type="number" class="knockout-card-score" value="{{ match.player_1_score if match.player_1_score >= 0 else '' }}" min="0" 
                                   data-match-id="{{ match.m_id }}" data-player="1">
                      {% else %}
                            <span class="knockout-card-score">{{ match.player_1_score if match.player_1_score >= 0 else '' }}</span>
                    {% endif %}
            </div>
                        <div class="knockout-card-player {% if match.player_2_score > match.player_1_score %}winner{% endif %}">
                          <span>{{ match.player2.name if match.player2 else 'å¾…å®š' }}</span>
                      {% if session.get('admin_logged_in') %}
                            <input type="number" class="knockout-card-score" value="{{ match.player_2_score if match.player_2_score >= 0 else '' }}" min="0" 
                                   data-match-id="{{ match.m_id }}" data-player="2">
                      {% else %}
                            <span class="knockout-card-score">{{ match.player_2_score if match.player_2_score >= 0 else '' }}</span>
                    {% endif %}
          </div>
                      </div>
                      {% if session.get('admin_logged_in') %}
                        <div class="knockout-card-actions">
                          <button class="btn btn-sm btn-primary" onclick="submitKnockoutScore({{ match.m_id|tojson }})" 
                                  {% if match.player_1_score < 0 or match.player_2_score < 0 %}disabled{% endif %}>
                            æäº¤
                          </button>
                    </div>
                  {% endif %}
                </div>
                    {% endif %}
              {% endfor %}
          {% endif %}
              </div>
              </div>
          {% endif %}
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>

  <script>
    // ç®¡ç†å‘˜æ§åˆ¶é¢æ¿åˆ‡æ¢åŠŸèƒ½
    function toggleAdminControls() {
      const adminControls = document.querySelector('.admin-controls');
      const adminToggleSection = document.querySelector('.admin-toggle-section');
      const groupManagement = document.querySelector('.group-management');
      
      if (adminControls) {
        if (adminControls.style.display === 'none' || adminControls.style.display === '') {
          adminControls.style.display = 'block';
          if (adminToggleSection) adminToggleSection.style.display = 'none';
          if (groupManagement) groupManagement.style.display = 'none';
        } else {
          adminControls.style.display = 'none';
          if (adminToggleSection) adminToggleSection.style.display = 'block';
          if (groupManagement) groupManagement.style.display = 'block';
        }
      } else {
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°admin-controlsï¼Œå¯èƒ½æ˜¯å› ä¸ºæ¨¡æ¿æ¡ä»¶ï¼Œå°è¯•æ˜¾ç¤ºéšè—çš„æŒ‰é’®åŒºåŸŸ
        if (adminToggleSection) adminToggleSection.style.display = 'none';
        if (groupManagement) groupManagement.style.display = 'none';
        
        // åˆ›å»ºä¸´æ—¶ç®¡ç†é¢æ¿
        const tempPanel = document.createElement('div');
        tempPanel.className = 'admin-controls';
        tempPanel.style.display = 'block';
        tempPanel.innerHTML = '<h4>ç®¡ç†å‘˜æ§åˆ¶é¢æ¿</h4><p>è¯·åˆ·æ–°é¡µé¢ä»¥è·å–å®Œæ•´çš„ç®¡ç†åŠŸèƒ½</p><button onclick="location.reload()" class="btn btn-primary">åˆ·æ–°é¡µé¢</button>';
        
        if (adminToggleSection) {
          adminToggleSection.parentNode.insertBefore(tempPanel, adminToggleSection);
        } else if (groupManagement) {
          groupManagement.parentNode.insertBefore(tempPanel, groupManagement);
        }
      }
    }
    
    // æ’ååˆ‡æ¢åŠŸèƒ½
    function initRankingToggle() {
      // ä¸ºæ‰€æœ‰æ’ååˆ‡æ¢å¼€å…³æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      const toggleSwitches = document.querySelectorAll('.toggle-switch input[type="radio"]');
      toggleSwitches.forEach(radio => {
        radio.addEventListener('change', function() {
          const groupName = this.name.replace('rank-type-', '');
          const groupSection = document.getElementById('group-' + groupName);
          if (!groupSection) return;
          
          const groupRanking = groupSection.querySelector('.group-ranking');
          const finalRankingSection = groupSection.querySelector('.final-ranking-section');
          
          if (this.value === 'group') {
            // æ˜¾ç¤ºå°ç»„æ’åï¼Œéšè—æœ€ç»ˆæ€»æ’å
            if (groupRanking) groupRanking.style.display = 'block';
            if (finalRankingSection) finalRankingSection.style.display = 'none';
          } else if (this.value === 'total') {
            // æ˜¾ç¤ºæœ€ç»ˆæ€»æ’åï¼Œéšè—å°ç»„æ’å
            if (groupRanking) groupRanking.style.display = 'none';
            if (finalRankingSection) finalRankingSection.style.display = 'block';
          }
        });
      });
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      initRankingToggle();
      
      // å°èµ›ä»ç¬¬2å±Šèµ·ï¼Œåˆå§‹åŒ–æ‰€æœ‰å°ç»„çš„æ’ååˆ‡æ¢çŠ¶æ€
      {% if tournament.type == 2 and tournament.type_session_number >= 2 %}
        const allGroups = document.querySelectorAll('.group-section');
        allGroups.forEach(groupSection => {
          const groupRanking = groupSection.querySelector('.group-ranking:not(.final-ranking-section)');
          const finalRankingSection = groupSection.querySelector('.final-ranking-section');
          
          // é»˜è®¤æ˜¾ç¤ºå¾ªç¯èµ›æ’åï¼Œéšè—æœ€ç»ˆæ’å
          if (groupRanking) groupRanking.style.display = 'block';
          if (finalRankingSection) finalRankingSection.style.display = 'none';
        });
      {% endif %}
    });
    
    // å“åº”å¼æ»‘åŠ¨ç½‘æ ¼åŠŸèƒ½
    let currentSlide = 0;
    let totalSlides = 0;
    let isSliding = false;
    
    // åˆå§‹åŒ–æ»‘åŠ¨ç½‘æ ¼
    function initSlidingGrid() {
      const grid = document.querySelector('.knockout-grid');
      const nav = document.querySelector('.sliding-nav');
      
      if (!grid || !nav) return;
      
      // è®¡ç®—æ€»åˆ—æ•°
      const cards = grid.querySelectorAll('.knockout-card-qualifier, .knockout-card-quarterfinal, .knockout-card-semifinal, .knockout-card-gold, .knockout-card-bronze');
      totalSlides = Math.ceil(cards.length / getCardsPerSlide());
      
      // æ£€æŸ¥æ˜¯å¦éœ€è¦æ»‘åŠ¨æ¨¡å¼
      if (window.innerWidth <= 768 && totalSlides > 1) {
        nav.style.display = 'flex';
        grid.style.display = 'flex';
        grid.style.overflowX = 'auto';
        grid.style.scrollSnapType = 'x mandatory';
        
        // è®¾ç½®å¡ç‰‡å®½åº¦
        cards.forEach(card => {
          card.style.minWidth = '100%';
          card.style.scrollSnapAlign = 'start';
          card.style.marginRight = '20px';
        });
        
        // æ›´æ–°æŒ‡ç¤ºå™¨
        updateIndicators();
          } else {
        nav.style.display = 'none';
        grid.style.display = 'grid';
        grid.style.overflowX = 'visible';
      }
    }
    
    // è·å–æ¯å±æ˜¾ç¤ºçš„å¡ç‰‡æ•°é‡
    function getCardsPerSlide() {
      if (window.innerWidth <= 480) return 1;
      if (window.innerWidth <= 768) return 1;
      return 1; // ç§»åŠ¨ç«¯ç»Ÿä¸€æ˜¾ç¤º1ä¸ª
    }
    
    // æ›´æ–°æŒ‡ç¤ºå™¨
    function updateIndicators() {
      const indicators = document.querySelectorAll('.slide-indicator');
      indicators.forEach((indicator, index) => {
        if (index < totalSlides) {
          indicator.style.display = 'block';
          indicator.classList.toggle('active', index === currentSlide);
          } else {
          indicator.style.display = 'none';
        }
      });
    }
    
    // æ»‘åŠ¨åˆ°æŒ‡å®šä½ç½®
    function slideTo(slideIndex) {
      if (isSliding || slideIndex < 0 || slideIndex >= totalSlides) return;
      
      isSliding = true;
      currentSlide = slideIndex;
      
      const grid = document.querySelector('.knockout-grid');
      const cardWidth = grid.offsetWidth;
      const scrollPosition = slideIndex * cardWidth;
      
      // ä½¿ç”¨æ›´å¹³æ»‘çš„æ»šåŠ¨
      grid.scrollTo({
        left: scrollPosition,
        behavior: 'smooth'
      });
      
      updateIndicators();
      
      // å»¶è¿Ÿé‡ç½®æ»‘åŠ¨çŠ¶æ€ï¼Œç¡®ä¿æ»šåŠ¨å®Œæˆ
      setTimeout(() => {
        isSliding = false;
      }, 500);
    }
    
    // æ»‘åŠ¨ç½‘æ ¼
    function slideKnockoutGrid(direction) {
      const newSlide = currentSlide + direction;
      slideTo(newSlide);
    }
    
    // ç‚¹å‡»æŒ‡ç¤ºå™¨
    function goToSlide(slideIndex) {
      slideTo(slideIndex);
    }
    
    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    function handleResize() {
      initSlidingGrid();
    }
    
    // æ·»åŠ æ‹–æ‹½åŠŸèƒ½å’Œæ»šåŠ¨ç›‘å¬
    function initGridDrag() {
      const grid = document.querySelector('.knockout-grid');
      if (!grid) return;
      
      let isDragging = false;
      let startX = 0;
      let scrollLeft = 0;
      
      // é¼ æ ‡äº‹ä»¶
      grid.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.pageX - grid.offsetLeft;
        scrollLeft = grid.scrollLeft;
        grid.style.cursor = 'grabbing';
        grid.style.scrollBehavior = 'auto'; // ç¦ç”¨å¹³æ»‘æ»šåŠ¨
      });
      
      grid.addEventListener('mouseleave', () => {
        isDragging = false;
        grid.style.cursor = 'grab';
        grid.style.scrollBehavior = 'smooth'; // æ¢å¤å¹³æ»‘æ»šåŠ¨
      });
      
      grid.addEventListener('mouseup', () => {
        isDragging = false;
        grid.style.cursor = 'grab';
        grid.style.scrollBehavior = 'smooth'; // æ¢å¤å¹³æ»‘æ»šåŠ¨
        updateSlideFromScroll(); // æ›´æ–°å½“å‰æ»‘åŠ¨ä½ç½®
      });
      
      grid.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        const x = e.pageX - grid.offsetLeft;
        const walk = (x - startX) * 1.5; // å‡å°‘æ»‘åŠ¨æ•æ„Ÿåº¦
        grid.scrollLeft = scrollLeft - walk;
      });
      
      // è§¦æ‘¸äº‹ä»¶
      grid.addEventListener('touchstart', (e) => {
        isDragging = true;
        startX = e.touches[0].pageX - grid.offsetLeft;
        scrollLeft = grid.scrollLeft;
        grid.style.scrollBehavior = 'auto'; // ç¦ç”¨å¹³æ»‘æ»šåŠ¨
      });
      
      grid.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        const x = e.touches[0].pageX - grid.offsetLeft;
        const walk = (x - startX) * 1.5; // å‡å°‘æ»‘åŠ¨æ•æ„Ÿåº¦
        grid.scrollLeft = scrollLeft - walk;
      });
      
      grid.addEventListener('touchend', () => {
        isDragging = false;
        grid.style.scrollBehavior = 'smooth'; // æ¢å¤å¹³æ»‘æ»šåŠ¨
        updateSlideFromScroll(); // æ›´æ–°å½“å‰æ»‘åŠ¨ä½ç½®
      });
      
      // ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œæ›´æ–°æŒ‡ç¤ºå™¨çŠ¶æ€
      grid.addEventListener('scroll', () => {
        debouncedUpdateSlideFromScroll();
      });
    }
    
    // æ ¹æ®æ»šåŠ¨ä½ç½®æ›´æ–°å½“å‰æ»‘åŠ¨ä½ç½®
    function updateSlideFromScroll() {
      const grid = document.querySelector('.knockout-grid');
      if (!grid) return;
      
      const cardWidth = grid.offsetWidth;
      const scrollPosition = grid.scrollLeft;
      const newSlide = Math.round(scrollPosition / cardWidth);
      
      if (newSlide !== currentSlide && newSlide >= 0 && newSlide < totalSlides) {
        currentSlide = newSlide;
        updateIndicators();
      }
    }
    
    // é˜²æŠ–ç‰ˆæœ¬çš„æ»šåŠ¨æ›´æ–°å‡½æ•°
    let scrollUpdateTimeout;
    function debouncedUpdateSlideFromScroll() {
      clearTimeout(scrollUpdateTimeout);
      scrollUpdateTimeout = setTimeout(() => {
        updateSlideFromScroll();
      }, 50);
    }
    
    // é¡µé¢åˆ‡æ¢åŠŸèƒ½
    function showPage(pageId) {
      // éšè—æ‰€æœ‰é¡µé¢
      const pages = document.querySelectorAll('.page-content');
      pages.forEach(page => {
        page.style.display = 'none';
      });
      
      // æ˜¾ç¤ºé€‰ä¸­çš„é¡µé¢
      const targetPage = document.getElementById('page-' + pageId);
      if (targetPage) {
        targetPage.style.display = 'block';
      }
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆä»…å½“é¡µé¢å¯¼èˆªå­˜åœ¨æ—¶ï¼‰
      const pageNavigation = document.querySelector('.page-navigation');
      if (pageNavigation) {
        const buttons = document.querySelectorAll('.page-btn');
        buttons.forEach(btn => {
          btn.style.backgroundColor = '';
          btn.style.color = '';
        });
        
        const activeBtn = document.getElementById('btn-' + pageId);
        if (activeBtn) {
          activeBtn.style.backgroundColor = '#007bff';
          activeBtn.style.color = 'white';
        }
      }
    }
    
    // å°ç»„åˆ‡æ¢åŠŸèƒ½
    function showGroup(groupName) {
      // éšè—æ‰€æœ‰å°ç»„
      const groups = document.querySelectorAll('.group-section');
      groups.forEach(group => {
        group.style.display = 'none';
      });
      
      // æ˜¾ç¤ºé€‰ä¸­çš„å°ç»„
      const targetGroup = document.getElementById('group-' + groupName);
      if (targetGroup) {
        targetGroup.style.display = 'block';
      }
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      const buttons = document.querySelectorAll('.group-btn');
      buttons.forEach(btn => {
        btn.classList.remove('active');
      });
      
      const activeBtn = document.getElementById('btn-' + groupName);
      if (activeBtn) {
        activeBtn.classList.add('active');
      }
    }
    
    // æ›´æ–°é€‰æ‰‹é€‰é¡¹
    function updatePlayerOptions() {
      // è·å–æ‰€æœ‰é€‰æ‰‹ä¸‹æ‹‰æ¡†
      const allSelects = document.querySelectorAll('select[id^="player-"], select[id^="position-"], select[id^="home-"], select[id^="away-"]');
      
      // æ”¶é›†æ‰€æœ‰å·²é€‰æ‹©çš„é€‰æ‰‹ID
      const selectedPlayerIds = new Set();
      allSelects.forEach(select => {
        if (select.value) {
          selectedPlayerIds.add(select.value);
        }
      });
      
      // æ›´æ–°æ‰€æœ‰ä¸‹æ‹‰æ¡†çš„é€‰é¡¹çŠ¶æ€
      allSelects.forEach(select => {
        const options = select.querySelectorAll('option[value]:not([value=""])');
        const currentValue = select.value;
        
        options.forEach(option => {
          const playerId = option.value;
          const isSelected = selectedPlayerIds.has(playerId);
          const isCurrentSelection = currentValue === playerId;
          
          // å¦‚æœè¿™ä¸ªé€‰æ‰‹å·²è¢«å…¶ä»–ä¸‹æ‹‰æ¡†é€‰ä¸­ï¼Œä¸”ä¸æ˜¯å½“å‰ä¸‹æ‹‰æ¡†çš„é€‰æ‹©ï¼Œåˆ™ç¦ç”¨
          if (isSelected && !isCurrentSelection) {
            option.disabled = true;
            option.style.color = '#ccc';
            option.style.backgroundColor = '#f5f5f5';
          } else {
            option.disabled = false;
            option.style.color = '';
            option.style.backgroundColor = '';
          }
        });
      });
    }
    
    // ç”Ÿæˆåœºæ¬¡
    function generateMatches() {
      const playerCount = document.getElementById('player-count').value;
      const selectedPlayers = [];
      
      for (let i = 1; i <= playerCount; i++) {
        const select = document.getElementById('player-' + i);
        if (select && select.value) {
          selectedPlayers.push(select.value);
        }
      }
      
      if (selectedPlayers.length < 2) {
        alert('è¯·è‡³å°‘é€‰æ‹©2åé€‰æ‰‹');
        return;
      }
      
      // å‘é€è¯·æ±‚ç”Ÿæˆåœºæ¬¡
      fetch('/admin-secret/tournament/{{ tournament.t_id }}/generate-matches', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          player_ids: selectedPlayers,
          player_count: parseInt(playerCount)
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('åœºæ¬¡ç”ŸæˆæˆåŠŸï¼');
          location.reload();
        } else {
          alert('ç”Ÿæˆå¤±è´¥ï¼š' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ç”Ÿæˆå¤±è´¥ï¼š' + error.message);
      });
    }
    
    // æ¸…ç©ºæ‰€æœ‰åœºæ¬¡
    function clearAllMatches() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰åœºæ¬¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
        fetch('/admin-secret/tournament/{{ tournament.t_id }}/clear-matches', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('åœºæ¬¡å·²æ¸…ç©ºï¼');
            location.reload();
          } else {
            alert('æ¸…ç©ºå¤±è´¥ï¼š' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('æ¸…ç©ºå¤±è´¥ï¼š' + error.message);
        });
      }
    }
    
    // æ›´æ–°æ¯”åˆ†
    function updateScore(matchId, player, score) {
      // å®æ—¶æ›´æ–°æ¯”åˆ†æ˜¾ç¤ºï¼Œä½†ä¸æäº¤åˆ°æœåŠ¡å™¨
      console.log('æ›´æ–°æ¯”åˆ†:', matchId, player, score);
    }
    
    // æäº¤æ¯”åˆ†
    function submitScore(matchId) {
      const player1Score = document.querySelector(`input[data-match-id="${matchId}"][data-player="1"]`);
      const player2Score = document.querySelector(`input[data-match-id="${matchId}"][data-player="2"]`);
      
      if (!player1Score || !player2Score) return;
      
      const score1 = player1Score.value;
      const score2 = player2Score.value;
      
      if (score1 === '' || score2 === '') {
        alert('è¯·å¡«å†™å®Œæ•´æ¯”åˆ†');
        return;
      }
      
      fetch(`/admin-secret/tournament/{{ tournament.t_id }}/match/${matchId}/score`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          player_1_score: parseInt(score1),
          player_2_score: parseInt(score2)
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('æ¯”åˆ†æäº¤æˆåŠŸï¼');
          location.reload();
      } else {
          alert('æäº¤å¤±è´¥ï¼š' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('æäº¤å¤±è´¥ï¼š' + error.message);
      });
    }
    
    // æäº¤æ·˜æ±°èµ›æ¯”åˆ†
    function submitKnockoutScore(matchId) {
      const player1Score = document.querySelector(`input[data-match-id="${matchId}"][data-player="1"]`);
      const player2Score = document.querySelector(`input[data-match-id="${matchId}"][data-player="2"]`);
      
      if (!player1Score || !player2Score) return;
      
      const score1 = player1Score.value;
      const score2 = player2Score.value;
      
      if (score1 === '' || score2 === '') {
        alert('è¯·å¡«å†™å®Œæ•´æ¯”åˆ†');
        return;
      }
      
      fetch(`/admin-secret/tournament/{{ tournament.t_id }}/match/${matchId}/score`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          player_1_score: parseInt(score1),
          player_2_score: parseInt(score2)
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('æ¯”åˆ†æäº¤æˆåŠŸï¼');
          location.reload();
        } else {
          alert('æäº¤å¤±è´¥ï¼š' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('æäº¤å¤±è´¥ï¼š' + error.message);
      });
    }
    
    // åˆ†ç»„è®¾ç½®ç›¸å…³å‡½æ•°
    function submitGroupSettings(event) {
      event.preventDefault();
      
      const form = event.target;
      const formData = new FormData(form);
      const groupSize = formData.get('group_size');
      const roundRobinType = formData.get('round_robin_type');
      
      // å‘é€åˆ†ç»„è®¾ç½®è¯·æ±‚
      fetch('/admin-secret/tournament/{{ tournament.t_id }}/create-groups', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          group_size: parseInt(groupSize),
          round_robin_type: roundRobinType
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('åˆ†ç»„åˆ›å»ºæˆåŠŸï¼');
          location.reload();
        } else {
          alert('åˆ†ç»„åˆ›å»ºå¤±è´¥ï¼š' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('åˆ†ç»„åˆ›å»ºå¤±è´¥ï¼š' + error.message);
      });
    }
    
    function submitPlayerGrouping() {
      // æ”¶é›†æ‰€æœ‰åˆ†ç»„çš„é€‰æ‰‹ä¿¡æ¯
      const groupings = [];
      const groupElements = document.querySelectorAll('.group-container');
      
      groupElements.forEach((groupElement, index) => {
        const groupNameElement = groupElement.querySelector('.group-name');
        const groupNameText = groupNameElement.textContent;
        // ç§»é™¤"ç»„"å­—ï¼Œåªä¿ç•™å­—æ¯éƒ¨åˆ†
        const groupName = groupNameText.replace('ç»„', '');
        const playerElements = groupElement.querySelectorAll('.player-item');
        const players = Array.from(playerElements).map(playerEl => {
          return {
            player_id: parseInt(playerEl.dataset.playerId),
            player_name: playerEl.textContent.trim()
          };
        });
        
        groupings.push({
          group_name: groupName,
          group_index: index,
          players: players
        });
      });
      
      // è°ƒè¯•ï¼šè¾“å‡ºåˆ†ç»„æ•°æ®
      console.log('æäº¤çš„åˆ†ç»„æ•°æ®:', groupings);
      
      // å‘é€é€‰æ‰‹åˆ†ç»„è¯·æ±‚
      fetch('/admin-secret/tournament/{{ tournament.t_id }}/assign-players', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          groupings: groupings
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('é€‰æ‰‹åˆ†ç»„æˆåŠŸï¼');
          location.reload();
        } else {
          alert('é€‰æ‰‹åˆ†ç»„å¤±è´¥ï¼š' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('é€‰æ‰‹åˆ†ç»„å¤±è´¥ï¼š' + error.message);
      });
    }
    
    function resetToGroupSettings() {
      // éšè—é€‰æ‰‹åˆ†ç»„ç•Œé¢ï¼Œæ˜¾ç¤ºåˆ†ç»„è®¾ç½®ç•Œé¢
      document.getElementById('player-grouping').style.display = 'none';
      document.getElementById('group-settings').style.display = 'block';
    }
    
    function generateGroupingInterface(groupSize, roundRobinType, players) {
      const playerCount = {{ tournament.player_count }};
      const groupCount = playerCount / groupSize;
      
      // å¦‚æœæ²¡æœ‰ä¼ å…¥é€‰æ‰‹æ•°æ®ï¼Œä½¿ç”¨é¡µé¢åŠ è½½æ—¶çš„æ•°æ®
      if (!players) {
        players = {{ tournament.participants|tojson if tournament.participants else '[]' }};
      }
      
      console.log('é€‰æ‰‹æ•°æ®:', players);
      
      // åˆ›å»ºåˆ†ç»„ç•Œé¢HTML
      let html = '<div class="grouping-container">';
      
      for (let i = 0; i < groupCount; i++) {
        const groupName = String.fromCharCode(65 + i); // A, B, C, D...
        html += `
          <div class="group-container" data-group-index="${i}">
            <h5 class="group-name">${groupName}ç»„</h5>
            <div class="group-players" id="group-${i}-players">
              <!-- é€‰æ‰‹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
          </div>
        `;
      }
      
      html += '</div>';
      
      // æ·»åŠ æœªåˆ†ç»„é€‰æ‰‹åŒºåŸŸ
      html += `
        <div class="ungrouped-players">
          <h5>æœªåˆ†ç»„é€‰æ‰‹</h5>
          <div class="ungrouped-container" id="ungrouped-players">
            <!-- æœªåˆ†ç»„é€‰æ‰‹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
          </div>
        </div>
      `;
      
      // æ›´æ–°ç•Œé¢
      document.getElementById('grouping-form').innerHTML = html;
      
      // åˆå§‹åŒ–é€‰æ‰‹æ‹–æ‹½åŠŸèƒ½
      initializePlayerDragAndDrop(players, groupCount);
      
      // æ˜¾ç¤ºé€‰æ‰‹åˆ†ç»„ç•Œé¢
      document.getElementById('player-grouping').style.display = 'block';
      document.getElementById('group-settings').style.display = 'none';
    }
    
    // ä¿®æ”¹åˆ†ç»„è®¾ç½®è¡¨å•æäº¤å¤„ç†
    function handleGroupSettingsSubmit(event) {
      event.preventDefault();
      
      const form = event.target;
      const formData = new FormData(form);
      const groupSize = formData.get('group_size');
      const roundRobinType = formData.get('round_robin_type');
      
      // å…ˆåˆ›å»ºåˆ†ç»„
      fetch('/admin-secret/tournament/{{ tournament.t_id }}/create-groups', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          group_size: parseInt(groupSize),
          round_robin_type: roundRobinType
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // åˆ†ç»„åˆ›å»ºæˆåŠŸï¼Œåˆ·æ–°é¡µé¢ä»¥è·å–æœ€æ–°çš„åˆ†ç»„æ•°æ®
          location.reload();
        } else {
          alert('åˆ†ç»„åˆ›å»ºå¤±è´¥ï¼š' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('åˆ†ç»„åˆ›å»ºå¤±è´¥ï¼š' + error.message);
      });
    }
    
    // è·å–é€‰æ‰‹æ•°æ®å¹¶æ˜¾ç¤ºåˆ†ç»„ç•Œé¢
    function fetchPlayersAndShowGroupingInterface(groupSize, roundRobinType) {
      // é‡æ–°è·å–é€‰æ‰‹æ•°æ®
      fetch('/admin-secret/tournament/{{ tournament.t_id }}/get-players')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            generateGroupingInterface(groupSize, roundRobinType, data.players);
          } else {
            // å¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨é¡µé¢åŠ è½½æ—¶çš„é€‰æ‰‹æ•°æ®
            const players = {{ tournament.participants|tojson if tournament.participants else '[]' }};
            generateGroupingInterface(groupSize, roundRobinType, players);
          }
        })
        .catch(error => {
          console.error('è·å–é€‰æ‰‹æ•°æ®å¤±è´¥:', error);
          // å¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨é¡µé¢åŠ è½½æ—¶çš„é€‰æ‰‹æ•°æ®
          const players = {{ tournament.participants|tojson if tournament.participants else '[]' }};
          generateGroupingInterface(groupSize, roundRobinType, players);
        });
    }
    
    // ä¸ºå·²æœ‰åˆ†ç»„ç”Ÿæˆåˆ†ç»„ç•Œé¢ï¼ˆä½¿ç”¨æ‹–æ‹½åŠŸèƒ½ï¼‰
    function generateExistingGroupingInterface() {
      {% if has_groups and not has_players %}
        const groupCount = {{ group_stage_data.groups|length }};
        
        // å…ˆè·å–é€‰æ‰‹æ•°æ®
        fetch('/admin-secret/tournament/{{ tournament.t_id }}/get-players')
          .then(response => response.json())
          .then(data => {
            let players = [];
            if (data.success && data.players) {
              players = data.players;
            } else {
              // å¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨é¡µé¢åŠ è½½æ—¶çš„é€‰æ‰‹æ•°æ®
              players = {{ tournament.participants|tojson if tournament.participants else '[]' }};
            }
            
            console.log('è·å–åˆ°çš„é€‰æ‰‹æ•°æ®:', players);
            
            // åˆ›å»ºåˆ†ç»„ç•Œé¢HTML
            let html = '<div class="grouping-container">';
            
            {% for group in group_stage_data.groups %}
              html += `
                <div class="group-container" data-group-index="{{ loop.index0 }}">
                  <h5 class="group-name">{{ group.t_name }}ç»„</h5>
                  <div class="group-players" id="group-{{ loop.index0 }}-players">
                    <!-- é€‰æ‰‹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                  </div>
                </div>
              `;
            {% endfor %}
            
            html += '</div>';
            
            // æ·»åŠ æœªåˆ†ç»„é€‰æ‰‹åŒºåŸŸ
            html += `
              <div class="ungrouped-players">
                <h5>æœªåˆ†ç»„é€‰æ‰‹</h5>
                <div class="ungrouped-container" id="ungrouped-players">
                  <!-- æœªåˆ†ç»„é€‰æ‰‹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
              </div>
            `;
            
            // æ›´æ–°ç•Œé¢
            document.getElementById('grouping-form').innerHTML = html;
            
            // åˆå§‹åŒ–é€‰æ‰‹æ‹–æ‹½åŠŸèƒ½
            initializePlayerDragAndDrop(players, groupCount);
          })
          .catch(error => {
            console.error('è·å–é€‰æ‰‹æ•°æ®å¤±è´¥:', error);
            // å¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨é¡µé¢åŠ è½½æ—¶çš„é€‰æ‰‹æ•°æ®
            const players = {{ tournament.participants|tojson if tournament.participants else '[]' }};
            console.log('ä½¿ç”¨é¡µé¢åŠ è½½æ—¶çš„é€‰æ‰‹æ•°æ®:', players);
            
            // åˆ›å»ºåˆ†ç»„ç•Œé¢HTML
            let html = '<div class="grouping-container">';
            
            {% for group in group_stage_data.groups %}
              html += `
                <div class="group-container" data-group-index="{{ loop.index0 }}">
                  <h5 class="group-name">{{ group.t_name }}ç»„</h5>
                  <div class="group-players" id="group-{{ loop.index0 }}-players">
                    <!-- é€‰æ‰‹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                  </div>
                </div>
              `;
            {% endfor %}
            
            html += '</div>';
            
            // æ·»åŠ æœªåˆ†ç»„é€‰æ‰‹åŒºåŸŸ
            html += `
              <div class="ungrouped-players">
                <h5>æœªåˆ†ç»„é€‰æ‰‹</h5>
                <div class="ungrouped-container" id="ungrouped-players">
                  <!-- æœªåˆ†ç»„é€‰æ‰‹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
              </div>
            `;
            
            // æ›´æ–°ç•Œé¢
            document.getElementById('grouping-form').innerHTML = html;
            
            // åˆå§‹åŒ–é€‰æ‰‹æ‹–æ‹½åŠŸèƒ½
            initializePlayerDragAndDrop(players, groupCount);
          });
      {% endif %}
    }
    
    
    function initializePlayerDragAndDrop(players, groupCount) {
      // å°†æ‰€æœ‰é€‰æ‰‹æ”¾å…¥æœªåˆ†ç»„åŒºåŸŸ
      const ungroupedContainer = document.getElementById('ungrouped-players');
      players.forEach(player => {
        const playerElement = document.createElement('div');
        playerElement.className = 'player-item draggable';
        playerElement.dataset.playerId = player.player_id;
        playerElement.textContent = player.name;
        playerElement.draggable = true;
        
        playerElement.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', player.player_id);
          e.dataTransfer.effectAllowed = 'move';
        });
        
        ungroupedContainer.appendChild(playerElement);
      });
      
      // ä¸ºæ¯ä¸ªåˆ†ç»„æ·»åŠ æ‹–æ”¾åŠŸèƒ½
      for (let i = 0; i < groupCount; i++) {
        const groupContainer = document.getElementById(`group-${i}-players`);
        
        groupContainer.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        });
        
        groupContainer.addEventListener('drop', (e) => {
          e.preventDefault();
          const playerId = e.dataTransfer.getData('text/plain');
          movePlayerToGroup(playerId, i);
        });
      }
      
      // ä¸ºæœªåˆ†ç»„åŒºåŸŸæ·»åŠ æ‹–æ”¾åŠŸèƒ½
      ungroupedContainer.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      });
      
      ungroupedContainer.addEventListener('drop', (e) => {
        e.preventDefault();
        const playerId = e.dataTransfer.getData('text/plain');
        movePlayerToUngrouped(playerId);
      });
    }
    
    function movePlayerToGroup(playerId, groupIndex) {
      // ä»å½“å‰ä½ç½®ç§»é™¤é€‰æ‰‹
      const playerElement = document.querySelector(`[data-player-id="${playerId}"]`);
      if (!playerElement) return;
      
      playerElement.remove();
      
      // æ·»åŠ åˆ°ç›®æ ‡åˆ†ç»„
      const groupContainer = document.getElementById(`group-${groupIndex}-players`);
      const newPlayerElement = playerElement.cloneNode(true);
      
      // ä¸ºæ–°å…ƒç´ æ·»åŠ æ‹–æ‹½äº‹ä»¶
      newPlayerElement.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', playerId);
        e.dataTransfer.effectAllowed = 'move';
      });
      
      groupContainer.appendChild(newPlayerElement);
    }
    
    function movePlayerToUngrouped(playerId) {
      const playerElement = document.querySelector(`[data-player-id="${playerId}"]`);
      if (!playerElement) return;
      
      playerElement.remove();
      
      // ç§»åŠ¨åˆ°æœªåˆ†ç»„åŒºåŸŸ
      const ungroupedContainer = document.getElementById('ungrouped-players');
      const newPlayerElement = playerElement.cloneNode(true);
      
      // ä¸ºæ–°å…ƒç´ æ·»åŠ æ‹–æ‹½äº‹ä»¶
      newPlayerElement.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', playerId);
        e.dataTransfer.effectAllowed = 'move';
      });
      
      ungroupedContainer.appendChild(newPlayerElement);
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('é¡µé¢è„šæœ¬å¼€å§‹æ‰§è¡Œ');
      
      // åˆå§‹åŒ–å“åº”å¼æ»‘åŠ¨ç½‘æ ¼
      initSlidingGrid();
      initGridDrag();
      
      // ç›‘å¬çª—å£å¤§å°å˜åŒ–
      window.addEventListener('resize', handleResize);
      
      // æ ¹æ®èµ›äº‹ç±»å‹è®¾ç½®é»˜è®¤æ˜¾ç¤ºé¡µé¢
      {% if tournament.type == 2 and tournament.type_session_number >= 2 %}
        // å°èµ›ä»ç¬¬2å±Šèµ·ï¼Œç›´æ¥æ˜¾ç¤ºå°ç»„èµ›ï¼ˆæ— é¡µé¢å¯¼èˆªï¼‰
        showPage('group-stage');
      {% elif tournament.t_format in [1, 2, 3] %}
        // å°ç»„èµ›æ ¼å¼ï¼Œé»˜è®¤æ˜¾ç¤ºå°ç»„èµ›
        showPage('group-stage');
      {% elif tournament.t_format == 7 %}
        // åŒè´¥æ·˜æ±°èµ›æ ¼å¼ï¼Œé»˜è®¤æ˜¾ç¤ºå°ç»„èµ›
        showPage('group-stage');
      {% else %}
        // å…¶ä»–æ ¼å¼ï¼Œé»˜è®¤æ˜¾ç¤ºæ·˜æ±°èµ›
        showPage('knockout');
      {% endif %}
    });
    
    // 1/4å†³èµ›ç›¸å…³å‡½æ•°
    let selectedQuarterfinalType = null;
    let selectedRandomSubOption = null;
    
    function selectQuarterfinalType(type) {
      selectedQuarterfinalType = type;
      
      // æ›´æ–°UIçŠ¶æ€
      document.querySelectorAll('.quarterfinal-type-option').forEach(option => {
        option.classList.remove('selected');
      });
      document.querySelector(`[onclick="selectQuarterfinalType('${type}')"]`).classList.add('selected');
      
      // æ˜¾ç¤º/éšè—ç›¸å…³é€‰é¡¹
      const randomSubOptions = document.getElementById('random-sub-options');
      const manualPositionSelection = document.getElementById('manual-position-selection');
      const moduleActions = document.querySelector('.module-actions');
      
      if (type === 'random') {
        randomSubOptions.style.display = 'block';
      } else {
        randomSubOptions.style.display = 'none';
      }
      
      if (type === 'manual') {
        manualPositionSelection.style.display = 'block';
        loadPlayerOptions();
        } else {
        manualPositionSelection.style.display = 'none';
      }
      
      moduleActions.style.display = 'block';
    }
    
    function selectRandomSubOption(option) {
      selectedRandomSubOption = option;
      
      // æ›´æ–°UIçŠ¶æ€
      document.querySelectorAll('.random-sub-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      document.querySelector(`[onclick="selectRandomSubOption('${option}')"]`).classList.add('selected');
    }
    
    function loadPlayerOptions() {
      // è·å–æ€»æ’åå‰8åé€‰æ‰‹æ•°æ®
      const top8Players = {{ top8_players|tojson if top8_players else '[]' }};
      
      // ä¸ºæ¯ä¸ªä½æ¬¡é€‰æ‹©æ¡†åŠ è½½é€‰æ‰‹é€‰é¡¹
      for (let i = 1; i <= 8; i++) {
        const select = document.getElementById(`position-${i}`);
        if (select) {
          // æ¸…ç©ºç°æœ‰é€‰é¡¹
          select.innerHTML = '<option value="">é€‰æ‹©é€‰æ‰‹</option>';
          
          // æ·»åŠ é€‰æ‰‹é€‰é¡¹
          top8Players.forEach(player => {
            const option = document.createElement('option');
            option.value = player.player_id;
            option.textContent = player.name;
            option.dataset.playerId = player.player_id;
            select.appendChild(option);
          });
          
          // æ·»åŠ é€‰æ‹©å˜åŒ–äº‹ä»¶ç›‘å¬å™¨
          select.addEventListener('change', updatePlayerOptions);
        }
      }
      
      // åˆå§‹åŒ–æ—¶æ›´æ–°é€‰é¡¹çŠ¶æ€
      updatePlayerOptions();
    }
    
    
    function generateQuarterfinal() {
      if (!selectedQuarterfinalType) {
        alert('è¯·é€‰æ‹©1/4å†³èµ›ç±»å‹');
        return;
      }
      
      const tournamentId = {{ tournament.t_id }};
      let requestData = {
        action: 'generate',
        quarterfinal_type: selectedQuarterfinalType
      };
      
      // æ ¹æ®ç±»å‹æ·»åŠ é¢å¤–å‚æ•°
      if (selectedQuarterfinalType === 'random' && selectedRandomSubOption) {
        requestData.random_sub_option = selectedRandomSubOption;
      } else if (selectedQuarterfinalType === 'manual') {
        // è·å–æ‰‹åŠ¨é€‰æ‹©çš„ä½æ¬¡
        const positionData = [];
        for (let i = 1; i <= 8; i++) {
          const select = document.getElementById(`position-${i}`);
          if (select && select.value) {
            positionData.push(parseInt(select.value));
          } else {
            alert(`è¯·é€‰æ‹©ç¬¬${i}ä½é€‰æ‰‹`);
            return;
          }
        }
        requestData.position_data = positionData;
      }
      
      // å‘é€è¯·æ±‚
      fetch(`/admin-secret/tournament/${tournamentId}/knockout/quarterfinal`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('1/4å†³èµ›ç”ŸæˆæˆåŠŸï¼');
          location.reload();
        } else {
          alert('ç”Ÿæˆå¤±è´¥ï¼š' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ç”Ÿæˆå¤±è´¥ï¼š' + error.message);
      });
    }
    
    function generatePromotionRelegation() {
      const tournamentId = {{ tournament.t_id }};
      
      fetch(`/admin-secret/tournament/${tournamentId}/promotion-relegation/generate`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('å‡é™èµ›ç”ŸæˆæˆåŠŸï¼');
          location.reload();
        } else {
          alert('ç”Ÿæˆå¤±è´¥ï¼š' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ç”Ÿæˆå¤±è´¥ï¼š' + error.message);
      });
    }
    
    function checkPromotionRelegationStatus() {
      const tournamentId = {{ tournament.t_id }};
      
      fetch(`/admin-secret/tournament/${tournamentId}/promotion-relegation/status`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const statusDiv = document.querySelector('.promotion-relegation-status');
          const infoDiv = document.getElementById('promotion-relegation-info');
          
          infoDiv.innerHTML = `
            <p><strong>å½“å‰è½®æ¬¡ï¼š</strong>${data.current_round || 'æœªå¼€å§‹'}</p>
            <p><strong>å·²å®Œæˆè½®æ¬¡ï¼š</strong>${data.completed_rounds || 0}/4</p>
            <p><strong>çŠ¶æ€ï¼š</strong>${data.status || 'æœªçŸ¥'}</p>
          `;
          
          statusDiv.style.display = 'block';
        } else {
          alert('è·å–çŠ¶æ€å¤±è´¥ï¼š' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('è·å–çŠ¶æ€å¤±è´¥ï¼š' + error.message);
      });
    }
    
    
    function generateDoubleEliminationMatches() {
      const tournamentId = {{ tournament.t_id }};
      const playerCount = {{ tournament.player_count or 8 }};
      
      // æ”¶é›†é€‰æ‰‹é€‰æ‹©å™¨ä¸­çš„é€‰æ‰‹
      const selectedPlayers = [];
      for (let i = 1; i <= playerCount; i++) {
        const select = document.getElementById('player-' + i);
        if (select && select.value) {
          selectedPlayers.push(parseInt(select.value));
        }
      }
      
      if (selectedPlayers.length < 4) {
        alert(`åŒè´¥æ·˜æ±°èµ›è‡³å°‘éœ€è¦4åé€‰æ‰‹ï¼Œå½“å‰åªé€‰æ‹©äº†${selectedPlayers.length}åé€‰æ‰‹`);
        return;
      }
      
      if (selectedPlayers.length !== playerCount) {
        alert(`è¯·é€‰æ‹©å®Œæ•´çš„${playerCount}åé€‰æ‰‹ï¼Œå½“å‰åªé€‰æ‹©äº†${selectedPlayers.length}åé€‰æ‰‹`);
        return;
      }
      
      fetch(`/admin-secret/tournament/${tournamentId}/double-elimination/generate`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          players: selectedPlayers
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('åŒè´¥æ·˜æ±°èµ›ç”ŸæˆæˆåŠŸï¼');
          location.reload();
        } else {
          alert('ç”Ÿæˆå¤±è´¥ï¼š' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ç”Ÿæˆå¤±è´¥ï¼š' + error.message);
      });
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ‰€æœ‰ä¸‹æ‹‰æ¡†
    document.addEventListener('DOMContentLoaded', function() {
      // ä¸ºæ‰€æœ‰ç°æœ‰çš„ä¸‹æ‹‰æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      const allSelects = document.querySelectorAll('select[id^="player-"], select[id^="position-"], select[id^="home-"], select[id^="away-"]');
      allSelects.forEach(select => {
        select.addEventListener('change', updatePlayerOptions);
      });
      
      // åˆå§‹åŒ–é€‰é¡¹çŠ¶æ€
      updatePlayerOptions();
    });
    
  </script>
{% endblock %}
