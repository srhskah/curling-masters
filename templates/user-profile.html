{% extends 'layout.html' %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h4 class="text-center">ä¸ªäººä¸­å¿ƒ</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="user-info-section">
                                <h5 class="section-title">
                                    <i class="fas fa-user"></i> ç”¨æˆ·ä¿¡æ¯
                                </h5>
                                <div class="info-item">
                                    <span class="info-label">ç”¨æˆ·åï¼š</span>
                                    <span class="info-value">{{ user.username }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">æ³¨å†Œæ—¶é—´ï¼š</span>
                                    <span class="info-value">{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else 'æœªçŸ¥' }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">ç”¨æˆ·è§’è‰²ï¼š</span>
                                    <span class="info-value">
                                        {% if user.role == 1 %}
                                            <span class="role-badge admin">ç®¡ç†å‘˜</span>
                                        {% else %}
                                            <span class="role-badge user">æ™®é€šç”¨æˆ·</span>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="player-info-section">
                                <h5 class="section-title">
                                    <i class="fas fa-trophy"></i> ç»‘å®šé€‰æ‰‹
                                </h5>
                                {% if user.player %}
                                    <div class="info-item">
                                        <span class="info-label">é€‰æ‰‹å§“åï¼š</span>
                                        <span class="info-value player-name">{{ user.player.name }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">é€‰æ‰‹IDï¼š</span>
                                        <span class="info-value">{{ user.player.player_id }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">ç»‘å®šçŠ¶æ€ï¼š</span>
                                        <span class="info-value">
                                            <span class="status-badge bound">å·²ç»‘å®š</span>
                                        </span>
                                    </div>
                                    <div class="info-note">
                                        <i class="fas fa-info-circle"></i>
                                        <small>å¦‚éœ€è§£ç»‘é€‰æ‰‹ï¼Œè¯·è”ç³»ç®¡ç†å‘˜</small>
                                    </div>
                                {% else %}
                                    <div class="info-item">
                                        <span class="info-label">ç»‘å®šçŠ¶æ€ï¼š</span>
                                        <span class="info-value">
                                            <span class="status-badge unbound">æœªç»‘å®š</span>
                                        </span>
                                    </div>
                                    <div class="bind-action">
                                        <button class="btn btn-primary btn-sm" onclick="showBindPlayerModal()">
                                            <i class="fas fa-link"></i> ç»‘å®šé€‰æ‰‹
                                        </button>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    {% if user.player %}
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <h5>é€‰æ‰‹å‚èµ›è®°å½•</h5>
                            
                            <!-- ç­›é€‰æ§ä»¶ -->
                            <div class="ranking-toggle">
                                <div class="toggle-switch">
                                    <input type="radio" id="seasonAll" name="seasonFilter" value="" checked onchange="filterHistory()">
                                    <label for="seasonAll">å…¨éƒ¨èµ›å­£</label>
                                    {% for season in seasons %}
                                    <input type="radio" id="season{{ season.year }}" name="seasonFilter" value="{{ season.year }}" onchange="filterHistory()">
                                    <label for="season{{ season.year }}">{{ season.year }}</label>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="ranking-toggle">
                                <div class="toggle-switch">
                                    <input type="radio" id="typeAll" name="typeFilter" value="" checked onchange="filterHistory()">
                                    <label for="typeAll">å…¨éƒ¨ç±»å‹</label>
                                    <input type="radio" id="type1" name="typeFilter" value="1" onchange="filterHistory()">
                                    <label for="type1">æ­£èµ›</label>
                                    <input type="radio" id="type2" name="typeFilter" value="2" onchange="filterHistory()">
                                    <label for="type2">å°èµ›</label>
                                    <input type="radio" id="type3" name="typeFilter" value="3" onchange="filterHistory()">
                                    <label for="type3">æ€»å†³èµ›</label>
                                </div>
                            </div>
                            
                            <!-- æŒ‰èµ›å­£å’Œç±»å‹åˆ†ç»„çš„å‚èµ›è®°å½• -->
                            <div id="historyContent">
                                {% for season_year, season_data in player_rankings_by_season.items() %}
                                <div class="season-section mb-4" data-season="{{ season_year }}">
                                    <h6 class="season-header">{{ season_year }}èµ›å­£</h6>
                                    {% for tournament_type, tournaments in season_data.items() %}
                                    <div class="tournament-type-section mb-3" data-type="{{ tournament_type }}">
                                        <h6 class="tournament-type-header">
                                            {% if tournament_type == 1 %}æ­£èµ›
                                            {% elif tournament_type == 2 %}å°èµ›
                                            {% elif tournament_type == 3 %}æ€»å†³èµ›
                                            {% else %}å…¶ä»–èµ›äº‹
                                            {% endif %}
                                        </h6>
                                        <div class="table-responsive">
                                            <table class="table table-striped table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>å±Šæ¬¡</th>
                                                        <th>èµ›åˆ¶</th>
                                                        <th>æ’å</th>
                                                        <th>ç§¯åˆ†</th>
                                                        <th>æ“ä½œ</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for ranking in tournaments %}
                                                    <tr>
                                                        <td>ç¬¬{{ ranking.tournament.type_session_number }}å±Š</td>
                                                        <td>
                                                            {% if ranking.tournament.t_format in t_format_labels %}
                                                                {{ t_format_labels[ranking.tournament.t_format] }}
                                                            {% else %}
                                                                å…¶ä»–
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if ranking.ranks == 1 %}
                                                                <span class="rank-number gold">ğŸ¥‡ {{ ranking.ranks }}</span>
                                                            {% elif ranking.ranks == 2 %}
                                                                <span class="rank-number silver">ğŸ¥ˆ {{ ranking.ranks }}</span>
                                                            {% elif ranking.ranks == 3 %}
                                                                <span class="rank-number bronze">ğŸ¥‰ {{ ranking.ranks }}</span>
                                                            {% elif ranking.ranks == 4 %}
                                                                <span class="rank-number fourth">4ï¸âƒ£ {{ ranking.ranks }}</span>
                                                            {% else %}
                                                                <span class="rank-number">{{ ranking.ranks }}</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>{{ ranking.scores if ranking.scores else '-' }}</td>
                                                        <td>
                                                            <a href="/tournament/{{ ranking.tournament.t_id }}" class="btn btn-sm btn-outline-primary">æŸ¥çœ‹è¯¦æƒ…</a>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <h5>å†å²åœºæ¬¡</h5>
                            
                            <!-- åœºæ¬¡ç­›é€‰æ§ä»¶ -->
                            <div class="ranking-toggle">
                                <div class="toggle-switch">
                                    <input type="radio" id="matchSeasonAll" name="matchSeasonFilter" value="" checked onchange="filterMatches()">
                                    <label for="matchSeasonAll">å…¨éƒ¨èµ›å­£</label>
                                    {% for season in seasons %}
                                    <input type="radio" id="matchSeason{{ season.year }}" name="matchSeasonFilter" value="{{ season.year }}" onchange="filterMatches()">
                                    <label for="matchSeason{{ season.year }}">{{ season.year }}</label>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="ranking-toggle">
                                <div class="toggle-switch">
                                    <input type="radio" id="matchTypeAll" name="matchTypeFilter" value="" checked onchange="filterMatches()">
                                    <label for="matchTypeAll">å…¨éƒ¨ç±»å‹</label>
                                    <input type="radio" id="matchType1" name="matchTypeFilter" value="1" onchange="filterMatches()">
                                    <label for="matchType1">æ­£èµ›</label>
                                    <input type="radio" id="matchType2" name="matchTypeFilter" value="2" onchange="filterMatches()">
                                    <label for="matchType2">å°èµ›</label>
                                    <input type="radio" id="matchType3" name="matchTypeFilter" value="3" onchange="filterMatches()">
                                    <label for="matchType3">æ€»å†³èµ›</label>
                                </div>
                            </div>
                            
                            <!-- æŒ‰èµ›å­£å’Œç±»å‹åˆ†ç»„çš„å†å²åœºæ¬¡ -->
                            <div id="matchesContent">
                                {% for season_year, season_data in player_matches_by_season.items() %}
                                <div class="season-section mb-4" data-season="{{ season_year }}">
                                    <h6 class="season-header">{{ season_year }}èµ›å­£</h6>
                                    {% for tournament_type, matches in season_data.items() %}
                                    <div class="tournament-type-section mb-3" data-type="{{ tournament_type }}">
                                        <h6 class="tournament-type-header">
                                            {% if tournament_type == 1 %}æ­£èµ›
                                            {% elif tournament_type == 2 %}å°èµ›
                                            {% elif tournament_type == 3 %}æ€»å†³èµ›
                                            {% else %}å…¶ä»–èµ›äº‹
                                            {% endif %}
                                        </h6>
                                        <div class="table-responsive">
                                            <table class="table table-striped table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>å±Šæ¬¡</th>
                                                        <th>å¯¹æ‰‹</th>
                                                        <th>æ¯”åˆ†</th>
                                                        <th>ç»“æœ</th>
                                                        <th>æ“ä½œ</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for match in matches %}
                                                    <tr>
                                                        <td>ç¬¬{{ match.tournament.type_session_number }}å±Š</td>
                                                        <td>
                                                            {% if match.player_1_id == user.player.player_id %}
                                                                {{ match.player2.name }}
                                                            {% else %}
                                                                {{ match.player1.name }}
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if match.player_1_id == user.player.player_id %}
                                                                <span class="score-display">{{ match.player_1_score }} : {{ match.player_2_score }}</span>
                                                            {% else %}
                                                                <span class="score-display">{{ match.player_2_score }} : {{ match.player_1_score }}</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if match.winner_id() == user.player.player_id %}
                                                                <span class="match-result win">èƒœåˆ©</span>
                                                            {% elif match.winner_id() == None %}
                                                                <span class="match-result draw">å¹³å±€</span>
                                                            {% else %}
                                                                <span class="match-result loss">å¤±è´¥</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            <a href="/tournament/{{ match.tournament.t_id }}" class="btn btn-sm btn-outline-primary">æŸ¥çœ‹è¯¦æƒ…</a>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç»‘å®šé€‰æ‰‹æ¨¡æ€æ¡† -->
<!-- <div class="modal fade" id="bindPlayerModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ç»‘å®šé€‰æ‰‹</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="bindPlayerForm">
                    <div class="form-group">
                        <label for="playerSelect">é€‰æ‹©é€‰æ‰‹</label>
                        <select class="form-control" id="playerSelect" name="player_id" required>
                            <option value="">è¯·é€‰æ‹©é€‰æ‰‹</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>æ»‘å—éªŒè¯</label>
                        <div id="captchaContainer"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="bindPlayerBtn" disabled>ç»‘å®š</button>
            </div>
        </div>
    </div>
</div> -->

<script src="/static/slider-captcha.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // åŠ è½½é€‰æ‰‹åˆ—è¡¨
    loadPlayers();
    
    // ç»‘å®šé€‰æ‰‹è¡¨å•æäº¤
    document.getElementById('bindPlayerBtn').addEventListener('click', function() {
        const playerId = document.getElementById('playerSelect').value;
        if (!playerId) {
            alert('è¯·é€‰æ‹©é€‰æ‰‹');
            return;
        }
        
        if (!window.bindCaptcha || !window.bindCaptcha.isVerified) {
            alert('è¯·å®Œæˆæ»‘å—éªŒè¯');
            return;
        }
        
        fetch('/user/bind-player', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                player_id: parseInt(playerId)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('ç»‘å®šæˆåŠŸï¼');
                location.reload();
            } else {
                alert('ç»‘å®šå¤±è´¥ï¼š' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ç»‘å®šå¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    });
    
    function loadPlayers() {
        fetch('/api/players')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('playerSelect');
            data.players.forEach(player => {
                const option = document.createElement('option');
                option.value = player.player_id;
                option.textContent = player.name;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading players:', error);
        });
    }
});

function showBindPlayerModal() {
    $('#bindPlayerModal').modal('show');
    
    // åˆå§‹åŒ–æ»‘å—éªŒè¯ç 
    setTimeout(() => {
        window.bindCaptcha = createSliderCaptcha('captchaContainer');
        
        document.getElementById('captchaContainer').addEventListener('captchaSuccess', function() {
            document.getElementById('bindPlayerBtn').disabled = false;
        });
    }, 100);
}

function filterHistory() {
    const seasonFilter = document.querySelector('input[name="seasonFilter"]:checked').value;
    const typeFilter = document.querySelector('input[name="typeFilter"]:checked').value;
    
    const seasonSections = document.querySelectorAll('#historyContent .season-section');
    
    seasonSections.forEach(section => {
        const seasonYear = section.getAttribute('data-season');
        let showSeason = true;
        
        // èµ›å­£ç­›é€‰
        if (seasonFilter && seasonYear !== seasonFilter) {
            showSeason = false;
        }
        
        if (showSeason) {
            const typeSections = section.querySelectorAll('.tournament-type-section');
            let hasVisibleTypes = false;
            
            typeSections.forEach(typeSection => {
                const tournamentType = typeSection.getAttribute('data-type');
                let showType = true;
                
                // ç±»å‹ç­›é€‰
                if (typeFilter && tournamentType !== typeFilter) {
                    showType = false;
                }
                
                if (showType) {
                    typeSection.style.display = 'block';
                    hasVisibleTypes = true;
                } else {
                    typeSection.style.display = 'none';
                }
            });
            
            if (hasVisibleTypes) {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        } else {
            section.style.display = 'none';
        }
    });
}

function filterMatches() {
    const seasonFilter = document.querySelector('input[name="matchSeasonFilter"]:checked').value;
    const typeFilter = document.querySelector('input[name="matchTypeFilter"]:checked').value;
    
    const seasonSections = document.querySelectorAll('#matchesContent .season-section');
    
    seasonSections.forEach(section => {
        const seasonYear = section.getAttribute('data-season');
        let showSeason = true;
        
        // èµ›å­£ç­›é€‰
        if (seasonFilter && seasonYear !== seasonFilter) {
            showSeason = false;
        }
        
        if (showSeason) {
            const typeSections = section.querySelectorAll('.tournament-type-section');
            let hasVisibleTypes = false;
            
            typeSections.forEach(typeSection => {
                const tournamentType = typeSection.getAttribute('data-type');
                let showType = true;
                
                // ç±»å‹ç­›é€‰
                if (typeFilter && tournamentType !== typeFilter) {
                    showType = false;
                }
                
                if (showType) {
                    typeSection.style.display = 'block';
                    hasVisibleTypes = true;
                } else {
                    typeSection.style.display = 'none';
                }
            });
            
            if (hasVisibleTypes) {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        } else {
            section.style.display = 'none';
        }
    });
}
</script>
{% endblock %}
