{% extends 'layout.html' %}
{% block content %}
  <div class="tournament-info">
    <h2>{{ player.name }}</h2>
  </div>

  <!-- åˆ†é¡µå¯¼èˆª -->
  <div class="page-navigation" style="margin: 20px 0; text-align: center;">
    <button onclick="showPage('stats')" class="page-btn active" id="btn-stats">æ€»ç§¯åˆ†ä¿¡æ¯</button>
    <button onclick="showPage('history')" class="page-btn" id="btn-history">å†å±Šå‚èµ›è®°å½•</button>
    <button onclick="showPage('medals')" class="page-btn" id="btn-medals">å¥–ç‰Œç»Ÿè®¡</button>
    <button onclick="showPage('matches')" class="page-btn" id="btn-matches">æ¯”èµ›è®°å½•</button>
  </div>

  <!-- æ€»ç§¯åˆ†ä¿¡æ¯é¡µé¢ -->
  <div id="page-stats" class="page-content" style="text-align: center;">
    {% if player_stats %}
    <!-- <h3>æ€»ç§¯åˆ†ä¿¡æ¯</h3> -->
    <div class="table-container" style="overflow-x: auto; margin: 20px 0;">
      <table class="ranking-table">
        <thead>
          <tr>
            <th>æ€»æ’å</th>
            <th>æ€»ç§¯åˆ†</th>
            <th>èµ·è®¡åˆ†</th>
            <th>å¤§èµ›æ¬¡æ•°</th>
            <th>å°èµ›æ¬¡æ•°</th>
            <th>æ€»å‚èµ›æ¬¡æ•°</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>{{ player_stats.rank }}</td>
            <td>{{ player_stats.total_score }}</td>
            <td style="background-color: #d4edda; font-weight: bold;">{{ player_stats.baseline_score }}</td>
            <td>{{ player_stats.major_count }}</td>
            <td>{{ player_stats.minor_count }}</td>
            <td>{{ player_stats.total_count }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- ç®¡ç†å‘˜åŠŸèƒ½ -->
    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 10px; margin: 20px 0;">
      <h4 style="margin-top: 0; color: #667eea; text-align: center;">ç®¡ç†å‘˜åŠŸèƒ½</h4>
      <div class="admin-button-group">
        <a href="/admin-secret/players/{{ player.player_id }}/edit" 
           style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 10px 20px; border-radius: 20px; text-decoration: none; font-weight: bold; display: inline-block;">
          ç¼–è¾‘é€‰æ‰‹ä¿¡æ¯
        </a>
        <a href="/admin-secret/players/{{ player.player_id }}delete" 
           onclick="return confirm('ç¡®å®šè¦åˆ é™¤é€‰æ‰‹ {{ player.name }} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')"
           style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 10px 20px; border-radius: 20px; text-decoration: none; font-weight: bold; display: inline-block;">
          åˆ é™¤é€‰æ‰‹
        </a>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- å†å±Šå‚èµ›è®°å½•é¡µé¢ -->
  <div id="page-history" class="page-content" style="display: none;text-align: center;">
    {% if tournament_history %}
    <!-- <h3>å†å±Šå‚èµ›è®°å½•</h3> -->
    
    <!-- å¤§èµ›è®°å½• -->
    {% set major_tournaments = tournament_history|selectattr('1', 'equalto', 1)|list %}
    {% if major_tournaments %}
    <h4>å¤§èµ›</h4>
    <div class="table-container" style="overflow-x: auto; margin: 20px 0;">
      <table class="ranking-table">
        <thead>
          <tr>
            <th>èµ›å­£</th>
            <th>å±Šæ¬¡</th>
            <th>æ’å</th>
            <th>ç§¯åˆ†</th>
          </tr>
        </thead>
        <tbody>
          {% for t_id, t_type, year, session_num, ranks, scores in major_tournaments %}
            <tr>
              <td>{{ year }}</td>
              <td>{{ session_num }}</td>
              <!-- <td>{{ ranks }}</td> -->
              {% if ranks == 1 %}
                <td class="rank-1">{{ ranks }}</td>
              {% elif ranks == 2 %}
                <td class="rank-2">{{ ranks }}</td>
              {% elif ranks == 3 %}
                <td class="rank-3">{{ ranks }}</td>
              {% else %}
                <td>{{ ranks }}</td>
              {% endif %}
              {% if scores == tenth_highest_score %}
                <td style="background-color: #d4edda; font-weight: bold;">{{ scores }}</td>
              {% else %}
                <td>{{ scores }}</td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
    
    <!-- å°èµ›è®°å½• -->
    {% set minor_tournaments = tournament_history|selectattr('1', 'equalto', 2)|list %}
    {% if minor_tournaments %}
    <h4>å°èµ›</h4>
    <div class="table-container" style="overflow-x: auto; margin: 20px 0;">
      <table class="ranking-table">
        <thead>
          <tr>
            <th>èµ›å­£</th>
            <th>å±Šæ¬¡</th>
            <th>æ’å</th>
            <th>ç§¯åˆ†</th>
          </tr>
        </thead>
        <tbody>
          {% for t_id, t_type, year, session_num, ranks, scores in minor_tournaments %}
            <tr>
              <td>{{ year }}</td>
              <td>{{ session_num }}</td>
              <!-- <td>{{ ranks }}</td> -->
              {% if ranks == 1 %}
                <td class="rank-1">{{ ranks }}</td>
              {% elif ranks == 2 %}
                <td class="rank-2">{{ ranks }}</td>
              {% elif ranks == 3 %}
                <td class="rank-3">{{ ranks }}</td>
              {% else %}
                <td>{{ ranks }}</td>
              {% endif %}
              {% if scores == tenth_highest_score %}
                <td style="background-color: #d4edda; font-weight: bold;">{{ scores }}</td>
              {% else %}
                <td>{{ scores }}</td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
    
    <!-- æ€»å†³èµ›è®°å½• -->
    {% set final_tournaments = tournament_history|selectattr('1', 'equalto', 3)|list %}
    {% if final_tournaments %}
    <h4>æ€»å†³èµ›</h4>
    <div class="table-container" style="overflow-x: auto; margin: 20px 0;">
      <table class="ranking-table">
        <thead>
          <tr>
            <th>èµ›å­£</th>
            <th>å±Šæ¬¡</th>
            <th>æ’å</th>
            <th>ç§¯åˆ†</th>
          </tr>
        </thead>
        <tbody>
          {% for t_id, t_type, year, session_num, ranks, scores in final_tournaments %}
            <tr>
              <td>{{ year }}</td>
              <td>{{ session_num }}</td>
              <!-- <td>{{ ranks }}</td> -->
              {% if ranks == 1 %}
                <td class="rank-1">{{ ranks }}</td>
              {% elif ranks == 2 %}
                <td class="rank-2">{{ ranks }}</td>
              {% elif ranks == 3 %}
                <td class="rank-3">{{ ranks }}</td>
              {% else %}
                <td>{{ ranks }}</td>
              {% endif %}
              {% if scores == tenth_highest_score %}
                <td style="background-color: #d4edda; font-weight: bold;">{{ scores }}</td>
              {% else %}
                <td>{{ scores }}</td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
    {% endif %}
  </div>

  <!-- å¥–ç‰Œç»Ÿè®¡é¡µé¢ -->
  <div id="page-medals" class="page-content" style="display: none;text-align: center;">
    <!-- <h3>å¥–ç‰Œç»Ÿè®¡</h3> -->
    
    <!-- å¤§èµ›å¥–ç‰Œç»Ÿè®¡ -->
    <h4>å¤§èµ›å¥–ç‰Œ</h4>
    <div class="table-container" style="overflow-x: auto; margin: 20px 0;">
      <table class="medal-table">
        <thead>
          <tr>
            <th>ğŸ¥‡</th>
            <th>ğŸ¥ˆ</th>
            <th>ğŸ¥‰</th>
            <th>æ€»è®¡</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>{{ player_medal_stats.major.gold }}</td>
            <td>{{ player_medal_stats.major.silver }}</td>
            <td>{{ player_medal_stats.major.bronze }}</td>
            <td>{{ player_medal_stats.major.gold + player_medal_stats.major.silver + player_medal_stats.major.bronze }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- å°èµ›å¥–ç‰Œç»Ÿè®¡ -->
    <h4>å°èµ›å¥–ç‰Œ</h4>
    <div class="table-container" style="overflow-x: auto; margin: 20px 0;">
      <table class="medal-table">
        <thead>
          <tr>
            <th>ğŸ¥‡</th>
            <th>ğŸ¥ˆ</th>
            <th>ğŸ¥‰</th>
            <th>æ€»è®¡</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>{{ player_medal_stats.minor.gold }}</td>
            <td>{{ player_medal_stats.minor.silver }}</td>
            <td>{{ player_medal_stats.minor.bronze }}</td>
            <td>{{ player_medal_stats.minor.gold + player_medal_stats.minor.silver + player_medal_stats.minor.bronze }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- æ€»å†³èµ›å¥–ç‰Œç»Ÿè®¡ -->
    <h4>æ€»å†³èµ›å¥–ç‰Œ</h4>
    <div class="table-container" style="overflow-x: auto; margin: 20px 0;">
      <table class="medal-table">
        <thead>
          <tr>
            <th>ğŸ¥‡</th>
            <th>ğŸ¥ˆ</th>
            <th>ğŸ¥‰</th>
            <th>æ€»è®¡</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>{{ player_medal_stats.final.gold }}</td>
            <td>{{ player_medal_stats.final.silver }}</td>
            <td>{{ player_medal_stats.final.bronze }}</td>
            <td>{{ player_medal_stats.final.gold + player_medal_stats.final.silver + player_medal_stats.final.bronze }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- æ¯”èµ›è®°å½•é¡µé¢ -->
  <div id="page-matches" class="page-content" style="display: none;">
  <!-- <h3>æ¯”èµ›è®°å½•</h3> -->
    
  {% if matches %}
      <!-- ç­›é€‰å’Œå¯¹æˆ˜è®°å½•åˆ‡æ¢ -->
      <div class="matches-controls" style="margin: 15px 0;">
        <!-- ç­›é€‰æ§ä»¶ -->
        <div class="season-filter">
          <div class="filter-controls">
            <div class="filter-group">
              <label for="season-select">èµ›å­£</label>
              <select id="season-select" onchange="filterMatchesBySeason()">
                <option value="">å…¨éƒ¨</option>
                {% for season_year in matches|map(attribute='tournament.season.year')|unique|sort(reverse=true) %}
                  <option value="{{ season_year }}">{{ season_year }}</option>
                {% endfor %}
              </select>
            </div>
            
            <div class="filter-group">
              <label for="tournament-type-select">æ¯”èµ›ç±»å‹</label>
              <select id="tournament-type-select" onchange="filterMatchesByType()">
                <option value="">å…¨éƒ¨ç±»å‹</option>
                <option value="1">æ­£èµ›</option>
                <option value="2">å°èµ›</option>
                <option value="3">æ€»å†³èµ›</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label for="session-select">å±Šæ¬¡</label>
              <select id="session-select" onchange="filterMatchesBySession()">
                <option value="">å…¨éƒ¨å±Šæ¬¡</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label for="opponent-select">å¯¹æ‰‹</label>
              <select id="opponent-select" onchange="filterMatchesByOpponent()">
                <option value="">å…¨éƒ¨å¯¹æ‰‹</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- å¯¹æˆ˜è®°å½•åˆ‡æ¢ -->
        <div class="h2h-toggle" style="margin-bottom: 15px; padding: 10px; background-color: #e3f2fd; border-radius: 5px;">
          <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            <label>
              <input type="radio" name="view-mode" value="all" checked onchange="switchViewMode('all')">
              å…¨éƒ¨æ¯”èµ›
            </label>
            <label>
              <input type="radio" name="view-mode" value="h2h" onchange="switchViewMode('h2h')">
              å¯¹æˆ˜è®°å½•
            </label>
            <select id="h2h-opponent-select" onchange="showH2HRecord()" style="padding: 5px 10px; border: 1px solid #ccc; border-radius: 3px; display: none;">
              <option value="">è¯·é€‰æ‹©å¯¹æ‰‹</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- å¯¹æˆ˜ç»Ÿè®¡æ˜¾ç¤ºåŒºåŸŸ -->
      <div id="h2h-stats" style="display: none; margin-bottom: 20px;">
        <div class="h2h-summary" style="padding: 15px; background-color: #e8f5e8; border-radius: 5px;">
          <h4 id="h2h-title">å¯¹æˆ˜ç»Ÿè®¡</h4>
          <div style="display: flex; gap: 30px; flex-wrap: wrap;">
            <div class="stat-item">
              <span style="font-size: 24px; font-weight: bold; color: #4caf50;" id="h2h-wins">0</span>
              <span style="margin-left: 5px;">èƒœ</span>
            </div>
            <div class="stat-item">
              <span style="font-size: 24px; font-weight: bold; color: #ff9800;" id="h2h-draws">0</span>
              <span style="margin-left: 5px;">å¹³</span>
            </div>
            <div class="stat-item">
              <span style="font-size: 24px; font-weight: bold; color: #f44336;" id="h2h-losses">0</span>
              <span style="margin-left: 5px;">è´Ÿ</span>
            </div>
            <div class="stat-item">
              <span style="font-size: 18px; color: #666;" id="h2h-total">æ€»è®¡: 0åœº</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- æ‰€æœ‰å¯¹æ‰‹å¿«é€Ÿé€‰æ‹© -->
      <div id="all-opponents" style="display: none; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h4 style="margin: 0;">æ‰€æœ‰å¯¹æ‰‹</h4>
          <button id="reset-view-btn" onclick="resetView()" style="display: none; padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
            è¿”å›å…¨éƒ¨
          </button>
        </div>
        <div id="opponents-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
        </div>
      </div>
      
      <!-- æŒ‰èµ›å­£åˆ†é¡µçš„æ¯”èµ›è®°å½• -->
      {% for season_year in matches|map(attribute='tournament.season.year')|unique|sort(reverse=true) %}
        <div class="season-matches" data-season="{{ season_year }}" style="margin-bottom: 30px;">
          <h4 style="color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 5px;">{{ season_year }}</h4>
          
          {% set season_matches = matches|selectattr('tournament.season.year', 'equalto', season_year)|list %}
          <div class="season-tournaments-container">
            {% for t_id, group in season_matches|groupby('tournament.t_id') %}
      {% set tour = group[0].tournament %}
            {% set display_idx = tour.type_session_number %}
            
            <div class="tournament-matches" data-tournament-type="{{ tour.type }}" data-session="{{ display_idx }}" style="margin-bottom: 20px;">
              <!-- <h5 style="margin: 10px 0 5px 0;">
                <a href="/tournament/{{ tour.t_id }}" style="text-decoration: none; color: #333;">
                  {% if tour.type == 1 %}æ­£èµ›{% elif tour.type == 2 %}å°èµ›{% elif tour.type == 3 %}æ€»å†³èµ›{% endif %} - ç¬¬{{ display_idx or tour.t_id }}å±Š
                </a>
              </h5> -->
              
              <!-- ç»Ÿä¸€è¡¨æ ¼æ˜¾ç¤ºæ‰€æœ‰æ¯”èµ› -->
              {% set all_tournament_matches = [] %}
              {% for match in group %}
                {% if match.player_1_score is not none and match.player_2_score is not none and not (match.player_1_score == 0 and match.player_2_score == 0) and not (match.player_1_score == -1 and match.player_2_score == -1) %}
                  {% set _ = all_tournament_matches.append(match) %}
          {% endif %}
        {% endfor %}
              
              {% if all_tournament_matches|length > 0 %}
                <div class="tournament-matches-header" style="margin-bottom: 15px;">
                  <h5 style="margin: 10px 0 5px 0; text-align: center;">
                    <a href="/tournament/{{ tour.t_id }}" style="text-decoration: none; color: #333;">
                      {% if tour.type == 1 %}æ­£èµ›{% elif tour.type == 2 %}å°èµ›{% elif tour.type == 3 %}æ€»å†³èµ›{% endif %} - ç¬¬{{ display_idx or tour.t_id }}å±Š
                    </a>
                  </h5>
                </div>
                <div class="matches-grid">
                  {% for m in all_tournament_matches %}
                    {% set is_player1 = m.player_1_id == player.player_id %}
                    {% set is_player2 = m.player_2_id == player.player_id %}
                    {% set opponent_id = m.player_2_id if is_player1 else m.player_1_id %}
                    {% set opponent_name = m.player2.name if is_player1 else m.player1.name %}
                    
                    {% if is_player1 %}
                      <!-- é€‰æ‰‹æ˜¯player1ï¼Œæ­£å¸¸æ˜¾ç¤º -->
                      {% if m.m_type == 8 %}
                        <div class="knockout-card-quarterfinal match-row" data-opponent="{{ opponent_id }}">
                          <div class="knockout-card-players">
                            <div class="knockout-card-player {% if m.player_1_score > m.player_2_score %}winner{% endif %}">
                              <span><strong>{{ m.player1.name }}</strong></span>
                              <span class="knockout-card-score">{{ m.player_1_score }}</span>
                            </div>
                            <div class="knockout-card-player {% if m.player_2_score > m.player_1_score %}winner{% endif %}">
                              <span><a href="/player/{{ m.player_2_id }}">{{ m.player2.name }}</a></span>
                              <span class="knockout-card-score">{{ m.player_2_score }}</span>
                            </div>
                          </div>
                        </div>
                      {% elif m.m_type == 9 %}
                        <div class="knockout-card-qualifier match-row" data-opponent="{{ opponent_id }}">
                          <div class="knockout-card-players">
                            <div class="knockout-card-player {% if m.player_1_score > m.player_2_score %}winner{% endif %}">
                              <span><strong>{{ m.player1.name }}</strong></span>
                              <span class="knockout-card-score">{{ m.player_1_score }}</span>
                            </div>
                            <div class="knockout-card-player {% if m.player_2_score > m.player_1_score %}winner{% endif %}">
                              <span><a href="/player/{{ m.player_2_id }}">{{ m.player2.name }}</a></span>
                              <span class="knockout-card-score">{{ m.player_2_score }}</span>
                            </div>
                          </div>
                        </div>
                      {% elif m.m_type == 10 %}
                        <div class="knockout-card-semifinal match-row" data-opponent="{{ opponent_id }}">
                          <div class="knockout-card-players">
                            <div class="knockout-card-player {% if m.player_1_score > m.player_2_score %}winner{% endif %}">
                              <span><strong>{{ m.player1.name }}</strong></span>
                              <span class="knockout-card-score">{{ m.player_1_score }}</span>
                            </div>
                            <div class="knockout-card-player {% if m.player_2_score > m.player_1_score %}winner{% endif %}">
                              <span><a href="/player/{{ m.player_2_id }}">{{ m.player2.name }}</a></span>
                              <span class="knockout-card-score">{{ m.player_2_score }}</span>
                            </div>
                          </div>
                        </div>
                      {% elif m.m_type == 11 %}
                        <div class="knockout-card-bronze match-row" data-opponent="{{ opponent_id }}">
                          <div class="knockout-card-players">
                            <div class="knockout-card-player {% if m.player_1_score > m.player_2_score %}winner{% endif %}">
                              <span><strong>{{ m.player1.name }}</strong></span>
                              <span class="knockout-card-score">{{ m.player_1_score }}</span>
                            </div>
                            <div class="knockout-card-player {% if m.player_2_score > m.player_1_score %}winner{% endif %}">
                              <span><a href="/player/{{ m.player_2_id }}">{{ m.player2.name }}</a></span>
                              <span class="knockout-card-score">{{ m.player_2_score }}</span>
                            </div>
                          </div>
                        </div>
                      {% elif m.m_type == 12 %}
                        <div class="knockout-card-gold match-row" data-opponent="{{ opponent_id }}">
                          <div class="knockout-card-players">
                            <div class="knockout-card-player {% if m.player_1_score > m.player_2_score %}winner{% endif %}">
                              <span><strong>{{ m.player1.name }}</strong></span>
                              <span class="knockout-card-score">{{ m.player_1_score }}</span>
                            </div>
                            <div class="knockout-card-player {% if m.player_2_score > m.player_1_score %}winner{% endif %}">
                              <span><a href="/player/{{ m.player_2_id }}">{{ m.player2.name }}</a></span>
                              <span class="knockout-card-score">{{ m.player_2_score }}</span>
                            </div>
                          </div>
                        </div>
                      {% else %}
                        <!-- å°ç»„èµ›æˆ–å…¶ä»–ç±»å‹æ¯”èµ› -->
                        <div class="match-card match-row" data-opponent="{{ opponent_id }}">
                          <div class="match-header">
                            <span class="match-title">{% if m.m_type == 14 %}é™„åŠ èµ›{% else %}ç¬¬{{ loop.index }}åœº{% endif %}</span>
                          </div>
                          <div class="match-players">
                            <div class="player-info">
                              <span class="player-name"><strong>{{ m.player1.name }}</strong></span>
                              <span class="player-score">{{ m.player_1_score }}</span>
                            </div>
                            <div class="vs-divider">VS</div>
                            <div class="player-info">
                              <span class="player-name"><a href="/player/{{ m.player_2_id }}">{{ m.player2.name }}</a></span>
                              <span class="player-score">{{ m.player_2_score }}</span>
                            </div>
                          </div>
                        </div>
                      {% endif %}
                    {% elif is_player2 %}
                      <!-- é€‰æ‰‹æ˜¯player2ï¼Œåè½¬æ˜¾ç¤º -->
                      {% if m.m_type == 8 %}
                        <div class="knockout-card-quarterfinal match-row" data-opponent="{{ opponent_id }}">
                          <div class="knockout-card-players">
                            <div class="knockout-card-player {% if m.player_2_score > m.player_1_score %}winner{% endif %}">
                              <span><strong>{{ m.player2.name }}</strong></span>
                              <span class="knockout-card-score">{{ m.player_2_score }}</span>
                            </div>
                            <div class="knockout-card-player {% if m.player_1_score > m.player_2_score %}winner{% endif %}">
                              <span><a href="/player/{{ m.player_1_id }}">{{ m.player1.name }}</a></span>
                              <span class="knockout-card-score">{{ m.player_1_score }}</span>
                            </div>
                          </div>
                        </div>
                      {% elif m.m_type == 9 %}
                        <div class="knockout-card-qualifier match-row" data-opponent="{{ opponent_id }}">
                          <div class="knockout-card-players">
                            <div class="knockout-card-player {% if m.player_2_score > m.player_1_score %}winner{% endif %}">
                              <span><strong>{{ m.player2.name }}</strong></span>
                              <span class="knockout-card-score">{{ m.player_2_score }}</span>
                            </div>
                            <div class="knockout-card-player {% if m.player_1_score > m.player_2_score %}winner{% endif %}">
                              <span><a href="/player/{{ m.player_1_id }}">{{ m.player1.name }}</a></span>
                              <span class="knockout-card-score">{{ m.player_1_score }}</span>
                            </div>
                          </div>
                        </div>
                      {% elif m.m_type == 10 %}
                        <div class="knockout-card-semifinal match-row" data-opponent="{{ opponent_id }}">
                          <div class="knockout-card-players">
                            <div class="knockout-card-player {% if m.player_2_score > m.player_1_score %}winner{% endif %}">
                              <span><strong>{{ m.player2.name }}</strong></span>
                              <span class="knockout-card-score">{{ m.player_2_score }}</span>
                            </div>
                            <div class="knockout-card-player {% if m.player_1_score > m.player_2_score %}winner{% endif %}">
                              <span><a href="/player/{{ m.player_1_id }}">{{ m.player1.name }}</a></span>
                              <span class="knockout-card-score">{{ m.player_1_score }}</span>
                            </div>
                          </div>
                        </div>
                      {% elif m.m_type == 11 %}
                        <div class="knockout-card-bronze match-row" data-opponent="{{ opponent_id }}">
                          <div class="knockout-card-players">
                            <div class="knockout-card-player {% if m.player_2_score > m.player_1_score %}winner{% endif %}">
                              <span><strong>{{ m.player2.name }}</strong></span>
                              <span class="knockout-card-score">{{ m.player_2_score }}</span>
                            </div>
                            <div class="knockout-card-player {% if m.player_1_score > m.player_2_score %}winner{% endif %}">
                              <span><a href="/player/{{ m.player_1_id }}">{{ m.player1.name }}</a></span>
                              <span class="knockout-card-score">{{ m.player_1_score }}</span>
                            </div>
                          </div>
                        </div>
                      {% elif m.m_type == 12 %}
                        <div class="knockout-card-gold match-row" data-opponent="{{ opponent_id }}">
                          <div class="knockout-card-players">
                            <div class="knockout-card-player {% if m.player_2_score > m.player_1_score %}winner{% endif %}">
                              <span><strong>{{ m.player2.name }}</strong></span>
                              <span class="knockout-card-score">{{ m.player_2_score }}</span>
                            </div>
                            <div class="knockout-card-player {% if m.player_1_score > m.player_2_score %}winner{% endif %}">
                              <span><a href="/player/{{ m.player_1_id }}">{{ m.player1.name }}</a></span>
                              <span class="knockout-card-score">{{ m.player_1_score }}</span>
                            </div>
                          </div>
                        </div>
                      {% else %}
                        <!-- å°ç»„èµ›æˆ–å…¶ä»–ç±»å‹æ¯”èµ› -->
                        <div class="match-card match-row" data-opponent="{{ opponent_id }}">
                          <div class="match-header">
                            <span class="match-title">{% if m.m_type == 14 %}é™„åŠ èµ›{% else %}ç¬¬{{ loop.index }}åœº{% endif %}</span>
                          </div>
                          <div class="match-players">
                            <div class="player-info">
                              <span class="player-name"><strong>{{ m.player2.name }}</strong></span>
                              <span class="player-score">{{ m.player_2_score }}</span>
                            </div>
                            <div class="vs-divider">VS</div>
                            <div class="player-info">
                              <span class="player-name"><a href="/player/{{ m.player_1_id }}">{{ m.player1.name }}</a></span>
                              <span class="player-score">{{ m.player_1_score }}</span>
                            </div>
                          </div>
                        </div>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                </div>
              {% else %}
                <p style="color: #666; font-style: italic; margin: 10px 0;">æš‚æ— æ¯”èµ›è®°å½•</p>
              {% endif %}
            </div>
      {% endfor %}
          </div>
        </div>
    {% endfor %}
  {% else %}
      <p>æš‚æ— æ¯”èµ›è®°å½•</p>
  {% endif %}
  </div>

  <script>
    // æ¯”èµ›è®°å½•ç­›é€‰åŠŸèƒ½
    function filterMatchesBySeason() {
      const seasonSelect = document.getElementById('season-select');
      const selectedSeason = seasonSelect.value;
      
      const seasonMatches = document.querySelectorAll('.season-matches');
      seasonMatches.forEach(season => {
        if (!selectedSeason || season.getAttribute('data-season') === selectedSeason) {
          season.style.display = 'block';
          // æ£€æŸ¥è¯¥èµ›å­£æ˜¯å¦æœ‰å¯è§çš„æ¯”èµ›
          checkAndHideEmptyTournaments(season);
        } else {
          season.style.display = 'none';
        }
      });
      
      // æ›´æ–°å±Šæ¬¡é€‰é¡¹
      updateSessionOptions();
    }
    
    function filterMatchesByType() {
      const typeSelect = document.getElementById('tournament-type-select');
      const selectedType = typeSelect.value;
      
      const tournamentMatches = document.querySelectorAll('.tournament-matches');
      tournamentMatches.forEach(tournament => {
        const seasonDiv = tournament.closest('.season-matches');
        if (seasonDiv.style.display === 'none') { // åªå¤„ç†å¯è§èµ›å­£çš„æ¯”èµ›
          tournament.style.display = 'none';
          return;
        }
        
        if (!selectedType || tournament.getAttribute('data-tournament-type') === selectedType) {
          tournament.style.display = 'block';
          // æ£€æŸ¥è¯¥èµ›äº‹æ˜¯å¦æœ‰å¯è§çš„æ¯”èµ›
          checkAndHideEmptyTournament(tournament);
        } else {
          tournament.style.display = 'none';
        }
      });
      
      // æ›´æ–°å±Šæ¬¡é€‰é¡¹
      updateSessionOptions();
    }
    
    function filterMatchesBySession() {
      const sessionSelect = document.getElementById('session-select');
      const selectedSession = sessionSelect.value;
      
      const tournamentMatches = document.querySelectorAll('.tournament-matches');
      tournamentMatches.forEach(tournament => {
        const seasonDiv = tournament.closest('.season-matches');
        if (seasonDiv.style.display === 'none') { // åªå¤„ç†å¯è§èµ›å­£çš„æ¯”èµ›
          tournament.style.display = 'none';
          return;
        }
        
        if (!selectedSession || tournament.getAttribute('data-session') === selectedSession) {
          tournament.style.display = 'block';
          // æ£€æŸ¥è¯¥èµ›äº‹æ˜¯å¦æœ‰å¯è§çš„æ¯”èµ›
          checkAndHideEmptyTournament(tournament);
        } else {
          tournament.style.display = 'none';
        }
      });
    }

    function filterMatchesByOpponent() {
      const opponentSelect = document.getElementById('opponent-select');
      const selectedOpponent = opponentSelect.value;
      
      const matchRows = document.querySelectorAll('.match-row');
      matchRows.forEach(row => {
        const tournamentDiv = row.closest('.tournament-matches');
        const seasonDiv = tournamentDiv.closest('.season-matches');
        
        // åªå¤„ç†å¯è§çš„èµ›å­£å’Œèµ›äº‹ä¸­çš„æ¯”èµ›
        if (seasonDiv.style.display === 'none' || tournamentDiv.style.display === 'none') {
          row.style.display = 'none';
          return;
        }
        
        if (!selectedOpponent || row.getAttribute('data-opponent') === selectedOpponent) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
      
      // æ£€æŸ¥å¹¶éšè—æ²¡æœ‰å¯è§æ¯”èµ›çš„èµ›äº‹
      const tournamentMatches = document.querySelectorAll('.tournament-matches');
      tournamentMatches.forEach(tournament => {
        const visibleMatches = tournament.querySelectorAll('.match-row:not([style*="none"])');
        if (visibleMatches.length === 0) {
          tournament.style.display = 'none';
        } else {
          tournament.style.display = 'block';
        }
      });
      
      // æ£€æŸ¥å¹¶éšè—æ²¡æœ‰å¯è§èµ›äº‹çš„èµ›å­£
      const seasonMatches = document.querySelectorAll('.season-matches');
      seasonMatches.forEach(season => {
        const visibleTournaments = season.querySelectorAll('.tournament-matches:not([style*="none"])');
        if (visibleTournaments.length === 0) {
          season.style.display = 'none';
        } else {
          season.style.display = 'block';
        }
      });
    }
    
    // æ£€æŸ¥å¹¶éšè—ç©ºçš„èµ›äº‹è¡¨æ ¼
    function checkAndHideEmptyTournament(tournament) {
      const visibleMatches = tournament.querySelectorAll('.match-row:not([style*="none"])');
      if (visibleMatches.length === 0) {
        tournament.style.display = 'none';
      }
    }
    
    // æ£€æŸ¥å¹¶éšè—ç©ºçš„èµ›å­£è¡¨æ ¼
    function checkAndHideEmptyTournaments(season) {
      const visibleTournaments = season.querySelectorAll('.tournament-matches:not([style*="none"])');
      if (visibleTournaments.length === 0) {
        season.style.display = 'none';
      }
    }
    
    function updateSessionOptions() {
      const sessionSelect = document.getElementById('session-select');
      const opponentSelect = document.getElementById('opponent-select');
      
      // æ¸…ç©ºç°æœ‰é€‰é¡¹
      sessionSelect.innerHTML = '<option value="">å…¨éƒ¨å±Šæ¬¡</option>';
      opponentSelect.innerHTML = '<option value="">å…¨éƒ¨å¯¹æ‰‹</option>';
      
      // è·å–å½“å‰å¯è§çš„æ¯”èµ›
      const visibleTournaments = document.querySelectorAll('.tournament-matches[style*="block"], .tournament-matches:not([style*="none"])');
      const sessions = new Set();
      const opponents = new Map();
      
      visibleTournaments.forEach(tournament => {
        const session = tournament.getAttribute('data-session');
        if (session) {
          sessions.add(session);
        }
        
        // æ”¶é›†å¯¹æ‰‹ä¿¡æ¯
        const matchRows = tournament.querySelectorAll('.match-row');
        matchRows.forEach(row => {
          const opponentId = row.getAttribute('data-opponent');
          // å¤„ç†æ·˜æ±°èµ›å¡ç‰‡å’Œæ™®é€šæ¯”èµ›å¡ç‰‡çš„ä¸åŒç»“æ„
          let opponentName = '';
          if (row.classList.contains('knockout-card-quarterfinal') || 
              row.classList.contains('knockout-card-qualifier') || 
              row.classList.contains('knockout-card-semifinal') || 
              row.classList.contains('knockout-card-bronze') || 
              row.classList.contains('knockout-card-gold')) {
            // æ·˜æ±°èµ›å¡ç‰‡ç»“æ„
            const playerSpans = row.querySelectorAll('.knockout-card-player span');
            for (let span of playerSpans) {
              if (span.querySelector('a')) {
                opponentName = span.querySelector('a').textContent;
                break;
              }
            }
          } else {
            // æ™®é€šæ¯”èµ›å¡ç‰‡ç»“æ„
            opponentName = row.querySelector('.player-name a')?.textContent || row.querySelector('.player-name')?.textContent;
          }
          if (opponentId && opponentName) {
            opponents.set(opponentId, opponentName.trim());
          }
        });
      });
      
      // æ·»åŠ å±Šæ¬¡é€‰é¡¹
      Array.from(sessions).sort((a, b) => parseInt(a) - parseInt(b)).forEach(session => {
        const option = document.createElement('option');
        option.value = session;
        option.textContent = `ç¬¬${session}å±Š`;
        sessionSelect.appendChild(option);
      });
      
      // æ·»åŠ å¯¹æ‰‹é€‰é¡¹
      Array.from(opponents.entries()).sort((a, b) => a[1].localeCompare(b[1])).forEach(([id, name]) => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = name;
        opponentSelect.appendChild(option);
      });
    }
    
    // è§†å›¾æ¨¡å¼åˆ‡æ¢
    function switchViewMode(mode) {
      const seasonFilter = document.querySelector('.season-filter');
      const h2hToggle = document.querySelector('.h2h-toggle');
      const h2hOpponentSelect = document.getElementById('h2h-opponent-select');
      const h2hStats = document.getElementById('h2h-stats');
      const allOpponents = document.getElementById('all-opponents');
      const seasonMatches = document.querySelectorAll('.season-matches');
      
      if (mode === 'all') {
        // å…¨éƒ¨æ¯”èµ›æ¨¡å¼
        seasonFilter.style.display = 'block';
        h2hOpponentSelect.style.display = 'none';
        h2hStats.style.display = 'none';
        allOpponents.style.display = 'none';
        
        // æ˜¾ç¤ºæ‰€æœ‰èµ›å­£æ¯”èµ›
        seasonMatches.forEach(season => {
          season.style.display = 'block';
        });
        
        // é‡ç½®ç­›é€‰
        document.getElementById('season-select').value = '';
        document.getElementById('tournament-type-select').value = '';
        document.getElementById('session-select').value = '';
        document.getElementById('opponent-select').value = '';
        
        // æ˜¾ç¤ºæ‰€æœ‰æ¯”èµ›
        const matchRows = document.querySelectorAll('.match-row');
        matchRows.forEach(row => {
          row.style.display = '';
        });
        
      } else if (mode === 'h2h') {
        // å¯¹æˆ˜è®°å½•æ¨¡å¼
        seasonFilter.style.display = 'none';
        h2hOpponentSelect.style.display = 'block';
        allOpponents.style.display = 'block';
        
        // éšè—æ‰€æœ‰èµ›å­£æ¯”èµ›
        seasonMatches.forEach(season => {
          season.style.display = 'none';
        });
        
        // åˆå§‹åŒ–å¯¹æ‰‹é€‰æ‹©
        if (h2hOpponentSelect.children.length === 1) {
          initializeH2H();
        }
      }
    }
    
    // å¯¹æˆ˜è®°å½•åŠŸèƒ½
    function initializeH2H() {
      const h2hOpponentSelect = document.getElementById('h2h-opponent-select');
      const opponentsGrid = document.getElementById('opponents-grid');
      
      // æ¸…ç©ºç°æœ‰é€‰é¡¹
      h2hOpponentSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å¯¹æ‰‹</option>';
      opponentsGrid.innerHTML = '';
      
      // æ”¶é›†æ‰€æœ‰å¯¹æ‰‹
      const opponents = new Map();
      const matchRows = document.querySelectorAll('.match-row');
      
      matchRows.forEach(row => {
        const opponentId = row.getAttribute('data-opponent');
        // å¤„ç†æ·˜æ±°èµ›å¡ç‰‡å’Œæ™®é€šæ¯”èµ›å¡ç‰‡çš„ä¸åŒç»“æ„
        let opponentName = '';
        if (row.classList.contains('knockout-card-quarterfinal') || 
            row.classList.contains('knockout-card-qualifier') || 
            row.classList.contains('knockout-card-semifinal') || 
            row.classList.contains('knockout-card-bronze') || 
            row.classList.contains('knockout-card-gold')) {
          // æ·˜æ±°èµ›å¡ç‰‡ç»“æ„
          const playerSpans = row.querySelectorAll('.knockout-card-player span');
          for (let span of playerSpans) {
            if (span.querySelector('a')) {
              opponentName = span.querySelector('a').textContent;
              break;
            }
          }
        } else {
          // æ™®é€šæ¯”èµ›å¡ç‰‡ç»“æ„
          opponentName = row.querySelector('.player-name a')?.textContent || row.querySelector('.player-name')?.textContent;
        }
        if (opponentId && opponentName) {
          opponents.set(opponentId, opponentName.trim());
        }
      });
      
      // å¡«å……å¯¹æ‰‹é€‰æ‹©å™¨
      Array.from(opponents.entries()).sort((a, b) => a[1].localeCompare(b[1])).forEach(([id, name]) => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = name;
        h2hOpponentSelect.appendChild(option);
      });
      
      // ç”Ÿæˆå¯¹æ‰‹ç½‘æ ¼
      Array.from(opponents.entries()).forEach(([id, name]) => {
        const stats = calculateH2HStats(id);
        const card = document.createElement('div');
        card.className = 'opponent-card';
        card.setAttribute('data-opponent-id', id);
        card.style.cssText = 'padding: 10px; border: 1px solid #ddd; border-radius: 5px; text-align: center; cursor: pointer; background-color: white; transition: all 0.3s ease;';
        card.onclick = () => {
          console.log('ç‚¹å‡»äº†å¯¹æ‰‹å¡ç‰‡:', name, 'ID:', id);
          
          // é‡ç½®æ‰€æœ‰å¡ç‰‡
          document.querySelectorAll('.opponent-card').forEach(c => {
            c.style.backgroundColor = 'white';
            c.style.borderColor = '#ddd';
            c.style.transform = 'none';
            // é‡ç½®å¡ç‰‡å†…å®¹ä¸ºåŸå§‹ç»Ÿè®¡
            const originalStats = calculateH2HStats(c.getAttribute('data-opponent-id'));
            const statsDiv = c.querySelector('div:last-child');
            if (statsDiv) {
              statsDiv.innerHTML = `${originalStats.wins}èƒœ ${originalStats.draws}å¹³ ${originalStats.losses}è´Ÿ`;
            }
          });
          
          // é«˜äº®å½“å‰å¡ç‰‡å¹¶æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡
          card.style.backgroundColor = '#e3f2fd';
          card.style.borderColor = '#2196f3';
          card.style.transform = 'scale(1.05)';
          
          // æ›´æ–°å¡ç‰‡å†…å®¹æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡
          const stats = calculateH2HStats(id);
          const statsDiv = card.querySelector('div:last-child');
          if (statsDiv) {
            statsDiv.innerHTML = `
              <div style="font-size: 14px; font-weight: bold; color: #2196f3; margin-bottom: 2px;">
                ${stats.wins}èƒœ ${stats.draws}å¹³ ${stats.losses}è´Ÿ
              </div>
              <div style="font-size: 11px; color: #666;">
                æ€»è®¡: ${stats.wins + stats.draws + stats.losses}åœº
              </div>
            `;
          }
          
          // éšè—ä¸Šæ–¹çš„div
          const seasonFilter = document.querySelector('.season-filter');
          const h2hToggle = document.querySelector('.h2h-toggle');
          if (seasonFilter) seasonFilter.style.display = 'none';
          if (h2hToggle) h2hToggle.style.display = 'none';
          
          // æ˜¾ç¤ºé‡ç½®æŒ‰é’®
          const resetBtn = document.getElementById('reset-view-btn');
          if (resetBtn) resetBtn.style.display = 'block';
          
          // ç›´æ¥æ˜¾ç¤ºå¯¹æˆ˜ä¿¡æ¯ï¼ˆä¸æ˜¾ç¤ºh2h-statsï¼‰
          console.log('è°ƒç”¨showH2HRecordDirectly');
          showH2HRecordDirectly(id, name);
        };
        
        card.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 5px;">${name}</div>
          <div style="font-size: 12px; color: #666;">
            ${stats.wins}èƒœ ${stats.draws}å¹³ ${stats.losses}è´Ÿ
          </div>
        `;
        
        opponentsGrid.appendChild(card);
      });
    }
    
    function calculateH2HStats(opponentId) {
      const matchRows = document.querySelectorAll(`.match-row[data-opponent="${opponentId}"]`);
      let wins = 0, draws = 0, losses = 0;
      
      matchRows.forEach(row => {
        let score1 = 0, score2 = 0;
        
        // å¤„ç†æ·˜æ±°èµ›å¡ç‰‡å’Œæ™®é€šæ¯”èµ›å¡ç‰‡çš„ä¸åŒç»“æ„
        if (row.classList.contains('knockout-card-quarterfinal') || 
            row.classList.contains('knockout-card-qualifier') || 
            row.classList.contains('knockout-card-semifinal') || 
            row.classList.contains('knockout-card-bronze') || 
            row.classList.contains('knockout-card-gold')) {
          // æ·˜æ±°èµ›å¡ç‰‡ç»“æ„
          const scores = row.querySelectorAll('.knockout-card-score');
          if (scores.length >= 2) {
            score1 = parseInt(scores[0].textContent) || 0;
            score2 = parseInt(scores[1].textContent) || 0;
          }
        } else {
          // æ™®é€šæ¯”èµ›å¡ç‰‡ç»“æ„
          const scores = row.querySelectorAll('.player-score');
          if (scores.length >= 2) {
            score1 = parseInt(scores[0].textContent) || 0;
            score2 = parseInt(scores[1].textContent) || 0;
          }
        }
        
        if (score1 > score2) {
          wins++;
        } else if (score1 < score2) {
          losses++;
        } else {
          draws++;
        }
      });
      
      return { wins, draws, losses };
    }
    
    function showH2HRecordDirectly(opponentId, opponentName) {
      console.log('showH2HRecordDirectly è¢«è°ƒç”¨:', opponentId, opponentName);
      const seasonMatches = document.querySelectorAll('.season-matches');
      console.log('æ‰¾åˆ°çš„èµ›å­£æ•°é‡:', seasonMatches.length);
      
      // æ˜¾ç¤ºåŒ…å«è¯¥å¯¹æ‰‹çš„èµ›å­£æ¯”èµ›
      seasonMatches.forEach(season => {
        const hasOpponentMatches = season.querySelector(`.match-row[data-opponent="${opponentId}"]`);
        console.log('èµ›å­£æ˜¯å¦æœ‰å¯¹æ‰‹æ¯”èµ›:', !!hasOpponentMatches);
        
        if (hasOpponentMatches) {
          season.style.display = 'block';
          
          // åªæ˜¾ç¤ºä¸è¯¥å¯¹æ‰‹çš„æ¯”èµ›
          const allMatchRows = season.querySelectorAll('.match-row');
          allMatchRows.forEach(row => {
            if (row.getAttribute('data-opponent') === opponentId) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          });
          
          // æ£€æŸ¥å¹¶éšè—æ²¡æœ‰å¯è§æ¯”èµ›çš„èµ›äº‹è¡¨æ ¼
          const tournamentMatches = season.querySelectorAll('.tournament-matches');
          tournamentMatches.forEach(tournament => {
            const visibleMatches = tournament.querySelectorAll('.match-row:not([style*="none"])');
            if (visibleMatches.length === 0) {
              tournament.style.display = 'none';
            } else {
              tournament.style.display = 'block';
            }
          });
        } else {
          // å¦‚æœè¯¥èµ›å­£æ²¡æœ‰ä¸è¯¥å¯¹æ‰‹çš„æ¯”èµ›ï¼Œéšè—æ•´ä¸ªèµ›å­£
          season.style.display = 'none';
        }
      });
    }

    function showH2HRecord() {
      const opponentSelect = document.getElementById('h2h-opponent-select');
      const opponentId = opponentSelect.value;
      const h2hStats = document.getElementById('h2h-stats');
      const h2hTitle = document.getElementById('h2h-title');
      const h2hWins = document.getElementById('h2h-wins');
      const h2hDraws = document.getElementById('h2h-draws');
      const h2hLosses = document.getElementById('h2h-losses');
      const h2hTotal = document.getElementById('h2h-total');
      const seasonMatches = document.querySelectorAll('.season-matches');
      
      if (!opponentId) {
        h2hStats.style.display = 'none';
        // éšè—æ‰€æœ‰èµ›å­£æ¯”èµ›
        seasonMatches.forEach(season => {
          season.style.display = 'none';
        });
        return;
      }
      
      const stats = calculateH2HStats(opponentId);
      const opponentName = opponentSelect.options[opponentSelect.selectedIndex].text;
      
      // æ›´æ–°ç»Ÿè®¡
      h2hTitle.textContent = `ä¸ ${opponentName} çš„å¯¹æˆ˜ç»Ÿè®¡`;
      h2hWins.textContent = stats.wins;
      h2hDraws.textContent = stats.draws;
      h2hLosses.textContent = stats.losses;
      h2hTotal.textContent = `æ€»è®¡: ${stats.wins + stats.draws + stats.losses}åœº`;
      
      // æ˜¾ç¤ºå¯¹æˆ˜ç»Ÿè®¡
      h2hStats.style.display = 'block';
      
      // æ˜¾ç¤ºåŒ…å«è¯¥å¯¹æ‰‹çš„èµ›å­£æ¯”èµ›
      seasonMatches.forEach(season => {
        const hasOpponentMatches = season.querySelector(`.match-row[data-opponent="${opponentId}"]`);
        if (hasOpponentMatches) {
          season.style.display = 'block';
          
          // åªæ˜¾ç¤ºä¸è¯¥å¯¹æ‰‹çš„æ¯”èµ›
          const allMatchRows = season.querySelectorAll('.match-row');
          allMatchRows.forEach(row => {
            if (row.getAttribute('data-opponent') === opponentId) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          });
          
          // æ£€æŸ¥å¹¶éšè—æ²¡æœ‰å¯è§æ¯”èµ›çš„èµ›äº‹è¡¨æ ¼
          const tournamentMatches = season.querySelectorAll('.tournament-matches');
          tournamentMatches.forEach(tournament => {
            const visibleMatches = tournament.querySelectorAll('.match-row:not([style*="none"])');
            if (visibleMatches.length === 0) {
              tournament.style.display = 'none';
            } else {
              tournament.style.display = 'block';
            }
          });
    } else {
          season.style.display = 'none';
        }
      });
    }
    
    // é‡ç½®è§†å›¾åˆ°åŸå§‹çŠ¶æ€
    function resetView() {
      // é‡ç½®å¯¹æ‰‹å¡ç‰‡æ ·å¼å’Œå†…å®¹
      document.querySelectorAll('.opponent-card').forEach(c => {
        c.style.backgroundColor = 'white';
        c.style.borderColor = '#ddd';
        c.style.transform = 'none';
        
        // é‡ç½®å¡ç‰‡å†…å®¹ä¸ºåŸå§‹ç»Ÿè®¡
        const originalStats = calculateH2HStats(c.getAttribute('data-opponent-id'));
        const statsDiv = c.querySelector('div:last-child');
        if (statsDiv) {
          statsDiv.innerHTML = `${originalStats.wins}èƒœ ${originalStats.draws}å¹³ ${originalStats.losses}è´Ÿ`;
        }
      });
      
      // éšè—é‡ç½®æŒ‰é’®
      const resetBtn = document.getElementById('reset-view-btn');
      if (resetBtn) resetBtn.style.display = 'none';
      
      // æ˜¾ç¤ºä¸Šæ–¹çš„div
      const seasonFilter = document.querySelector('.season-filter');
      const h2hToggle = document.querySelector('.h2h-toggle');
      if (seasonFilter) seasonFilter.style.display = 'block';
      if (h2hToggle) h2hToggle.style.display = 'block';
      
      // éšè—å¯¹æˆ˜ç»Ÿè®¡
      const h2hStats = document.getElementById('h2h-stats');
      if (h2hStats) h2hStats.style.display = 'none';
      
      // é‡ç½®å¯¹æ‰‹é€‰æ‹©å™¨
      const h2hOpponentSelect = document.getElementById('h2h-opponent-select');
      if (h2hOpponentSelect) h2hOpponentSelect.value = '';
      
      // æ˜¾ç¤ºæ‰€æœ‰èµ›å­£å’Œæ¯”èµ›
      const seasonMatches = document.querySelectorAll('.season-matches');
      seasonMatches.forEach(season => {
        season.style.display = 'block';
        
        const tournamentMatches = season.querySelectorAll('.tournament-matches');
        tournamentMatches.forEach(tournament => {
          tournament.style.display = 'block';
        });
        
        const matchRows = season.querySelectorAll('.match-row');
        matchRows.forEach(row => {
          row.style.display = '';
        });
      });
    }
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      updateSessionOptions();
      initializeH2H();
      
      // åˆå§‹åŠ è½½æ—¶éšè—ç©ºçš„è¡¨æ ¼
      const tournamentMatches = document.querySelectorAll('.tournament-matches');
      tournamentMatches.forEach(tournament => {
        const visibleMatches = tournament.querySelectorAll('.match-row:not([style*="none"])');
        if (visibleMatches.length === 0) {
          tournament.style.display = 'none';
        }
      });
      
      const seasonMatches = document.querySelectorAll('.season-matches');
      seasonMatches.forEach(season => {
        const visibleTournaments = season.querySelectorAll('.tournament-matches:not([style*="none"])');
        if (visibleTournaments.length === 0) {
          season.style.display = 'none';
        }
      });
      
      // æ¢å¤åˆ†é¡µçŠ¶æ€ï¼ˆå¦‚æœæœ‰ï¼‰
      restorePageState();
    });
    
    // æ¢å¤åˆ†é¡µçŠ¶æ€
    function restorePageState() {
      const savedTab = localStorage.getItem('playerPageTab');
      if (savedTab) {
        showPage(savedTab);
        // æ¸…é™¤ä¿å­˜çš„çŠ¶æ€
        localStorage.removeItem('playerPageTab');
      }
    }
  </script>
{% endblock %}
