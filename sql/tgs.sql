BEGIN TRANSACTION;
DROP TABLE IF EXISTS "rankings";
CREATE TABLE "rankings" (
	"r_id"	INTEGER,
	"t_id"	INTEGER NOT NULL,
	"player_id"	INTEGER NOT NULL,
	"ranks"	INTEGER NOT NULL,
	"scores"	INTEGER,
	PRIMARY KEY("r_id" AUTOINCREMENT),
	FOREIGN KEY("player_id") REFERENCES "players"("player_id"),
	FOREIGN KEY("t_id") REFERENCES "tournament"("t_id")
);
DROP TABLE IF EXISTS "signups";
CREATE TABLE "signups" (
	"s_id"	INTEGER,
	"u_id"	INTEGER,
	"t_id"	INTEGER,
	PRIMARY KEY("s_id" AUTOINCREMENT),
	FOREIGN KEY("t_id") REFERENCES "tournament"("t_id"),
	FOREIGN KEY("u_id") REFERENCES "users"("uid")
);
DROP TABLE IF EXISTS "tg_players";
CREATE TABLE "tg_players" (
	"tgp_id"	INTEGER,
	"player_id"	INTEGER,
	"tg_id"	INTEGER,
	PRIMARY KEY("tgp_id" AUTOINCREMENT),
	FOREIGN KEY("player_id") REFERENCES "players"("player_id"),
	FOREIGN KEY("tg_id") REFERENCES "tgroups"("tg_id")
);
DROP TABLE IF EXISTS "tgroups";
CREATE TABLE "tgroups" (
	"tg_id"	INTEGER,
	"t_id"	INTEGER,
	"t_name"	TEXT NOT NULL,
	PRIMARY KEY("tg_id" AUTOINCREMENT),
	FOREIGN KEY("t_id") REFERENCES "tournament"("t_id")
);
INSERT INTO "rankings" ("r_id","t_id","player_id","ranks","scores") VALUES (35,7,7,1,330),
 (36,7,5,2,233),
 (37,7,18,3,164),
 (38,7,2,4,116),
 (39,7,3,5,81),
 (40,7,9,6,57),
 (41,7,1,7,40),
 (42,7,11,8,29),
 (43,7,8,9,20),
 (44,7,27,10,14),
 (45,7,4,11,10),
 (46,10,9,1,270),
 (47,10,12,2,179),
 (48,10,15,3,118),
 (49,10,3,4,78),
 (50,10,1,5,52),
 (51,10,5,6,34),
 (52,10,8,7,23),
 (53,10,7,8,15),
 (54,10,6,9,10),
 (56,15,12,1,0),
 (57,15,13,2,0),
 (58,15,9,3,0),
 (59,15,7,4,0),
 (60,15,15,5,0),
 (61,15,28,6,0),
 (102,4,1,1,0),
 (103,4,9,2,0),
 (104,4,35,3,0),
 (105,4,11,4,0),
 (106,4,16,5,0),
 (107,3,11,1,0),
 (108,3,1,2,0),
 (109,3,35,3,0),
 (110,3,21,4,0),
 (111,3,9,5,0),
 (112,3,16,6,0),
 (113,3,32,7,0),
 (114,3,22,8,0),
 (129,1,11,1,0),
 (130,1,12,2,0),
 (131,1,7,3,0),
 (132,1,15,4,0),
 (133,1,9,5,0),
 (134,1,8,6,0),
 (135,1,30,7,0),
 (136,2,35,1,0),
 (137,2,11,2,0),
 (138,2,19,3,0),
 (139,2,10,4,0),
 (140,2,9,5,0),
 (141,2,16,6,0),
 (388,17,7,1,120),
 (389,17,12,2,73),
 (390,17,17,3,44),
 (391,17,8,4,27),
 (392,17,15,5,16),
 (393,17,29,6,10),
 (430,5,4,1,360),
 (431,5,2,2,260),
 (432,5,1,3,188),
 (433,5,5,4,135),
 (434,5,9,5,98),
 (435,5,8,6,71),
 (436,5,4,7,51),
 (437,5,3,8,37),
 (438,5,18,9,27),
 (439,5,37,10,19),
 (440,5,27,11,14),
 (441,5,41,12,10);
INSERT INTO "tg_players" ("tgp_id","player_id","tg_id") VALUES (1,4,1),
 (2,5,1),
 (3,8,1),
 (4,41,1),
 (5,1,2),
 (6,9,2),
 (7,18,2),
 (8,37,2),
 (9,2,3),
 (10,3,3),
 (11,16,3),
 (12,27,3),
 (13,35,4),
 (14,36,4),
 (15,31,4),
 (16,11,4),
 (17,9,5),
 (18,1,5),
 (19,7,5),
 (20,14,5),
 (21,4,6),
 (22,10,6),
 (23,16,6),
 (24,21,6),
 (25,1,7),
 (26,15,7),
 (27,8,7),
 (28,5,7),
 (29,4,8),
 (30,7,8),
 (31,18,8),
 (32,6,8),
 (33,3,9),
 (34,9,9),
 (35,12,9),
 (36,2,9),
 (47,1,12),
 (48,4,12),
 (49,9,12),
 (50,7,12),
 (51,12,12),
 (52,5,13),
 (53,3,13),
 (54,11,13),
 (55,21,13),
 (56,8,13),
 (57,1,14),
 (58,13,14),
 (59,5,14),
 (60,9,14),
 (61,25,14),
 (62,2,15),
 (63,28,15),
 (64,12,15),
 (65,6,15),
 (66,21,15),
 (67,3,16),
 (68,7,16),
 (69,8,16),
 (70,17,16),
 (71,15,16),
 (72,3,17),
 (73,5,17),
 (74,4,17),
 (75,23,17),
 (76,13,17),
 (77,7,17),
 (78,8,17),
 (79,1,18),
 (80,12,18),
 (81,15,18),
 (82,17,18),
 (83,2,18),
 (84,26,18),
 (85,6,18),
 (86,3,19),
 (87,13,19),
 (88,15,19),
 (89,17,19),
 (90,25,19),
 (91,8,19),
 (92,1,20),
 (93,12,20),
 (94,6,20),
 (95,7,20),
 (96,5,20),
 (97,29,20),
 (110,1,24),
 (111,8,24),
 (112,5,24),
 (113,34,24),
 (114,4,25),
 (115,9,25),
 (116,13,25),
 (117,10,25),
 (118,2,26),
 (119,12,26),
 (120,7,26),
 (121,6,26),
 (122,3,27),
 (123,15,27),
 (124,33,27),
 (125,16,27),
 (126,2,30),
 (127,4,30),
 (128,5,30),
 (129,6,30),
 (130,3,31),
 (131,1,31),
 (132,9,31),
 (133,10,31);
INSERT INTO "tgroups" ("tg_id","t_id","t_name") VALUES (1,5,'A'),
 (2,5,'B'),
 (3,5,'C'),
 (4,19,'A'),
 (5,19,'B'),
 (6,19,'C'),
 (7,9,'A'),
 (8,9,'B'),
 (9,9,'C'),
 (12,8,'A'),
 (13,8,'B'),
 (14,11,'A'),
 (15,11,'B'),
 (16,11,'C'),
 (17,12,'A'),
 (18,12,'B'),
 (19,13,'A'),
 (20,13,'B'),
 (24,14,'A'),
 (25,14,'B'),
 (26,14,'C'),
 (27,14,'D'),
 (30,20,'A'),
 (31,20,'B');
DROP VIEW IF EXISTS "MatchResults";
CREATE VIEW MatchResults AS
SELECT
    m_id,
    t_id,
    player_1_id,
    player_2_id,
    player_1_score,
    player_2_score,
    CASE 
        WHEN player_1_score > player_2_score THEN player_1_id
        WHEN player_2_score > player_1_score THEN player_2_id
        ELSE NULL  -- 平局
    END AS winner_id,
    CASE 
        WHEN player_1_score < player_2_score THEN player_1_id
        WHEN player_2_score < player_1_score THEN player_2_id
        ELSE NULL  -- 平局
    END AS loser_id,
    CASE 
        WHEN player_1_score = player_2_score THEN 1 ELSE 0
    END AS is_draw
FROM Matches;
DROP VIEW IF EXISTS "tournament_session_view";
CREATE VIEW tournament_session_view AS
SELECT 
    t.t_id,
    t.season_id,
    s.year,
    t.type,
    ROW_NUMBER() OVER (PARTITION BY t.season_id, t.type ORDER BY t.t_id) as type_session_number
FROM tournament t
JOIN seasons s ON t.season_id = s.season_id;
COMMIT;
